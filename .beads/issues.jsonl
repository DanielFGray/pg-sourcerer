{"id":"pg-sourcerer-01h","title":"Implement RLS-driven field variant generation","description":"Use IR field permissions to determine which Model variants include each field.\n\nMapping:\n- canSelect: true → include in select, json\n- canInsert: true → include in insert, jsonCreate  \n- canUpdate: true → include in update, jsonUpdate\n\nUse Model.Field({...}) to specify per-variant schemas based on permissions.\n\nEdge cases:\n- Field with no permissions → skip entirely\n- Entity with !canSelect → still generate if canInsert (write-only entity)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T22:12:18.24983469-06:00","updated_at":"2026-01-06T22:35:02.039226524-06:00","closed_at":"2026-01-06T22:35:02.039226524-06:00","close_reason":"Implemented Model.FieldExcept for RLS-driven variant exclusion. Fields without insert/update permissions are excluded from those variants using Model.FieldExcept.","labels":["effect-model","rls"]}
{"id":"pg-sourcerer-0kkz","title":"Add composite type generation to zod.ts","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:15:13.934341906-06:00","created_by":"dan","updated_at":"2026-01-08T15:17:00.654953097-06:00","closed_at":"2026-01-08T15:17:00.654953097-06:00","close_reason":"Implemented composite generation in zod.ts with tests","dependencies":[{"issue_id":"pg-sourcerer-0kkz","depends_on_id":"pg-sourcerer-ki23","type":"parent-child","created_at":"2026-01-08T15:15:22.164081189-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-0m3","title":"Commit effect-model plugin","description":"Once tests pass and output is clean, commit the effect-model plugin files","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T22:46:16.555145304-06:00","updated_at":"2026-01-06T22:56:53.933178736-06:00","closed_at":"2026-01-06T22:56:53.933178736-06:00","close_reason":"Committed in 82177c9","labels":["effect-model","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-0m3","depends_on_id":"pg-sourcerer-j3f","type":"blocks","created_at":"2026-01-06T22:46:20.137320796-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-0ot","title":"Add CHANGELOG.md","description":"Create a CHANGELOG.md following Keep a Changelog format. Start with version 0.1.0 documenting initial features:\n- Plugin system with capability resolution\n- TypeScript types plugin\n- Zod schemas plugin  \n- Effect Model plugin\n- Smart tags support\n- CLI with generate command","notes":"Replaced with release-please automation - generates CHANGELOG.md automatically from conventional commits","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T10:55:44.492026914-06:00","updated_at":"2026-01-07T11:13:56.267516367-06:00","closed_at":"2026-01-07T11:13:56.267516367-06:00","close_reason":"Set up release-please: workflow creates release PRs from conventional commits, auto-generates CHANGELOG.md, triggers npm publish on merge. Replaced manual release.yml.","labels":["docs","p1","publish"],"dependencies":[{"issue_id":"pg-sourcerer-0ot","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:11.522621729-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-0t2","title":"Kysely Plugin Suite","description":"Implement Kysely-specific code generation plugins.\n\nPlugins:\n1. Kysely Types Plugin - Generate Kysely-compatible type definitions (Generated\u003cT\u003e, Selectable, Insertable, Updateable)\n2. Kysely Queries Plugin - Generate type-safe query builders\n\nThese plugins enable type-safe database access via Kysely ORM.","status":"open","priority":4,"issue_type":"epic","created_at":"2026-01-06T14:42:56.796172635-06:00","updated_at":"2026-01-07T16:42:03.053534223-06:00","labels":["rewrite"]}
{"id":"pg-sourcerer-0tn","title":"Refactor types plugin to use Conjure DSL","description":"Replace raw recast builder calls with conjure DSL in the types plugin. Should simplify code and remove need for local cast helpers.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T15:32:38.57762583-06:00","updated_at":"2026-01-06T15:34:57.850266692-06:00","closed_at":"2026-01-06T15:34:57.850266692-06:00","close_reason":"Refactored types.ts to use conjure DSL. Removed local cast helpers, now uses conjure.ts.* for type nodes, conjure.print/program for output. All 355 tests pass.","labels":["conjure","rewrite"]}
{"id":"pg-sourcerer-0un","title":"Fix packages/lib/prompt.ts and packages/example/scripts lint errors","description":"ESLint errors in example scripts (dbEnsure.ts, dbSetup.ts, generateEnvFile.ts) and lib/prompt.ts. These are copied from another Effect project and need cleanup. Issues include: recursive confirm() bug, missing Bun global types, npm-run-all missing types, various unsafe access patterns.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T10:58:42.216483865-06:00","updated_at":"2026-01-07T10:44:37.768830059-06:00","closed_at":"2026-01-07T10:44:37.768830059-06:00","close_reason":"Fixed lint error in config-loader.ts (S.Any assignment)","labels":["example"]}
{"id":"pg-sourcerer-102","title":"sql-queries: Fix field types using field.name instead of actual TS type","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-07T16:11:20.519809481-06:00","updated_at":"2026-01-07T20:27:30.395037898-06:00","closed_at":"2026-01-07T20:27:30.395037898-06:00","close_reason":"Already implemented: Test 'uses correct TypeScript types for parameters' verifies id: string not id: id"}
{"id":"pg-sourcerer-187","title":"Create definePlugin helper for simple plugins","description":"Create `definePlugin` helper for writing simple plugins without Effect knowledge.\n\n```typescript\ninterface SimplePluginContext {\n  readonly ir: SemanticIR\n  readonly inflection: CoreInflection\n  readonly symbols: SymbolRegistry\n  readonly typeHints: TypeHintRegistry\n  readonly emit: (path: string, content: string) =\u003e void\n  readonly appendEmit: (path: string, content: string) =\u003e void\n  readonly getArtifact: (cap: CapabilityKey) =\u003e Artifact | undefined\n  readonly setArtifact: (cap: CapabilityKey, data: unknown) =\u003e void\n  readonly log: { debug, info, warn }\n}\n\ninterface SimplePluginDef\u003cTConfig\u003e {\n  name: string\n  requires?: CapabilityKey[]\n  provides: CapabilityKey[]\n  configSchema: S.Schema\u003cTConfig\u003e\n  inflection: PluginInflection\n  run: (ctx: SimplePluginContext, config: TConfig) =\u003e void | Promise\u003cvoid\u003e\n}\n\nfunction definePlugin\u003cTConfig\u003e(def: SimplePluginDef\u003cTConfig\u003e): Plugin\u003cTConfig\u003e\n```\n\nThe helper:\n1. Yields all services from context\n2. Constructs the SimplePluginContext object\n3. Calls the user's run function\n4. Wraps sync/async in Effect.tryPromise or Effect.sync\n5. Catches errors and wraps in PluginExecutionFailed","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T11:28:13.519563144-06:00","updated_at":"2026-01-06T11:40:08.13409562-06:00","closed_at":"2026-01-06T11:40:08.13409562-06:00","close_reason":"Created definePlugin helper in src/services/plugin.ts. Provides simple API for plugin authors: `run: (ctx, config) =\u003e void | Promise\u003cvoid\u003e`. The helper yields all services from Effect context, builds a SimplePluginContext object, and handles sync/async execution with proper error wrapping.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-187","depends_on_id":"pg-sourcerer-dpp","type":"blocks","created_at":"2026-01-06T11:28:16.513026514-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-1fd","title":"sql-queries: Add trigram search function generation","description":"Generate search functions for GIN trigram indexes:\n- searchUsersByUsername(pattern) for ILIKE/similarity queries\n- Proper parameterization to prevent injection\n- Configurable limit defaults\n\nDepends on QueryKind discriminator being in place.","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-07T16:30:46.197131333-06:00","updated_at":"2026-01-07T19:59:21.448502869-06:00","dependencies":[{"issue_id":"pg-sourcerer-1fd","depends_on_id":"pg-sourcerer-ues","type":"blocks","created_at":"2026-01-07T16:30:50.130560281-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-1n1","title":"Add Unit Tests for Emissions Buffer","description":"EmissionBuffer has no dedicated tests. Should test:\n\n- `emit()` - basic file emission\n- `emit()` - same file, same plugin (overwrites)\n- `emit()` - same file, different plugin (conflict on validate)\n- `appendEmit()` - appends to existing\n- `appendEmit()` - different plugin tries to append (error)\n- `validate()` - returns clean for no conflicts\n- `validate()` - fails with EmitConflict for conflicts\n- `clear()` - empties the buffer\n- `getAll()` - returns all entries","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T21:45:59.773722614-06:00","updated_at":"2026-01-06T12:02:25.674672702-06:00","closed_at":"2026-01-06T12:02:25.674672702-06:00","close_reason":"42 inflection tests + 16 emissions tests added, all passing","labels":["core","rewrite","testing"]}
{"id":"pg-sourcerer-1tr","title":"config-loader: Refactor null check to use Option pattern","description":"Refactor config-loader null check to use `Option.fromNullable` and `Option.filter` pattern.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T16:52:13.352450142-06:00","updated_at":"2026-01-07T18:42:36.469150652-06:00","closed_at":"2026-01-07T18:42:36.469150652-06:00","close_reason":"Superseded by pg-sourcerer-ug3 - larger Option\u003cT\u003e refactor"}
{"id":"pg-sourcerer-22u9","title":"Add composite type generation to effect-model.ts","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:15:17.918500521-06:00","created_by":"dan","updated_at":"2026-01-08T15:20:40.28754391-06:00","closed_at":"2026-01-08T15:20:40.28754391-06:00","close_reason":"Implemented composite generation in effect-model.ts with tests using S.Struct","dependencies":[{"issue_id":"pg-sourcerer-22u9","depends_on_id":"pg-sourcerer-ki23","type":"parent-child","created_at":"2026-01-08T15:15:22.387119244-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-2bc","title":"Refactor introspection as a phase-0 plugin for database agnosticism","description":"Major architectural refactor to decouple from pg-introspection and enable support for multiple databases and data sources.\n\n## Problem\nCurrent design has tight coupling between core and pg-introspection:\n- IR types hold raw pg-introspection objects (Field.pgAttribute, Entity.pgClass, etc.)\n- IR builder deeply uses pg-introspection APIs\n- Inflection service accepts raw pg types as parameters\n- Plugins can reach through IR to call pg-introspection methods (leaky abstraction)\n\n## Proposed Solution\nMake introspection a plugin that runs in a phase before code generation plugins:\n\n```\nPhase 0: [Introspection Plugins] → Normalized Schema Data\nPhase 1: [IR Building] → SemanticIR  \nPhase 2: [Code Generation Plugins] → Files\n```\n\n## Benefits\n- True database agnosticism (MySQL, SQLite, MSSQL, etc.)\n- Support for schema-as-code sources (Prisma files, Drizzle definitions)\n- Potential for multi-source composition\n- Cleaner abstraction - plugins can't leak through to source-specific types\n\n## Key Changes Required\n1. Define normalized intermediate schema format (not pg-specific)\n2. Create IntrospectionAdapter interface\n3. Migrate IR types to not reference pg-introspection directly\n4. Update IR builder to consume normalized format\n5. Update inflection service signatures\n6. Migrate existing plugins away from raw pg-introspection access\n\n## Open Questions\n- What data sources to support? (SQL DBs, schema files, non-SQL?)\n- Multiple simultaneous sources?\n- Breaking change tolerance for existing plugins?\n- What pg-specific info do plugins actually need?\n\n## References\n- See ARCHITECTURE.md for current design\n- Exploration notes in conversation history","status":"open","priority":4,"issue_type":"feature","created_at":"2026-01-08T10:39:17.906630391-06:00","updated_at":"2026-01-08T10:39:17.906630391-06:00","labels":["architecture","future","refactor"]}
{"id":"pg-sourcerer-2bwz","title":"Create release script using Effect","description":"Create a release script at `scripts/release.ts` using Effect.\n\n## Purpose\nAutomate version bumping and releasing to main branch. Run with:\n```bash\nbun scripts/release.ts [patch|minor|major]\n```\n\n## Implementation\n\nUse `@effect/cli` for CLI parsing and `@effect/platform` Command for shell execution.\n\n### Key imports:\n```typescript\nimport { Command as Cmd, Args } from \"@effect/cli\"\nimport { Command } from \"@effect/platform\"  // for shell execution\nimport { NodeContext, NodeRuntime } from \"@effect/platform-node\"\nimport { Effect, Console } from \"effect\"\n```\n\n### Steps:\n1. Parse CLI arg for bump type (default: patch)\n2. Run `npm version \u003cpatch|minor|major\u003e --no-git-tag-version` in packages/pg-sourcerer\n3. Get new version via `npm pkg get version`\n4. Git add + commit with message `chore: release vX.Y.Z`\n5. Checkout main\n6. Merge develop with `--ff-only` (fast-forward, keeps linear history)\n7. Push main to origin\n8. Checkout back to develop\n9. Log success message\n\n### Command execution pattern:\n```typescript\nimport { Command } from \"@effect/platform\"\n\nconst exec = (cmd: string, cwd?: string) =\u003e\n  Command.make(cmd.split(\" \")[0], ...cmd.split(\" \").slice(1)).pipe(\n    cwd ? Command.workingDirectory(cwd) : identity,\n    Command.string,  // captures stdout as string\n  )\n```\n\n### Error handling:\n- Fail if working directory is dirty (uncommitted changes)\n- Fail if not on develop branch\n- Fail if merge to main fails (not fast-forwardable)\n\n### Questions resolved:\n- Use `--ff-only` for linear history (no merge commits)\n- Push automatically after merge\n- Return to develop branch after release","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-08T13:50:18.81313626-06:00","created_by":"dan","updated_at":"2026-01-08T17:17:06.453853896-06:00"}
{"id":"pg-sourcerer-2lv","title":"sql-queries: Add full-text search function generation","description":"Generate search functions for tsvector GIST/GIN indexes:\n- searchPosts(query) using plainto_tsquery or websearch_to_tsquery\n- Support for ranking results\n- Configurable limit defaults\n\nDepends on QueryKind discriminator being in place.","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-07T16:30:46.197214417-06:00","updated_at":"2026-01-07T19:59:21.43064794-06:00","dependencies":[{"issue_id":"pg-sourcerer-2lv","depends_on_id":"pg-sourcerer-ues","type":"blocks","created_at":"2026-01-07T16:30:50.161555741-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-2nj","title":"Config Loader Service","description":"Load and validate pgsourcerer.config.ts:\n\n- Config file discovery (CLI flag, then pgsourcerer.config.{ts,js,mjs})\n- Parse with Effect Schema\n- Validate plugin configs individually\n- Resolve environment variables\n\nResearch needed: Effect.Config vs lilconfig vs Bun native import.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:25.921417722-06:00","updated_at":"2026-01-05T21:40:26.237083116-06:00","closed_at":"2026-01-05T21:40:26.237083116-06:00","close_reason":"Config Loader Service complete: lilconfig integration with Effect wrapper, Schema validation, proper error handling. Also created introspection fixture from example database for future testing.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-2nj","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:25.922938443-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-2pv","title":"Call emissions.validate() After Plugin Execution","description":"`EmissionBuffer.validate()` exists to detect conflicts (same file emitted by different plugins), but nothing ever calls it:\n\n```typescript\n// emissions.ts - validate() defined\nreadonly validate: () =\u003e Effect.Effect\u003cvoid, EmitConflict\u003e\n\n// plugin-runner.ts - never called!\n```\n\nAfter all plugins execute, should call `emissions.validate()` to catch conflicts before writing files.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:47.572794008-06:00","updated_at":"2026-01-06T10:09:41.33706227-06:00","closed_at":"2026-01-06T10:09:41.33706227-06:00","close_reason":"run() now automatically validates emissions and symbols after plugin execution. Fails with EmitConflict or SymbolConflict errors.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-2r3","title":"File Writer Service","description":"Write buffered emissions to disk:\n\n- Take EmissionBuffer contents after all plugins complete\n- Add generated file header with timestamp\n- Create directories as needed\n- Write files (overwrite existing)\n- Support dry-run mode (show what would be written)\n\nUses @effect/platform FileSystem service.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:20.082752601-06:00","updated_at":"2026-01-05T20:00:07.060720919-06:00","closed_at":"2026-01-05T20:00:07.060720919-06:00","close_reason":"Implemented FileWriter service using @effect/platform FileSystem. Features: writes emissions to disk with auto-generated header, creates directories recursively, supports dry-run mode, parallel file writes with configurable concurrency. Full test coverage with real filesystem operations.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-2r3","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:20.084147028-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-2ttn","title":"Add composite type generation to zod.ts","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:15:08.858676445-06:00","created_by":"dan","updated_at":"2026-01-08T15:15:41.875418587-06:00","closed_at":"2026-01-08T15:15:41.875418587-06:00","close_reason":"Duplicate - keeping 0kkz, vswe, 22u9"}
{"id":"pg-sourcerer-37k","title":"Update FileNameContext for unified Entity","description":"Simplify FileNameContext to use pgName instead of tableName. Ensure it works for all entity kinds. Update PluginInflection if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T14:23:17.701406398-06:00","updated_at":"2026-01-07T14:47:15.452974258-06:00","closed_at":"2026-01-07T14:47:15.452974258-06:00","close_reason":"Updated FileNameContext.tableName to pgName for consistency with Entity.pgName","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-37k","depends_on_id":"pg-sourcerer-6w8","type":"blocks","created_at":"2026-01-07T14:23:26.001672499-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-395","title":"Update plugins to use function-based inflectionDefaults","description":"Update types.ts, zod.ts, effect-model.ts plugins to use function-based inflectionDefaults instead of transform chain arrays.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T10:03:08.207964812-06:00","updated_at":"2026-01-07T10:10:42.437562616-06:00","closed_at":"2026-01-07T10:10:42.437562616-06:00","close_reason":"Merged into pg-sourcerer-4ia","dependencies":[{"issue_id":"pg-sourcerer-395","depends_on_id":"pg-sourcerer-4ia","type":"blocks","created_at":"2026-01-07T10:03:15.418692606-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-395","depends_on_id":"pg-sourcerer-knj","type":"blocks","created_at":"2026-01-07T10:03:15.441544261-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-3b8","title":"Permission filtering not applied to shape field generation","description":"When connecting with a role (e.g., `visitor`), the IR builder computes field permissions correctly but does NOT filter fields from shapes based on those permissions.\n\n**Current behavior:**\n- `computeFieldPermissions()` attaches `canSelect`, `canInsert`, `canUpdate` to each field\n- `buildShape()` only filters by `@omit` tags, ignoring permissions\n- All fields appear in all shapes regardless of role's actual grants\n\n**Expected behavior:**\n- Insert shape should only include fields where `canInsert: true`\n- Update shape should only include fields where `canUpdate: true`  \n- Row shape should only include fields where `canSelect: true`\n\n**Example from migrations:**\n```sql\n-- users table\ngrant select on app_public.users to visitor;\ngrant update(username, name, bio, avatar_url) on app_public.users to visitor;\n-- NOTE: insert is NOT granted\n```\n\nFor visitor role:\n- Insert shape should be empty/omitted (no INSERT permission)\n- Update shape should only have: username, name, bio, avatar_url\n- Row shape should have all columns (table-level SELECT)\n\n**Additional ACL bug found:**\nThe original `computeFieldPermissions()` used nullish coalescing (`??`) which doesn't fall back correctly when `entityPermissions()` returns `false` (vs `undefined`). Need to use OR semantics to combine table + column permissions.","design":"**Proposed fix (Option A - IR layer filtering):**\n\n1. Add `hasPermissionForShape(permissions, kind)` helper function\n2. Modify `buildShape()` to filter attributes by permissions in addition to @omit tags\n3. Fix `computeFieldPermissions()` to properly combine table + column ACLs using OR semantics\n4. Modify shape inclusion logic to exclude shapes with 0 fields\n\n**Key code locations:**\n- `packages/pg-sourcerer/src/services/ir-builder.ts`:\n  - `computeFieldPermissions()` ~line 115\n  - `buildShape()` ~line 292\n  - `buildEntity()` shape inclusion logic ~line 497\n\n**Trade-offs considered:**\n- Option A (IR filters): Single fix, all plugins benefit, IR reflects actual role capabilities\n- Option B (Plugin filters): More flexible but duplicates logic across plugins\n\nChose Option A because the purpose of setting a `role` in config is to get role-appropriate output.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-07T23:53:06.443997172-06:00","updated_at":"2026-01-08T08:57:22.124682998-06:00","closed_at":"2026-01-08T08:57:22.124682998-06:00","close_reason":"Fixed permission filtering: 1) Added 'role' to IRBuilderOptions and config-loader to pass config.role through to IR builder, 2) IR builder now looks up the specified role in introspection.roles instead of using getCurrentUser(), 3) Config loader now includes role in ResolvedConfig. Permission-based field filtering was already working - the issue was that the configured role wasn't being used.","labels":["core","ir-builder","permissions"]}
{"id":"pg-sourcerer-3bq","title":"Implement query plugin - generate typed query functions","description":"Generate typed query functions that execute raw SQL with type-safe wrappers.\n\n## Plugin Config\n- provides: [\"queries:sql\"]\n- requires: [\"types\"]\n- Returns Promise\u003cT\u003e (not Effect)\n\n## Query Functions to Generate\n\n### Per Entity (based on indexes):\n- **Primary key**: `getUserById(id: string): Promise\u003cUser | null\u003e`\n- **Unique indexes**: `getUserByUsername(username: string): Promise\u003cUser | null\u003e`\n- **Non-unique indexes**: `getPostsByUserId(userId: string): Promise\u003cPost[]\u003e`\n- **Composite indexes**: `getVoteByPostIdAndUserId(postId: number, userId: string): Promise\u003cPostVote | null\u003e`\n\n### Generated File Structure:\n```\nqueries/\n  users.ts      # getUserById, getUserByUsername, listUsers, etc.\n  posts.ts      # getPostById, getPostsByUserId, listPosts, etc.\n  index.ts      # re-exports\n```\n\n## Implementation Notes\n- Import Row types from types plugin via symbol registry\n- Generate parameterized SQL ($1, $2, etc.)\n- Handle nullable returns (single) vs arrays (multi)\n- Skip expression-only indexes (no column names to use)\n- Skip partial indexes for now (predicate parsing is complex)\n\n## Acceptance Criteria\n- [ ] Plugin scaffolding with definePlugin\n- [ ] Primary key lookups work\n- [ ] Unique index lookups work  \n- [ ] Non-unique index lookups return arrays\n- [ ] Composite key lookups work\n- [ ] Imports Row types from types plugin\n- [ ] SQL is parameterized (no injection)","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-01-07T11:36:56.856496644-06:00","updated_at":"2026-01-07T21:16:00.370010569-06:00","closed_at":"2026-01-07T21:16:00.370010569-06:00","close_reason":"Implemented: sql-queries plugin generates typed query functions (findById, findMany, delete, getByField)","dependencies":[{"issue_id":"pg-sourcerer-3bq","depends_on_id":"pg-sourcerer-prh","type":"blocks","created_at":"2026-01-07T11:37:03.367161703-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-3bq","depends_on_id":"pg-sourcerer-t1b","type":"blocks","created_at":"2026-01-07T11:41:45.343563267-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-3bq","depends_on_id":"pg-sourcerer-y9v","type":"blocks","created_at":"2026-01-07T11:44:29.793819003-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-3c2","title":"Configure package.json exports for npm publication","description":"Update package.json with proper exports configuration:\n- Change `main` from `src/index.ts` to `dist/index.js`\n- Add `types` field pointing to `dist/index.d.ts`\n- Add `exports` field for ESM\n- Add `files` field to control what gets published (dist/, README, LICENSE)\n- Add `prepublishOnly` script to ensure build runs before publish","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:55:38.367767617-06:00","updated_at":"2026-01-07T11:00:35.002153367-06:00","closed_at":"2026-01-07T11:00:35.002153367-06:00","close_reason":"Updated package.json with: main→dist/index.js, types field, exports map, bin→dist/cli.js, files array, keywords, repository, license, author. Bumped version to 0.1.0.","labels":["p0","publish"],"dependencies":[{"issue_id":"pg-sourcerer-3c2","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:08.346457137-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-3d9","title":"sql-queries: Missing await on sql calls","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-07T16:11:24.977745311-06:00","updated_at":"2026-01-07T20:27:32.985680982-06:00","closed_at":"2026-01-07T20:27:32.985680982-06:00","close_reason":"Already implemented: Test 'async functions use await' passes - sql calls use await"}
{"id":"pg-sourcerer-3eo","title":"pg-types: Refactor findEnumByPgName to use Effect patterns","description":"Refactor `findEnumByPgName` to use Effect's `Arr.findFirst` and `Option.map` instead of imperative for loop with early return.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T16:52:11.37795329-06:00","updated_at":"2026-01-07T18:42:35.193494147-06:00","closed_at":"2026-01-07T18:42:35.193494147-06:00","close_reason":"Superseded by pg-sourcerer-ug3 - larger Option\u003cT\u003e refactor"}
{"id":"pg-sourcerer-3ii","title":"Add tests for query plugin","description":"Comprehensive tests for the query plugin.\n\n## Test Categories\n\n### Unit Tests\n- Index → query function mapping logic\n- SQL generation (parameterization, escaping)\n- Function naming inflection\n- Composite key handling\n\n### Integration Tests (against example DB)\n- Primary key lookups return correct row\n- Unique lookups return correct row  \n- Non-unique lookups return array\n- FK lookups return related rows\n- Pagination works (limit, offset, orderBy)\n- Count returns correct number\n- Exists returns boolean\n- Missing row returns null (not throws)\n\n### Edge Cases\n- Tables with no indexes (only PK)\n- Composite primary keys\n- Self-referential FKs\n- Tables with many indexes (dedup?)\n- Reserved word column names","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T11:36:57.695517132-06:00","updated_at":"2026-01-07T11:44:31.12859824-06:00","closed_at":"2026-01-07T11:44:31.12859824-06:00","close_reason":"Superseded by test-first tasks (afn, y9v) integrated into the workflow","dependencies":[{"issue_id":"pg-sourcerer-3ii","depends_on_id":"pg-sourcerer-3bq","type":"blocks","created_at":"2026-01-07T11:37:04.052953148-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-3ii","depends_on_id":"pg-sourcerer-jpi","type":"blocks","created_at":"2026-01-07T11:42:06.150789879-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-3p5","title":"Refactor Entity as discriminated union in semantic-ir.ts","description":"Create EntityBase, TableEntity, EnumEntity types. Entity becomes union. Add pgName field (replaces tableName). Remove separate EnumDef type. Update SemanticIR to remove enums map. Update SemanticIRBuilder and freezeIR.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T14:23:08.942302889-06:00","updated_at":"2026-01-07T14:26:14.413700984-06:00","closed_at":"2026-01-07T14:26:14.413700984-06:00","close_reason":"Created EntityBase, TableEntity, EnumEntity. Entity is now a union type. Added pgName field. Removed separate enums map from SemanticIR. Added type guards isTableEntity() and isEnumEntity(). Added helper functions getTableEntities() and getEnumEntities().","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-3p5","depends_on_id":"pg-sourcerer-6fo","type":"blocks","created_at":"2026-01-07T14:23:08.948476036-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-3pg","title":"Fix generated file imports: @sorcery/db path not resolving","description":"ESLint shows ~185 errors in packages/example/generated/ - all are 'unsafe' errors because the import from @sorcery/db is not resolving correctly. The generator is emitting incorrect import paths.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-06T10:31:44.957198415-06:00","updated_at":"2026-01-06T11:53:05.080661707-06:00","closed_at":"2026-01-06T11:53:05.080661707-06:00","close_reason":"Issue is resolved - generated files now import from @effect/sql and effect correctly. ESLint reports no errors in packages/example/generated/.","labels":["rewrite"]}
{"id":"pg-sourcerer-3si","title":"Refactor ir-builder.ts getTypeName to use Option\u003cPgType\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T19:09:28.430131763-06:00","updated_at":"2026-01-07T21:17:00.899353073-06:00","closed_at":"2026-01-07T21:17:00.899353073-06:00","close_reason":"Duplicate of pg-sourcerer-jgs"}
{"id":"pg-sourcerer-4dbm","title":"Add composite type generation to effect-model.ts","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:15:10.86616331-06:00","created_by":"dan","updated_at":"2026-01-08T15:15:41.7883113-06:00","closed_at":"2026-01-08T15:15:41.7883113-06:00","close_reason":"Duplicate - keeping 0kkz, vswe, 22u9"}
{"id":"pg-sourcerer-4h9","title":"Simplify effect-model plugin output","description":"The current effect-model plugin generates overly complex nested code like Model.FieldExcept(...)(Model.Generated(...)) when simpler patterns exist. Refactor to use Model.Generated, Model.Sensitive, Model.DateTimeInsertFromDate etc directly instead of manually composing FieldExcept.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T22:46:03.754536125-06:00","updated_at":"2026-01-06T22:55:47.338983628-06:00","closed_at":"2026-01-06T22:55:47.338983628-06:00","close_reason":"Simplified plugin: removed FieldExcept nesting, use Model.Generated/Sensitive/DateTimeInsertFromDate directly. Also fixed shared emptySmartTags bug causing tag mutations to leak between fields.","labels":["effect-model","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-4h9","depends_on_id":"pg-sourcerer-7sa","type":"blocks","created_at":"2026-01-06T22:46:20.162500473-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-4ia","title":"Refactor InflectionConfig to use string→string functions","description":"Refactor InflectionConfig from TransformChain string arrays to plain string→string functions. This includes:\n\n1. Change InflectionConfig to use optional functions: `entityName?: (name: string) =\u003e string`\n2. Update createInflection() to accept function-based config\n3. Fix composeInflection to properly compose functions: `(name) =\u003e user(plugin(name))`\n4. Update plugins to use function-based inflectionDefaults\n5. Export helper functions (singularize, pluralize, camelCase, etc.) for user composition\n6. Complete the pluginInflection work from pg-sourcerer-fav (already wired to context)\n7. Fix failing tests\n\nMerged from pg-sourcerer-fav which added FileNameContext and pluginInflection to SimplePluginContext.","notes":"## Current State (from fav)\n\n### Completed\n- FileNameContext type added to plugin.ts\n- PluginInflection.outputFile signature updated\n- pluginInflection added to SimplePluginContext\n- All plugins updated to use ctx.pluginInflection.outputFile(fileNameCtx)\n\n### Broken\n- composeInflection doesn't properly compose plugin defaults with user config\n- Tests failing: plugin-runner.test.ts (missing Inflection), e2e-config.test.ts (wrong filenames)\n\n### Root Cause\nThe current TransformChain approach makes composition awkward. composeInflection only applies plugin chain, ignores base inflection's chain.\n\n## Plan\n1. Change InflectionConfig from TransformChain to functions\n2. Update composeInflection to compose functions properly\n3. Export helper functions for users\n4. Fix tests","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:03:03.292086241-06:00","updated_at":"2026-01-07T10:32:19.739406904-06:00","closed_at":"2026-01-07T10:32:19.739406904-06:00","close_reason":"Completed: Refactored InflectionConfig from TransformChain string arrays to plain TransformFn functions. Added inflect helper object with camelCase, pascalCase, singularize, etc. Updated all tests and example config to use new function-based API. All 445 tests passing.","dependencies":[{"issue_id":"pg-sourcerer-4ia","depends_on_id":"pg-sourcerer-fav","type":"blocks","created_at":"2026-01-07T10:07:04.59422721-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-4kh","title":"Export inflection helper functions","description":"Export singularize, pluralize, camelCase, pascalCase, snakeCase, etc. from the package so users can compose them in their config.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T10:03:06.668245492-06:00","updated_at":"2026-01-07T10:10:43.119373423-06:00","closed_at":"2026-01-07T10:10:43.119373423-06:00","close_reason":"Merged into pg-sourcerer-4ia","dependencies":[{"issue_id":"pg-sourcerer-4kh","depends_on_id":"pg-sourcerer-4ia","type":"blocks","created_at":"2026-01-07T10:03:15.392231381-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-4tjp","title":"Make function wrapper naming use plugin inflection instead of hardcoded camelCase","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-08T22:48:16.761626199-06:00","created_by":"dan","updated_at":"2026-01-08T22:48:16.761626199-06:00"}
{"id":"pg-sourcerer-4zj","title":"Verify compiled output works for Node.js consumers","description":"After adding build script and exports config, verify the package works when consumed:\n- Build the package\n- Create a simple test project that imports from the built package\n- Ensure types resolve correctly\n- Ensure runtime works (not just types)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:55:50.511813633-06:00","updated_at":"2026-01-07T10:56:01.675051784-06:00","closed_at":"2026-01-07T10:56:01.675051784-06:00","close_reason":"Duplicate - see pg-sourcerer-78f which has proper dependencies","labels":["p0","publish"]}
{"id":"pg-sourcerer-5n0","title":"Add FunctionEntity to IR","description":"Add FunctionEntity to the Entity discriminated union for PostgreSQL stored functions/procedures.\n\n## Fields from PgProc\n\nBased on old introspection.mjs (commit e2ab591):\n- `proc.pronamespace` - schema OID\n- `proc.proname` - function name  \n- `proc.getReturnType()` - return type\n- `proc.provolatile` - 'i' (immutable), 's' (stable), 'v' (volatile)\n- `proc.proargnames` - argument names (may be null/sparse)\n- `proc.getArguments()` - array of { type, hasDefault }\n- Permissions via `entityPermissions()` → { canExecute: boolean }\n\n## Proposed Types\n\n```typescript\nexport type Volatility = \"immutable\" | \"stable\" | \"volatile\"\n\nexport interface FunctionArg {\n  readonly name: string\n  readonly typeName: string\n  readonly hasDefault: boolean\n  readonly mode: \"in\" | \"out\" | \"inout\" | \"variadic\"\n}\n\nexport interface FunctionEntity extends EntityBase {\n  readonly kind: \"function\"\n  readonly pgProc: PgProc\n  readonly returnTypeName: string\n  readonly returnsSet: boolean\n  readonly args: readonly FunctionArg[]\n  readonly outArgs: readonly FunctionArg[]\n  readonly volatility: Volatility\n  readonly isStrict: boolean\n  readonly canExecute: boolean\n}\n```\n\n## Implementation\n\n1. Update EntityKind to include \"function\"\n2. Add FunctionEntity interface to semantic-ir.ts\n3. Add isFunctionEntity() type guard and getFunctionEntities() helper\n4. Add filterFunctions() and buildFunction() to ir-builder.ts\n5. Update build() to include functions in IR\n6. Export new types from index.ts\n7. Add integration tests","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-07T15:09:25.828788626-06:00","updated_at":"2026-01-07T15:29:49.134698579-06:00","closed_at":"2026-01-07T15:29:49.134698579-06:00","close_reason":"Implemented FunctionEntity with Volatility, FunctionArg types; updated EntityKind and Entity union; added isFunctionEntity type guard and getFunctionEntities helper; added filterFunctions, buildFunction, getTypeName to ir-builder; added functionName inflection method; all 498 tests pass"}
{"id":"pg-sourcerer-5vx","title":"Add emitAst() to plugin context for AST-based emissions","description":"Add emitAst(path, ast) alongside emit(path, string) so plugins can emit AST nodes directly. The plugin runner handles serialization, enabling future AST-level operations like import merging and consistent formatting.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-06T15:54:17.009310926-06:00","updated_at":"2026-01-06T16:11:16.393335077-06:00","closed_at":"2026-01-06T16:11:16.393335077-06:00","close_reason":"Implemented emitAst() in EmissionBuffer and SimplePluginContext. Types and Zod plugins now use emitAst() with conjure DSL. All 355 tests pass. AST serialization happens in plugin runner after all plugins complete, enabling future AST-level operations like import merging.","labels":["conjure","rewrite"]}
{"id":"pg-sourcerer-682","title":"Refactor services to use Effect immutable collections","description":"Several services still use native Map/Set where MutableHashMap/MutableHashSet or HashMap/HashSet would be more idiomatic:\n\n- emissions.ts prependImports (local Map/Set)\n- symbols.ts registry (Map)\n- artifact-store.ts (Map)\n- types.ts plugin (Set/Map for tracking)\n\nLow priority - current code works fine, this is just for consistency.","status":"closed","priority":2,"issue_type":"chore","created_at":"2026-01-07T14:01:42.837367421-06:00","updated_at":"2026-01-07T16:41:59.413769492-06:00","closed_at":"2026-01-07T16:40:49.95231581-06:00","close_reason":"Refactored symbols.ts and artifact-store.ts to use MutableHashMap from Effect instead of native Map"}
{"id":"pg-sourcerer-6a3","title":"Migrate types plugin to FileBuilder + exp.*","description":"Refactor types plugin to use new APIs:\n\n## Changes\n- Replace manual symbol registration with exp.* helpers\n- Replace ctx.emitAst() with ctx.file().ast().emit()\n- Replace hardcoded enum import strings with symbol refs\n- Use exp.interface() for entity interfaces\n- Use exp.typeAlias() for enum type aliases\n\n## Example\n```typescript\nconst enumStatements = [...ir.enums.values()].map(enumDef =\u003e\n  exp.typeAlias(\n    enumDef.name,\n    { capability: \"types\", entity: enumDef.name },\n    ts.union(...enumDef.values.map(v =\u003e ts.literal(v)))\n  )\n)\n\nctx.file(`${config.outputDir}/enums.ts`)\n  .header(\"// Auto-generated. Do not edit.\")\n  .ast(program(...enumStatements))\n  .emit()\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T17:46:19.895206284-06:00","updated_at":"2026-01-06T18:09:18.121785916-06:00","closed_at":"2026-01-06T18:09:18.121785916-06:00","close_reason":"Migrated types plugin to FileBuilder + exp.* API. Now uses ctx.file().header().import().ast().emit() pattern, exp.interface() for shape interfaces, exp.typeAlias() for enums, and symbol-based import refs instead of hardcoded strings.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-6a3","depends_on_id":"pg-sourcerer-9pr","type":"parent-child","created_at":"2026-01-06T17:46:37.612017704-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-6a3","depends_on_id":"pg-sourcerer-7yv","type":"blocks","created_at":"2026-01-06T17:46:47.455935467-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-6a3","depends_on_id":"pg-sourcerer-gmb","type":"blocks","created_at":"2026-01-06T17:46:49.953708738-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-6fc","title":"type-hints: Refactor merged hints for loop to Array.reduce","description":"Refactor getHintsImpl for...of with Object.assign to use Array.reduce","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:06:19.134822063-06:00","updated_at":"2026-01-07T20:06:58.444681819-06:00","closed_at":"2026-01-07T20:06:58.444681819-06:00","close_reason":"Refactored getHintsImpl: for...of with Object.assign → Array.reduce with spread operator"}
{"id":"pg-sourcerer-6fo","title":"Enums/domains/composites should follow same output rules as entities","description":"Unify Entity and EnumDef into a single discriminated union type. Enums become entities with kind: \"enum\", eliminating the separate ir.enums map. This enables enums to follow the same output/inflection rules as tables and views.","design":"## New Entity Structure (Discriminated Union)\n\n```typescript\n// Base fields shared by all entity kinds\ninterface EntityBase {\n  readonly name: string           // Inflected name\n  readonly pgName: string         // Original PG name (replaces tableName)\n  readonly schemaName: string\n  readonly tags: SmartTags\n}\n\n// Table/View entity\ninterface TableEntity extends EntityBase {\n  readonly kind: \"table\" | \"view\"\n  readonly pgClass: PgClass\n  readonly primaryKey?: PrimaryKey\n  readonly indexes: readonly IndexDef[]\n  readonly shapes: { row: Shape; insert?: Shape; update?: Shape; patch?: Shape }\n  readonly relations: readonly Relation[]\n  readonly permissions: EntityPermissions\n}\n\n// Enum entity\ninterface EnumEntity extends EntityBase {\n  readonly kind: \"enum\"\n  readonly pgType: PgType\n  readonly values: readonly string[]\n}\n\ntype Entity = TableEntity | EnumEntity\n```\n\n## Changes Required\n1. semantic-ir.ts - Restructure Entity as discriminated union\n2. ir-builder.ts - Add enums to entities map\n3. SemanticIR - Remove enums map\n4. FileNameContext - Simplify to work with unified Entity\n5. All plugins - Handle entity.kind discrimination\n6. Tests - Update fixtures","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-07T13:03:01.291531908-06:00","updated_at":"2026-01-07T14:47:17.563853936-06:00","closed_at":"2026-01-07T14:47:17.563853936-06:00","close_reason":"Completed: Enums now follow same output rules as entities. Each enum gets its own file via outputFile inflection. Entity is now a discriminated union with TableEntity and EnumEntity."}
{"id":"pg-sourcerer-6g1","title":"Add permission helper functions to ir-builder.ts","description":"Create helper functions to extract permissions from pg-introspection.\n\n**Import:**\n```typescript\nimport { entityPermissions } from \"pg-introspection\"\n```\n\n**Add `buildEntityPermissions` function:**\n```typescript\nfunction buildEntityPermissions(\n  introspection: Introspection,\n  pgClass: PgClass,\n  role: PgRoles\n): EntityPermissions {\n  const perms = entityPermissions(introspection, pgClass, role, true)\n  \n  let canSelect = perms.select ?? false\n  let canInsert = perms.insert ?? false\n  let canUpdate = perms.update ?? false\n  const canDelete = perms.delete ?? false\n  \n  // Check column-level permissions if table-level is missing\n  if (!canInsert || !canUpdate || !canSelect) {\n    const attrs = pgClass.getAttributes().filter(a =\u003e a.attnum \u003e 0)\n    for (const attr of attrs) {\n      const attrPerms = entityPermissions(introspection, attr, role, true)\n      canSelect ||= Boolean(attrPerms.select)\n      canInsert ||= Boolean(attrPerms.insert)\n      canUpdate ||= Boolean(attrPerms.update)\n    }\n  }\n  \n  return { canSelect, canInsert, canUpdate, canDelete }\n}\n```\n\n**Add `buildFieldPermissions` function:**\n```typescript\nfunction buildFieldPermissions(\n  introspection: Introspection,\n  attr: PgAttribute,\n  tablePerms: EntityPermissions,\n  role: PgRoles\n): FieldPermissions {\n  const attrPerms = entityPermissions(introspection, attr, role, true)\n  \n  return {\n    canSelect: attrPerms.select ?? tablePerms.canSelect,\n    canInsert: attrPerms.insert ?? tablePerms.canInsert,\n    canUpdate: attrPerms.update ?? tablePerms.canUpdate,\n  }\n}\n```\n\n**Reference:** `packages/pg-sourcerer/introspection.mjs:420-466` for existing pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T13:05:47.94165513-06:00","updated_at":"2026-01-06T13:18:09.039138135-06:00","closed_at":"2026-01-06T13:18:09.039138135-06:00","close_reason":"Helper functions and wiring done as part of hbl parent issue","labels":["ir","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-6g1","depends_on_id":"pg-sourcerer-spt","type":"blocks","created_at":"2026-01-06T13:06:12.119317061-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-6g1","depends_on_id":"pg-sourcerer-hbl","type":"parent-child","created_at":"2026-01-06T13:06:16.839234323-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-6lg","title":"Design query plugin architecture","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T11:36:56.305445549-06:00","updated_at":"2026-01-07T11:41:28.930761253-06:00","closed_at":"2026-01-07T11:41:28.930761253-06:00","close_reason":"Design completed via conversation - raw SQL, Promise-based, requires types plugin"}
{"id":"pg-sourcerer-6ph","title":"emissions: Refactor prependImports for loops to functional patterns","description":"Refactor prependImports loops to use pipe/Array.reduce/flatMap patterns","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:04:06.915607954-06:00","updated_at":"2026-01-07T20:06:01.363259251-06:00","closed_at":"2026-01-07T20:06:01.363259251-06:00","close_reason":"Refactored prependImports: for loops → Array.reduce + Array.flatMap + Arr.map, extracted resolveImportRef helper"}
{"id":"pg-sourcerer-6v6","title":"Add GitHub Actions workflow for npm publish","description":"Create a GitHub Actions workflow that:\n- Triggers on release tags (v*)\n- Runs tests\n- Builds the package\n- Publishes to npm\n\nConsider also adding a CI workflow for PRs that runs tests and typecheck.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T10:55:47.23586906-06:00","updated_at":"2026-01-07T10:59:51.097422715-06:00","closed_at":"2026-01-07T10:59:51.097422715-06:00","close_reason":"Added release.yml (triggers on v* tags, runs tests, builds, publishes to npm) and ci.yml (runs on PRs/push to main for testing)","labels":["ci","p2","publish"],"dependencies":[{"issue_id":"pg-sourcerer-6v6","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:12.442830255-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-6w8","title":"Update ir-builder.ts to add enums to entities map","description":"Modify buildSemanticIR to create EnumEntity objects and add them to ir.entities instead of ir.enums. Remove enum-specific building code that targets separate map.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T14:23:10.937382701-06:00","updated_at":"2026-01-07T14:26:19.985714914-06:00","closed_at":"2026-01-07T14:26:19.985714914-06:00","close_reason":"buildEntity now returns TableEntity. buildEnum now returns EnumEntity with kind: \"enum\". Enums are added to builder.entities instead of builder.enums. tableName replaced with pgName.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-6w8","depends_on_id":"pg-sourcerer-3p5","type":"blocks","created_at":"2026-01-07T14:23:23.388815042-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-72u","title":"Inflection Service Implementation","description":"Implement CoreInflection service with naming transformations:\n- camelCase, pascalCase\n- pluralize, singularize\n- safeIdentifier (handle reserved words)\n- entityName, shapeName, fieldName\n- enumName, enumValueName\n- relationName\n\nCurrently stubbed - all methods throw \"not implemented\".","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:22:56.727789317-06:00","updated_at":"2026-01-05T19:50:38.846239791-06:00","closed_at":"2026-01-05T19:50:38.846239791-06:00","close_reason":"Implemented all CoreInflection methods: camelCase/pascalCase via Effect String module, naive pluralize/singularize, safeIdentifier with reserved words, entityName/shapeName/fieldName/enumName/enumValueName/relationName with tag overrides.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-72u","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:22:56.729599696-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-73mr","title":"Add hasMany/hasOne relations to IR (reverse FK lookup)","description":"Currently IR builder only creates belongsTo relations (child→parent). For bidirectional FK navigation, we need to also compute the reverse:\n\n- If orders.user_id → users.id, then orders belongsTo users (existing)\n- Reverse: users hasMany orders (needed)\n\nOptions:\nA) Compute in ir-builder.ts during build (adds to IR)\nB) Compute on-demand via utility function (doesn't modify IR)\nC) Both - compute during build for IR consumers, utility for ad-hoc\n\nRecommend B for now (simpler, no IR schema change), can upgrade to A later.\n\nLocation: ir/relation-graph.ts or services/join-graph.ts\n\nInterface sketch:\n```typescript\ninterface ReversedRelation extends Relation {\n  sourceEntity: string  // The entity that has the FK\n}\n\nfunction getReversedRelations(ir: SemanticIR, entityName: string): ReversedRelation[]\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T11:08:45.089653778-06:00","created_by":"dan","updated_at":"2026-01-08T11:12:18.141482186-06:00","closed_at":"2026-01-08T11:12:18.141482186-06:00","close_reason":"Added getReverseRelations() and getAllRelations() to semantic-ir.ts. Pure functions that compute hasMany relations on-demand from existing belongsTo. Exported from main index. Tests added.","dependencies":[{"issue_id":"pg-sourcerer-73mr","depends_on_id":"pg-sourcerer-ip2f","type":"parent-child","created_at":"2026-01-08T11:09:13.140955822-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-78f","title":"Verify compiled output works for Node.js consumers","description":"After adding build script and exports config, verify the package works when consumed:\n- Build the package\n- Create a simple test project that imports from the built package\n- Ensure types resolve correctly\n- Ensure runtime works (not just types)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:55:55.325351407-06:00","updated_at":"2026-01-07T11:02:21.660869758-06:00","closed_at":"2026-01-07T11:02:21.660869758-06:00","close_reason":"Verified: Built CLI works from example package (`bun run dry` succeeds), all 445 tests pass with updated dependencies. Updated example to use `pgsourcerer` bin instead of direct .ts path. Consolidated Effect packages in root catalog.","labels":["p0","publish"],"dependencies":[{"issue_id":"pg-sourcerer-78f","depends_on_id":"pg-sourcerer-bf0","type":"blocks","created_at":"2026-01-07T10:55:55.380950887-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-78f","depends_on_id":"pg-sourcerer-3c2","type":"blocks","created_at":"2026-01-07T10:55:55.382947585-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-78f","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:09.678252663-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-79i","title":"Replace TransformChain string arrays with functions","description":"The current InflectionConfig uses TransformChain (string arrays like [\"singularize\", \"pascalCase\"]) which is limiting. Replace with function-based approach: (input: string, utils: InflectionUtils) =\u003e string. This gives full programmatic control and eliminates the registry lookup pattern.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T23:49:44.71155732-06:00","updated_at":"2026-01-07T10:07:03.703166089-06:00","closed_at":"2026-01-07T10:07:03.703166089-06:00","close_reason":"Duplicate of pg-sourcerer-4ia","dependencies":[{"issue_id":"pg-sourcerer-79i","depends_on_id":"pg-sourcerer-fav","type":"blocks","created_at":"2026-01-06T23:50:47.346867656-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-7a1","title":"Add FK-based query functions to query plugin","description":"Extend the query plugin to generate lookup functions based on foreign key relations.\n\n## Functions to Generate\nFor each FK relation (e.g., posts.user_id → users.id):\n- `getPostsByUserId(userId: string): Promise\u003cPost[]\u003e`\n- `getCommentsByPostId(postId: number): Promise\u003cComment[]\u003e`\n\n## Implementation\n- Use existing Relations in SemanticIR (already populated from FKs)\n- Generate function for belongsTo side (the table with the FK column)\n- Name based on relation: `get{TargetEntity}sBy{LocalColumn}`\n\n## Notes\n- This overlaps with non-unique index lookups if FK columns are indexed\n- Deduplicate: if an index lookup already exists for the same columns, skip\n- Or: always generate FK lookups, they're semantically meaningful even if redundant","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T11:41:56.784437062-06:00","updated_at":"2026-01-08T16:51:19.399518963-06:00","closed_at":"2026-01-08T16:51:19.399518963-06:00","close_reason":"Implemented FK-based semantic naming for sql-queries plugin","dependencies":[{"issue_id":"pg-sourcerer-7a1","depends_on_id":"pg-sourcerer-3bq","type":"blocks","created_at":"2026-01-07T11:42:05.824906746-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-7by","title":"artifact-store: Refactor getAll for loop to Array.fromIterable","description":"Refactor getAll() for...of loop to use pipe with Array.fromIterable/reduce","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:07:49.327174347-06:00","updated_at":"2026-01-07T20:08:44.277436805-06:00","closed_at":"2026-01-07T20:08:44.277436805-06:00","close_reason":"Refactored getAll: for...of loop → pipe with spread operator + Array.reduce"}
{"id":"pg-sourcerer-7e6","title":"Create CLI entry point with @effect/cli","description":"Create src/cli.ts using @effect/cli that orchestrates the full generation pipeline:\n1. Load config via ConfigLoaderService\n2. Introspect database via DatabaseIntrospectionService  \n3. Build IR via IRBuilderSvc\n4. Prepare and run plugins via PluginRunner\n5. Write files via FileWriterSvc\n\nCommand: `pgsourcerer generate [--config \u003cpath\u003e] [--dry-run] [--output \u003cdir\u003e]`","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-06T15:06:20.81900903-06:00","updated_at":"2026-01-06T15:13:46.093283605-06:00","closed_at":"2026-01-06T15:13:46.093283605-06:00","close_reason":"Created src/cli.ts with @effect/cli. Commands: `pgsourcerer generate [-c config] [-o output] [-n dry-run] [-v verbose]`. Exports generate/runGenerate in index.ts.","labels":["cli","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-7e6","depends_on_id":"pg-sourcerer-9gj","type":"blocks","created_at":"2026-01-06T15:06:33.685557638-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-7e6","depends_on_id":"pg-sourcerer-ylu","type":"blocks","created_at":"2026-01-06T15:06:34.428471867-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-7sa","title":"Investigate RLS permissions in example DB","description":"All User fields show canInsert=false which seems wrong. Either the RLS policies are restrictive or the permission detection is broken. Investigate why and fix - this affects what code gets generated.","notes":"FINDING: Fixture was generated with role='visitor' which has limited permissions:\n- Table: visitor=r (SELECT only, no INSERT)  \n- Column ACLs grant UPDATE on specific columns (username, name, etc.)\n\nThis is why canInsert=false for all fields.\n\nOPTIONS:\n1. Regenerate fixture with owner role - gives full permissions\n2. Make role configurable in introspection/generation\n3. For Model plugin: ignore ACL permissions, base variants on schema (hasDefault, isGenerated) not RLS\n\nRECOMMENDATION: Option 3 for the plugin - ACLs are runtime enforcement, not type generation concerns. Model variants should be:\n- insert: exclude isGenerated/isIdentity fields, make hasDefault optional\n- update: all fields optional\n- sensitive: smart tag controlled","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T22:46:13.074013292-06:00","updated_at":"2026-01-06T22:47:49.54753056-06:00","closed_at":"2026-01-06T22:47:49.54753056-06:00","close_reason":"Root cause found: fixture uses visitor role with limited permissions. For effect-model plugin, will ignore ACL permissions and base variants on schema properties (hasDefault, isGenerated) instead.","labels":["effect-model","rewrite"]}
{"id":"pg-sourcerer-7xo","title":"Configure coverage exclusions for entry points","description":"Configure vitest coverage to exclude files that shouldn't count against coverage:\n- cli.ts (entry point, test via CLI integration)\n- index.ts (re-exports only)\n- scripts/ (build tooling)\n\nUpdate vitest.config.ts with coverage.exclude patterns.","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-01-07T12:41:50.543019227-06:00","updated_at":"2026-01-07T12:47:02.134413602-06:00","closed_at":"2026-01-07T12:47:02.134413602-06:00","close_reason":"Configured vitest coverage exclusions - coverage now 88.39%","dependencies":[{"issue_id":"pg-sourcerer-7xo","depends_on_id":"pg-sourcerer-pj1","type":"parent-child","created_at":"2026-01-07T12:42:50.038844942-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-7yv","title":"Import resolution with cycle detection","description":"Implement import resolution in serializeAst() using Effect Graph.\n\n## ImportRef Types\n```typescript\ntype ImportRef =\n  | { kind: \"symbol\"; ref: SymbolRef; isType?: boolean }\n  | { kind: \"package\"; names?: string[]; types?: string[]; default?: string; from: string }\n  | { kind: \"relative\"; names?: string[]; types?: string[]; default?: string; from: string }\n```\n\n## Resolution Flow\n1. Build import dependency graph (Effect Graph)\n   - Nodes: emitted file paths\n   - Edges: file A imports symbol from file B\n2. Check cycles with Graph.isAcyclic - fail if cyclic\n3. Resolve symbol refs via SymbolRegistry\n   - Look up symbol → get file path\n   - Calculate relative path from importing file\n4. Merge duplicate imports (same `from` path)\n5. Generate import AST nodes\n6. Prepend to program body\n\n## Files\n- services/imports.ts - ImportRef types\n- services/emissions.ts - Update serializeAst()","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T17:46:14.102674669-06:00","updated_at":"2026-01-06T18:07:09.291686349-06:00","closed_at":"2026-01-06T18:07:09.291686349-06:00","close_reason":"Implemented import resolution with cycle detection. FileBuilder.emit() now passes imports to emitAst(), and serializeAst() resolves symbol/package/relative imports via prependImports(). Added 11 new tests for import resolution including symbol resolution, import merging, default imports, and type imports.","labels":["core","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-7yv","depends_on_id":"pg-sourcerer-9pr","type":"parent-child","created_at":"2026-01-06T17:46:36.379454744-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-7yv","depends_on_id":"pg-sourcerer-skq","type":"blocks","created_at":"2026-01-06T17:46:45.298473493-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-7zk","title":"Plugin Runner: Use Live Inflection Instead of Stub","description":"The plugin runner currently passes `InflectionStub` to plugin contexts:\n\n```typescript\n// plugin-runner.ts line 258\ninflection: InflectionStub,  // Throws \"not implemented\"!\n```\n\nIf any plugin calls `ctx.inflection.camelCase()` etc., it will crash.\n\nFix: Accept inflection as a parameter to `run()` or use `InflectionLive` by default.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-05T21:45:43.271405572-06:00","updated_at":"2026-01-05T21:46:27.542337867-06:00","closed_at":"2026-01-05T21:46:27.542337867-06:00","close_reason":"Duplicate of pg-sourcerer-j42","labels":["core","rewrite"]}
{"id":"pg-sourcerer-85g","title":"IR Builder Service","description":"Build SemanticIR from pg-introspection output.\n\nTransforms raw introspection into:\n- Entities (tables, views, composites)\n- Shapes (row, insert, update, patch)\n- Fields with semantic properties\n- Relations from foreign keys\n- Enums\n\nRequires smart tags parser to be complete for tag extraction.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T17:22:50.795897422-06:00","updated_at":"2026-01-05T20:40:24.023099135-06:00","closed_at":"2026-01-05T20:40:24.023099135-06:00","close_reason":"Implemented IR Builder Service with 16 integration tests against real PostgreSQL database.\n\nFeatures:\n- Transforms pg-introspection output into SemanticIR\n- Builds entities (tables, views) with proper kind detection\n- Builds all 4 shapes (row, insert, update, patch) for tables, row-only for views\n- Fields include: name (camelCase), columnName (original), nullable, optional, hasDefault, isGenerated, isIdentity, isArray, elementTypeName\n- Field optionality varies by shape: row (nullable only), insert (has default/generated/nullable), update/patch (all optional)\n- Relations from FK constraints with column mappings (supports composite FKs)\n- Primary key detection (real PKs and virtual @primaryKey tags for views)\n- Smart tags parsed from comments for all entities/fields/constraints\n- Preserves raw pg-introspection references (pgClass, pgAttribute) for plugin access\n- Tested against real example database with users, posts, views, multiple schemas","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-85g","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:22:50.797132934-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-85g","depends_on_id":"pg-sourcerer-zbb","type":"blocks","created_at":"2026-01-05T17:22:50.798032465-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-88t","title":"Update tests for new plugin patterns","description":"Update all tests to use the new Effect-native plugin patterns:\n\n1. Plugin tests should use `layer()` from @effect/vitest to provide services\n2. Remove any usage of `createStubPluginContext`\n3. Create test layer bundles for common scenarios:\n   - `TestPluginLayers` - IR, Inflection, Emissions, Symbols, TypeHints, ArtifactStore\n   - Per-test IR fixtures via `Layer.succeed(IR, testIR)`\n\nExample:\n```typescript\nconst TestLayers = Layer.mergeAll(\n  InflectionLive,\n  EmissionsLive,\n  SymbolsLive,\n  TypeHintsLive([]),\n  ArtifactStoreLive,\n)\n\nlayer(TestLayers)(\"MyPlugin tests\", (it) =\u003e {\n  it.effect(\"generates types\", () =\u003e\n    Effect.gen(function* () {\n      // Provide test IR for this specific test\n      yield* myPlugin.run(config).pipe(\n        Effect.provideService(IR, testIR)\n      )\n    })\n  )\n})\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T11:28:48.44051642-06:00","updated_at":"2026-01-06T12:32:45.523557818-06:00","closed_at":"2026-01-06T12:32:45.523557818-06:00","close_reason":"Created testing.ts with PluginTestLayers and createPluginTestLayer() utilities for plugin testing. Verified existing tests already use correct patterns - layer() for Effect services, factory functions for unit tests. No createStubPluginContext ever existed to remove.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-88t","depends_on_id":"pg-sourcerer-w1i","type":"blocks","created_at":"2026-01-06T11:28:48.454894398-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-88t","depends_on_id":"pg-sourcerer-y71","type":"blocks","created_at":"2026-01-06T11:28:48.466148139-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-88t","depends_on_id":"pg-sourcerer-qxg","type":"blocks","created_at":"2026-01-06T11:28:48.467184689-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-8by","title":"field-utils: Refactor resolveFieldType to first-match pattern","description":"Refactor resolveFieldType sequential if/Option.isSome checks to use a first-match helper that returns first Some from a list of Option producers","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:07:51.171838269-06:00","updated_at":"2026-01-07T21:24:32.440870513-06:00","closed_at":"2026-01-07T21:24:32.440870513-06:00","close_reason":"Refactored resolveFieldType to use single pipe chain with Option.orElse for first-match pattern"}
{"id":"pg-sourcerer-8g4","title":"Generate enum schemas for Effect Model plugin","description":"Generate Effect Schema enums from PostgreSQL enums.\n\nOutput format (per earlier discussion):\n```typescript\nexport const Role = S.Union(S.Literal(\"user\"), S.Literal(\"admin\"))\nexport type Role = typeof Role.Type\n```\n\nGenerate in separate file (enums.ts) and import where used.\n\nAlternative inline format for simple enums:\n```typescript\nrole: S.Union(S.Literal(\"user\"), S.Literal(\"admin\"))\n```\n\nMake configurable: separate vs inline.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T22:12:36.888119459-06:00","updated_at":"2026-01-06T22:23:32.72485765-06:00","closed_at":"2026-01-06T22:23:32.72485765-06:00","close_reason":"Implemented in effect-model.ts plugin with 22 passing tests","labels":["effect-model","enums"]}
{"id":"pg-sourcerer-8hh","title":"pg-types: Refactor getExtensionTypeMapping to use Effect patterns","description":"Refactor `getExtensionTypeMapping` to use Effect's `Arr.findFirst` and `Option.flatMap` for nested loops with early return.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T16:52:12.3002565-06:00","updated_at":"2026-01-07T18:42:36.066260816-06:00","closed_at":"2026-01-07T18:42:36.066260816-06:00","close_reason":"Superseded by pg-sourcerer-ug3 - larger Option\u003cT\u003e refactor"}
{"id":"pg-sourcerer-8ja","title":"pg-types: Refactor composeMappers to pipe pattern","description":"Refactor `composeMappers` function to use pipe() with Arr.map and Arr.findFirst instead of for...of loop with early return.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:50:36.400573651-06:00","updated_at":"2026-01-07T20:03:29.431336641-06:00","closed_at":"2026-01-07T20:03:29.431336641-06:00","close_reason":"Refactored composeMappers to use pipe with Array.findFirst and Option.flatMap"}
{"id":"pg-sourcerer-90w","title":"Plugin Runner: Use Live Inflection Instead of Stub","description":"The plugin runner currently passes `InflectionStub` to plugin contexts:\n\n```typescript\n// plugin-runner.ts line 258\ninflection: InflectionStub,  // Throws \"not implemented\"!\n```\n\nIf any plugin calls `ctx.inflection.camelCase()` etc., it will crash.\n\nFix: Accept inflection as a parameter to `run()` or use `InflectionLive` by default.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-05T21:45:31.502735501-06:00","updated_at":"2026-01-05T21:46:27.533436608-06:00","closed_at":"2026-01-05T21:46:27.533436608-06:00","close_reason":"Duplicate of pg-sourcerer-j42","labels":["core","rewrite"]}
{"id":"pg-sourcerer-9b3","title":"Wire permissions into buildField and buildShape functions","description":"Update `buildField` and `buildShape` to accept and populate permission data.\n\n**Update `buildField` signature:**\n```typescript\nfunction buildField(\n  attr: PgAttribute,\n  tags: SmartTags,\n  kind: ShapeKind,\n  introspection: Introspection,\n  role: PgRoles,\n  tablePerms: EntityPermissions\n): Effect.Effect\u003cField, never, Inflection\u003e\n```\n\n**Update `buildField` implementation:**\n- Call `buildFieldPermissions(introspection, attr, tablePerms, role)`\n- Add `permissions` to the returned Field object\n\n**Update `buildShape` signature:**\n```typescript\nfunction buildShape(\n  entityName: string,\n  kind: ShapeKind,\n  attributes: readonly PgAttribute[],\n  attributeTags: ReadonlyMap\u003cstring, SmartTags\u003e,\n  introspection: Introspection,\n  role: PgRoles,\n  tablePerms: EntityPermissions\n): Effect.Effect\u003cShape, never, Inflection\u003e\n```\n\n**Update `buildShape` implementation:**\n- Pass through new parameters to `buildField`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T13:05:53.513330624-06:00","updated_at":"2026-01-06T13:18:09.053344742-06:00","closed_at":"2026-01-06T13:18:09.053344742-06:00","close_reason":"Helper functions and wiring done as part of hbl parent issue","labels":["ir","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-9b3","depends_on_id":"pg-sourcerer-6g1","type":"blocks","created_at":"2026-01-06T13:06:13.149487226-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-9b3","depends_on_id":"pg-sourcerer-hbl","type":"parent-child","created_at":"2026-01-06T13:06:17.960405406-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-9gj","title":"Add CLI dependencies to package.json","description":"Add to catalog and pg-sourcerer package.json:\n- @effect/cli\n- @effect/platform-node\n- pg (runtime)\n- @types/pg (dev)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T15:06:23.071792243-06:00","updated_at":"2026-01-06T15:07:11.834905123-06:00","closed_at":"2026-01-06T15:07:11.834905123-06:00","close_reason":"Added @effect/cli, @effect/platform-node, pg, and @types/pg to catalog and package.json. Renamed package to @danielfgray/pg-sourcerer. Added bin entry.","labels":["cli","rewrite"]}
{"id":"pg-sourcerer-9ii","title":"TypeHint integration for types plugin","description":"Integrate TypeHintRegistry into the types plugin to allow user-configured type overrides.\n\nRequirements:\n- Query TypeHints.getHint(field, 'tsType') for each field before default mapping\n- If user specifies a type, use it instead of computed type\n- Support custom imports: { tsType: 'UserId', import: './types.js' }\n- Add tests for type hint precedence (column \u003e table \u003e pgType)\n\nExample config:\n```typescript\ntypeHints: [\n  { match: { pgType: 'jsonb' }, hints: { tsType: 'JsonValue' } },\n  { match: { table: 'users', column: 'id' }, hints: { tsType: 'UserId', import: './types.js' } },\n]\n```\n","notes":"Blocked on import resolution - need to solve that first before TypeHint integration can work properly.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T14:40:11.299125467-06:00","updated_at":"2026-01-06T18:18:48.227624794-06:00","closed_at":"2026-01-06T18:18:48.227624794-06:00","close_reason":"TypeHint integration complete: types plugin now checks TypeHintRegistry before default resolution, supports custom imports with proper grouping by path","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-9ii","depends_on_id":"pg-sourcerer-9pr","type":"blocks","created_at":"2026-01-06T17:25:31.342855427-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-9k7","title":"Add composite type support to types plugin","description":"## Overview\n\nThe types plugin currently generates types for tables, views, and enums, but not for standalone composite types. This is needed before the sql-functions plugin can properly handle functions that return composite types.\n\n## Current State\n\n- `CompositeEntity` exists in SemanticIR with `kind: \"composite\"` and `fields` array\n- IR builder already builds composite entities from the database\n- Example DB has composites: `username_search`, `tag_search_result`\n- Types plugin does NOT generate types for composites\n\n## Required Changes\n\n### 1. Generate composite types in types plugin\n\nAdd generation for composite types alongside table/enum generation:\n\n```ts\n// For each CompositeEntity, generate an interface\ninterface TagSearchResult {\n  tag: string\n  count: number\n}\n\ninterface UsernameSearch {\n  username: string\n  avatar_url: string | null\n}\n```\n\n### 2. Export composite types\n\nEither:\n- Add to existing entity types file\n- Create separate `composites.ts` file\n\n### 3. Add capability\n\nProvide `types:composites` capability so sql-functions can depend on it.\n\n### 4. Symbol registration\n\nRegister composite types in the symbol registry so sql-functions can import them.\n\n## Files to Modify\n\n- `packages/pg-sourcerer/src/plugins/types.ts` - add composite generation\n- `packages/pg-sourcerer/src/__tests__/types-plugin.test.ts` - add tests\n\n## Acceptance Criteria\n\n- [ ] Composite types from IR are generated as TypeScript interfaces\n- [ ] Composite type fields are properly typed (scalars, enums, nullability)\n- [ ] Symbol refs work: `{ capability: \"types:composites\", entity: \"TagSearchResult\" }`\n- [ ] Tests verify composite generation with example DB composites","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-07T22:04:30.633406701-06:00","updated_at":"2026-01-07T22:14:10.80820013-06:00","closed_at":"2026-01-07T22:14:10.80820013-06:00","close_reason":"Composite types now generate in types plugin. Unified CompositeField with Field interface. All 515 tests pass."}
{"id":"pg-sourcerer-9kz","title":"Consolidate test layers - merge InflectionLive, TypeHintsLive, PluginRunner.Default into a single TestLayer","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T10:28:08.874437484-06:00","updated_at":"2026-01-07T11:23:57.016220193-06:00","closed_at":"2026-01-07T11:23:57.016220193-06:00","close_reason":"Added InflectionLive to PluginRunner.Default dependencies. Tests use PluginRunner.Default directly (or DefaultWithoutDependencies for custom inflection). Added PluginRunnerTestLayer to testing.ts."}
{"id":"pg-sourcerer-9pr","title":"FileBuilder + Symbol-Based Import Resolution","description":"Add ImportCollector service for deferred import resolution. Plugins request imports during execution, resolution happens after all plugins run during AST serialization.\n\n## Superseded by FileBuilder Design\n\nThis evolved into a larger redesign - see child tasks for the full plan.","design":"```typescript\ntype ImportRef =\n  | { kind: \"symbol\"; ref: SymbolRef }\n  | { kind: \"package\"; names: string[]; types?: string[]; from: string }\n  | { kind: \"relative\"; names: string[]; types?: string[]; from: string }\n\ninterface ImportCollector {\n  readonly request: (forFile: string, ref: ImportRef) =\u003e void\n  readonly getRequests: (forFile: string) =\u003e readonly ImportRef[]\n  readonly getFiles: () =\u003e readonly string[]\n}\n```\n\nResolution flow:\n1. Plugins call ctx.imports.request(filePath, ref)\n2. After all plugins run, serializeAst() resolves requests\n3. Symbol refs resolved via SymbolRegistry.importFor()\n4. Import AST nodes prepended to program body","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-06T17:25:27.768801488-06:00","updated_at":"2026-01-06T18:11:12.700454601-06:00","closed_at":"2026-01-06T18:11:12.700454601-06:00","close_reason":"FileBuilder + Symbol-Based Import Resolution epic complete. Implemented: FileBuilder fluent API, exp.* export helpers with symbol metadata, import resolution in serializeAst(), symbol-based cross-file imports, and migrated both types and zod plugins to use the new APIs.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-9w0","title":"pg-types: Refactor getExtensionTypeMapping to pipe pattern","description":"Refactor getExtensionTypeMapping for...of with 3-level nested if to use pipe with Array.findFirst and Option chain","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:04:05.453146461-06:00","updated_at":"2026-01-07T20:05:59.65747066-06:00","closed_at":"2026-01-07T20:05:59.65747066-06:00","close_reason":"Refactored getExtensionTypeMapping: for...of with 3-level nested if → pipe with Array.findFirst + Option.flatMap chain"}
{"id":"pg-sourcerer-a06","title":"Add Unit Tests for Inflection Service","description":"The live inflection implementation exists but has no dedicated unit tests:\n\n- `camelCase` / `pascalCase` (delegates to Effect String)\n- `pluralize` / `singularize` (naive implementation)\n- `safeIdentifier` (reserved word handling)\n- `entityName` / `shapeName` / `fieldName` / `enumName`\n- `relationName` (FK constraint → relation name)\n\nAdd tests for edge cases:\n- Reserved words: `class`, `type`, `default`\n- Pluralization: `person` → `people`? (currently naive)\n- Snake case with numbers: `user_v2` → `userV2`\n- Already camelCase input","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T21:45:55.881766831-06:00","updated_at":"2026-01-06T12:02:25.664111987-06:00","closed_at":"2026-01-06T12:02:25.664111987-06:00","close_reason":"42 inflection tests + 16 emissions tests added, all passing","labels":["core","rewrite","testing"]}
{"id":"pg-sourcerer-a1i","title":"Implement PostgreSQL to Effect Schema type mapping","description":"Map PostgreSQL types to Effect Schema types.\n\nMappings:\n- uuid → S.UUID\n- text/varchar/citext → S.String (configurable default)\n- boolean → S.Boolean\n- int2/int4/integer → S.Number (or S.Int?)\n- int8/bigint → S.BigInt\n- timestamp/timestamptz → S.Date\n- date → S.Date\n- jsonb/json → S.Unknown (or configurable)\n- arrays → S.Array(elementSchema)\n- enums → S.Union(S.Literal(...), ...)\n\nSupport TypeHints override via tsType/schemaType hints.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T22:12:26.796483883-06:00","updated_at":"2026-01-06T22:23:32.721483789-06:00","closed_at":"2026-01-06T22:23:32.721483789-06:00","close_reason":"Implemented in effect-model.ts plugin with 22 passing tests","labels":["effect-model","types"]}
{"id":"pg-sourcerer-afn","title":"Add tests for Index representation in SemanticIR","description":"Test that indexes are correctly captured in SemanticIR.\n\n## Test Cases\n\n### Unit Tests (ir-builder)\n- Table with single-column btree index → IndexDef populated\n- Table with composite index → columns in correct order\n- Unique index → isUnique: true\n- Primary key → isPrimary: true, isUnique: true\n- Partial index → isPartial: true, predicate populated\n- GIN/GIST indexes → method captured correctly\n- Expression index → hasExpressions: true, expression columns as null\n\n### Integration Tests (example DB)\nVerify against known indexes in example database:\n- `users.idx_users_username` - btree, single column\n- `users.idx_users_username_trgm` - gin with operator class\n- `user_emails.uniq_user_emails_verified_email` - unique partial\n- `posts` indexes - gin on array, gist on tsvector\n- `posts_votes` - composite primary key\n\n### Edge Cases\n- Table with no indexes (should have empty array, not undefined)\n- View (indexes don't apply)\n- Index on expression only (no column names)","status":"closed","priority":1,"issue_type":"task","assignee":"dan","created_at":"2026-01-07T11:44:04.039711332-06:00","updated_at":"2026-01-07T12:21:42.438350587-06:00","closed_at":"2026-01-07T12:21:42.438350587-06:00","close_reason":"Added 11 integration tests for Index representation in SemanticIR, covering btree, gin, gist, unique, partial, composite indexes, and views. Tests verified against real example database.","comments":[{"id":2,"issue_id":"pg-sourcerer-afn","author":"dan","text":"Planning tests for SemanticIR indexes using fixture data; need unit coverage for builder edge cases.","created_at":"2026-01-07T18:03:55Z"}]}
{"id":"pg-sourcerer-an1","title":"Plugin Runner: Implement run() and duplicate detection","description":"Complete the plugin-runner.ts implementation:\n1. Add duplicate plugin detection to prepare()\n2. Implement run() method to execute plugins with PluginContext","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T19:40:58.33664391-06:00","updated_at":"2026-01-05T19:44:50.991054105-06:00","closed_at":"2026-01-05T19:44:50.991054105-06:00","close_reason":"Implemented plugin-runner.ts: added duplicate plugin detection to prepare(), implemented run() method that executes plugins sequentially with shared artifacts/emissions/symbols. All 38 tests pass.","labels":["phase-1","rewrite"]}
{"id":"pg-sourcerer-auk7","title":"Add integration tests for function wrapper generation","description":"Test function wrapper generation against the example database.\n\n## Test cases\n\n1. **Scalar function** - `current_user_id()` returns uuid\n2. **Single row return** - `current_user()` returns users row\n3. **SETOF table** - `posts_with_tags(text[])` returns SETOF posts\n4. **SETOF composite** - `search_tags(text)` returns SETOF tag_search_result\n5. **Volatile function** - `verify_email(uuid, text)` returns boolean\n6. **Function with optional args** - if any exist in example DB\n7. **Filtered out functions** - verify trigger functions, row-arg functions are skipped\n\n## Test structure\n- Use existing integration test pattern with example DB\n- Verify generated output matches expected patterns\n- Check imports are correct\n- Check namespace assignment (queries vs mutations)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-08T22:26:31.99770955-06:00","created_by":"dan","updated_at":"2026-01-08T22:26:31.99770955-06:00","dependencies":[{"issue_id":"pg-sourcerer-auk7","depends_on_id":"pg-sourcerer-hykf","type":"blocks","created_at":"2026-01-08T22:26:32.017953291-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-auk7","depends_on_id":"pg-sourcerer-ds3a","type":"blocks","created_at":"2026-01-08T22:26:41.009759215-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-b0a","title":"ir-builder: Refactor computeEntityPermissions to Array.reduce","description":"Refactor `computeEntityPermissions` (lines 133-145) to use Array.reduce instead of for...of with side effects.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:50:38.00684774-06:00","updated_at":"2026-01-07T20:03:32.695281693-06:00","closed_at":"2026-01-07T20:03:32.695281693-06:00","close_reason":"Refactored computeEntityPermissions to use Array.reduce instead of for...of with mutation"}
{"id":"pg-sourcerer-b2n","title":"Plugin Runner Core Infrastructure","description":"Build the core plugin runner infrastructure for pg-sourcerer rewrite. This is Phase 1 of the rewrite - establishing the Effect-ts based service layer with stubs, then implementing via RED-GREEN-REFACTOR.\n\nSee ARCHITECTURE.md for full design and packages/sourcerer-rewrite/AGENTS.md for implementation notes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-05T17:22:37.781529599-06:00","updated_at":"2026-01-05T17:23:38.413587315-06:00","closed_at":"2026-01-05T17:23:38.413587315-06:00","close_reason":"Initial stubs and wiring complete. All services defined with Context.Tag, stub layers created, tests passing (9/9). See packages/sourcerer-rewrite/","labels":["phase-1","rewrite"]}
{"id":"pg-sourcerer-bf0","title":"Add build script for compiled JS output","description":"Add a `build` script to package.json that runs `tsc` to compile TypeScript to JavaScript. Currently the package only has raw .ts files which won't work for non-Bun consumers. Output should go to `dist/` directory.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:55:35.561343333-06:00","updated_at":"2026-01-07T11:00:32.976365364-06:00","closed_at":"2026-01-07T11:00:32.976365364-06:00","close_reason":"Added `build` script that runs tsc. Also added `clean` and `prepublishOnly` scripts. Excluded __tests__ from tsconfig build.","labels":["p0","publish"],"dependencies":[{"issue_id":"pg-sourcerer-bf0","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:07.429766117-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bk6","title":"Effect Schema Plugin","description":"Generate Effect Schema definitions for each entity's shapes.\n\nOutput example for User entity:\n```typescript\nimport { Schema as S } from \"effect\"\n\nexport class UserRow extends S.Class\u003cUserRow\u003e(\"UserRow\")({\n  id: S.UUID,\n  username: S.String,\n  name: S.NullOr(S.String),\n  createdAt: S.Date,\n}) {}\n\nexport class UserInsert extends S.Class\u003cUserInsert\u003e(\"UserInsert\")({\n  id: S.optional(S.UUID),\n  username: S.String,\n  name: S.optional(S.NullOr(S.String)),\n}) {}\n```\n\nRequirements:\n- provides: [\"schemas:effect\", \"schemas\"]\n- Generate S.Class or S.Struct for each shape\n- Map pg types to Effect Schema (uuid→S.UUID, etc.)\n- Handle nullable (S.NullOr) vs optional (S.optional)\n- Support arrays (S.Array)\n- Support enums (S.Literal union or S.Enums)\n- Respect smart tags\n- Query TypeHintRegistry for custom schemas\n- Register symbols for import resolution\n\nNote: Research the best Effect Schema patterns for this use case.","notes":"Deferred - Focus on Kysely first. Can implement later for Effect-based projects.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T21:41:30.447175078-06:00","updated_at":"2026-01-07T10:41:00.795709825-06:00","closed_at":"2026-01-07T10:41:00.795709825-06:00","close_reason":"Redundant - effect-model plugin already generates Effect Schema via @effect/sql Model.Class. Users needing pure schemas without @effect/sql can extract types from the model.","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bk6","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:30.466450499-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bok","title":"Create PluginMeta service","description":"Create a `PluginMeta` service that provides the current plugin's name and metadata.\n\nThis replaces `ctx.pluginName`. Needed for:\n- Logging (prefix messages with plugin name)\n- Artifact attribution\n- Emission tracking\n\n```typescript\ninterface PluginMeta {\n  readonly name: string\n  // Future: version, etc.\n}\n\nexport class PluginMetaSvc extends Context.Tag(\"PluginMeta\")\u003cPluginMetaSvc, PluginMeta\u003e() {}\n```\n\nLayer created per-plugin by PluginRunner before executing each plugin.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T11:27:52.535017086-06:00","updated_at":"2026-01-06T11:34:44.802174689-06:00","closed_at":"2026-01-06T11:34:44.802174689-06:00","close_reason":"Created PluginMeta service as Context.Tag in src/services/plugin-meta.ts. Simple value service providing plugin name. Layer created per-plugin with Layer.succeed(PluginMeta, { name }).","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bok","depends_on_id":"pg-sourcerer-ilk","type":"blocks","created_at":"2026-01-06T11:27:52.548897114-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-boq","title":"Fix double-cleaning bug in composeInflection relationName","description":"In `composeInflection`, the `relationName` function cleans the constraint name (removing `_fkey`, `_id`, and table prefix), then calls `baseInflection.relationName` which cleans it AGAIN.\n\nExample:\n- Input: `posts_user_info_fkey`\n- After first clean: `user_info`\n- Plugin transform (e.g., lowercase): `user_info`  \n- Passed to base relationName which cleans again: `info`\n- Final result: `info` (wrong - should be `userInfo` with camelCase base)\n\nThe comment on line 510 acknowledges this: 'Base would also clean, but we already cleaned' - but then it still calls the base's relationName which does clean again.\n\n**Fix options:**\n1. Create a helper that applies just the transform without cleaning\n2. Pass a flag to skip cleaning on subsequent calls\n3. Restructure relationName to separate cleaning from transformation\n\nSee failing test in `inflection.test.ts` under `composeInflection \u003e relationName composition \u003e composes with base that has camelCase`","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-07T13:23:46.021310458-06:00","updated_at":"2026-01-07T13:45:05.979215476-06:00","closed_at":"2026-01-07T13:45:05.979215476-06:00","close_reason":"Fixed by removing the double-cleaning problem entirely. relationName is now just a simple string→string transform, so composition works naturally without any cleaning logic to conflict.","dependencies":[{"issue_id":"pg-sourcerer-boq","depends_on_id":"pg-sourcerer-pj1","type":"discovered-from","created_at":"2026-01-07T13:27:35.354257174-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-boq","depends_on_id":"pg-sourcerer-gzj","type":"blocks","created_at":"2026-01-07T13:33:37.356701001-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bsq","title":"Plugin Runner Capability Resolution","description":"Implement PluginRunner capability resolution:\n\n1. Collect all provides/requires from plugins\n2. Expand implicit provisions (schemas:zod → also provides schemas)\n3. Check for conflicts (same capability from multiple plugins)\n4. Check all requires are satisfied\n5. Topological sort (error on cycles)\n6. Execute plugins in sorted order\n\nCurrently stubbed - prepare() and run() return stub errors.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T17:23:03.184670503-06:00","updated_at":"2026-01-05T18:02:45.541040642-06:00","closed_at":"2026-01-05T18:02:45.541040642-06:00","close_reason":"Implemented plugin runner capability resolution with idiomatic Effect patterns: HashMap for providers, Effect.reduce for single-pass validation, Graph module for topo sort and cycle detection. All 8 tests pass.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bsq","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:03.186612366-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bt7","title":"Phase 2: Base Plugins","description":"Implement the first set of code generation plugins that use the Phase 1 infrastructure.\n\nPlugins to build:\n1. Types plugin - generates TypeScript interfaces for entities\n2. Effect Schema plugin - generates Effect Schema definitions + inferred types\n3. Zod plugin - generates Zod schemas + inferred types\n\nEach plugin should:\n- Declare capabilities (provides: \"types\", \"schemas:effect\", \"schemas:zod\")\n- Use PluginContext to emit files\n- Register symbols for cross-file imports\n- Respect smart tags (@omit, @name, @type)\n- Query TypeHintRegistry for user overrides\n- Handle all field types (scalars, arrays, enums, nullable)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-05T21:41:09.54899253-06:00","updated_at":"2026-01-06T14:45:27.132015759-06:00","closed_at":"2026-01-06T14:45:27.132015759-06:00","close_reason":"Phase 2 complete: Types plugin implemented with full type mapping (domains, enums, arrays, extensions). Effect Schema and Zod plugins now unblocked. Kysely plugins moved to separate epic.","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bt7","depends_on_id":"pg-sourcerer-d7s","type":"blocks","created_at":"2026-01-05T21:46:41.165089426-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bwx","title":"Call symbols.validate() After Plugin Execution","description":"`SymbolRegistry.validate()` exists to detect collisions (same symbol name in same file from different plugins), but nothing ever calls it:\n\n```typescript\n// symbols.ts - validate() defined\nreadonly validate: () =\u003e readonly SymbolCollision[]\n\n// plugin-runner.ts - never called!\n```\n\nAfter all plugins execute, should call `symbols.validate()` and fail if collisions found.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:50.337289998-06:00","updated_at":"2026-01-06T10:09:41.347129501-06:00","closed_at":"2026-01-06T10:09:41.347129501-06:00","close_reason":"run() now automatically validates emissions and symbols after plugin execution. Fails with EmitConflict or SymbolConflict errors.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-bxf","title":"Conjure export helpers with symbol metadata","description":"Add `exp.*` helpers to conjure that produce exports with symbol metadata attached.\n\n## API\n```typescript\nconst { exp, program, ts } = conjure\n\nexp.interface(\"UserRow\", { capability: \"types\", entity: \"User\", shape: \"row\" }, [...props])\nexp.typeAlias(\"Role\", { capability: \"types\", entity: \"Role\" }, ts.union(...))\nexp.const(\"UserRow\", { capability: \"schemas:zod\", entity: \"User\", shape: \"row\" }, zodExpr)\nexp.type(\"UserRow\", { capability: \"schemas:zod\", entity: \"User\", shape: \"row\" }, ts.infer(...))\n```\n\n## Types\n```typescript\ninterface SymbolStatement {\n  readonly _tag: \"SymbolStatement\"\n  readonly node: n.Statement\n  readonly symbol: SymbolMeta\n}\n\ninterface SymbolMeta {\n  readonly name: string\n  readonly capability: CapabilityKey\n  readonly entity: string\n  readonly shape?: string\n  readonly isType: boolean\n  readonly isDefault?: boolean\n}\n\ninterface SymbolProgram {\n  readonly _tag: \"SymbolProgram\"\n  readonly node: n.Program\n  readonly symbols: readonly SymbolMeta[]\n}\n```\n\n## Also add\n- `ts.infer(type)` - produces `z.infer\u003cT\u003e`\n- `ts.typeOf(name)` - produces `typeof X`\n- Update `program()` to extract symbols from SymbolStatements","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T17:45:59.207999953-06:00","updated_at":"2026-01-06T17:53:41.096279847-06:00","closed_at":"2026-01-06T17:53:41.096279847-06:00","close_reason":"Added exp.* helpers (interface, typeAlias, const, type) and symbolProgram() to conjure.ts. All 363 tests pass.","labels":["conjure","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bxf","depends_on_id":"pg-sourcerer-9pr","type":"parent-child","created_at":"2026-01-06T17:46:34.510045705-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-c5g","title":"Update effect-model plugin to handle unified Entity","description":"Refactor effect-model.ts to iterate ir.entities and switch on entity.kind. Enums use same outputFile inflection. Remove hardcoded enums.ts path.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T14:23:15.244344516-06:00","updated_at":"2026-01-07T14:30:37.848916457-06:00","closed_at":"2026-01-07T14:30:37.848916457-06:00","close_reason":"Effect-model plugin now uses getEnumEntities() and getTableEntities(). Each enum gets its own file via outputFile inflection. Uses pgName instead of tableName.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-c5g","depends_on_id":"pg-sourcerer-6w8","type":"blocks","created_at":"2026-01-07T14:23:24.927766818-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ccd","title":"sql-queries: Missing Promise wrapper on async return types","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-07T16:11:23.989418112-06:00","updated_at":"2026-01-07T20:27:31.993743603-06:00","closed_at":"2026-01-07T20:27:31.993743603-06:00","close_reason":"Already implemented: Return types use Promise\u003c\u003e wrapper. Fixed tsTypeParameterInstantiation compatibility issue with toTSType cast."}
{"id":"pg-sourcerer-cdb","title":"PostgreSQL to TypeScript Type Mapping Utility","description":"Create a shared utility for mapping PostgreSQL types to TypeScript types.\n\nThis is used by multiple plugins and should be extracted to avoid duplication.\n\n```typescript\ninterface PgTypeMapping {\n  // Map pg type name to TS type\n  toTypeScript(pgTypeName: string, options?: { nullable?: boolean, array?: boolean }): string\n  \n  // Map pg type to Zod schema expression\n  toZod(pgTypeName: string, options?: { nullable?: boolean, array?: boolean }): string\n  \n  // Map pg type to Effect Schema expression  \n  toEffectSchema(pgTypeName: string, options?: { nullable?: boolean, array?: boolean }): string\n}\n\n// Example mappings:\n// uuid → string / z.string().uuid() / S.UUID\n// text → string / z.string() / S.String\n// integer → number / z.number().int() / S.Int\n// boolean → boolean / z.boolean() / S.Boolean\n// timestamptz → Date / z.coerce.date() / S.Date\n// jsonb → unknown / z.unknown() / S.Unknown\n// text[] → string[] / z.array(z.string()) / S.Array(S.String)\n```\n\nRequirements:\n- Handle common pg types (text, varchar, int, bigint, uuid, boolean, date, timestamp, timestamptz, jsonb, json)\n- Handle arrays\n- Handle domains (unwrap to base type)\n- Extensible for custom types via TypeHintRegistry\n- Well-tested with comprehensive type coverage","notes":"**Kysely additions needed:**\n- Add `toKysely()` method that returns Kysely type expressions\n- Handle `Generated\u003cT\u003e` for columns with defaults/identity\n- Handle `ColumnType\u003cSelect, Insert, Update\u003e` for complex cases (e.g., timestamptz as Date on select, string on insert)\n\nExample mappings:\n- `uuid` → `string` (base) / `Generated\u003cstring\u003e` (if has default)\n- `timestamptz` → `Date` (select) / `string | Date` (insert)\n- `serial/bigserial` → `Generated\u003cnumber\u003e` / `Generated\u003cbigint\u003e`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:41:39.053018429-06:00","updated_at":"2026-01-06T13:33:31.04650618-06:00","closed_at":"2026-01-06T13:33:31.04650618-06:00","close_reason":"Implemented pg-types.ts with PgTypeOid constants, defaultPgToTs mapper, composeMappers for plugin overrides, and wrapArrayType/wrapNullable helpers. Core provides sane defaults that plugins can override using composeMappers pattern.","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-cdb","depends_on_id":"pg-sourcerer-bt7","type":"parent-child","created_at":"2026-01-06T13:03:01.759503606-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-cfn","title":"Add bin entry to package.json","description":"Add bin field to packages/pg-sourcerer/package.json pointing to CLI entry point","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T15:06:30.409692803-06:00","updated_at":"2026-01-06T15:13:47.27947894-06:00","closed_at":"2026-01-06T15:13:47.27947894-06:00","close_reason":"bin entry was added as part of pg-sourcerer-9gj package.json update","labels":["cli","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-cfn","depends_on_id":"pg-sourcerer-7e6","type":"blocks","created_at":"2026-01-06T15:06:35.3341294-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-cm89","title":"Add formatter hook for post-generation code formatting","description":"Allow users to provide a formatter callback in config that transforms generated code before writing to disk. Callback signature: (content: string, filepath: string) =\u003e Promise\u003cstring\u003e | string. Errors are hard failures. ~25 lines of code.","acceptance_criteria":"- Config accepts optional formatter callback\n- Formatter runs on all emissions after AST serialization, before file write\n- FormatError added for failures\n- Format errors fail generation (not soft fail)\n- Parallel formatting with concurrency limit","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-08T11:30:15.985183861-06:00","created_by":"dan","updated_at":"2026-01-08T11:41:05.448196518-06:00","closed_at":"2026-01-08T11:41:05.448196518-06:00","close_reason":"Implemented formatter hook: config accepts `formatter` string (CLI command), runs after file write using @effect/platform Command API. Errors are hard failures via FormatError. Tests updated."}
{"id":"pg-sourcerer-cta","title":"ir-builder: Refactor getTypeName to use Option pattern","description":"Refactor `getTypeName` to use `Option.fromNullable` and `Option.map` instead of nested ternary null checks.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T16:52:14.113405809-06:00","updated_at":"2026-01-07T18:42:37.191598344-06:00","closed_at":"2026-01-07T18:42:37.191598344-06:00","close_reason":"Superseded by pg-sourcerer-ug3 - larger Option\u003cT\u003e refactor"}
{"id":"pg-sourcerer-d4x","title":"Write Effect Model plugin tests","description":"Create comprehensive test suite for Effect Model plugin.\n\nTest cases:\n- Basic entity with all field types\n- Generated/identity fields excluded from insert\n- Fields with defaults are optional on insert\n- Nullable fields use S.NullOr\n- RLS permissions shape variants correctly\n- Sensitive tag excludes from json variants\n- Insert optionality overrides work\n- Enum generation (inline and separate)\n- TypeHints override type mapping\n\nUse fixture introspection data like other plugin tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T22:12:40.726082581-06:00","updated_at":"2026-01-06T22:23:32.726553065-06:00","closed_at":"2026-01-06T22:23:32.726553065-06:00","close_reason":"Implemented in effect-model.ts plugin with 22 passing tests","labels":["effect-model","testing"]}
{"id":"pg-sourcerer-d7s","title":"Core Integration Test - Full Pipeline","description":"Write an integration test that exercises the complete core pipeline:\n\n1. Build IR from test introspection fixture\n2. Prepare plugins (capability resolution, ordering)\n3. Run plugins (they emit code, register symbols)\n4. Validate emissions (no conflicts)\n5. Validate symbols (no collisions)\n6. Write files (or dry-run)\n\nThis test will:\n- Prove the components work together\n- Force resolution of API shape questions\n- Catch missing handoffs between components\n- Serve as documentation of intended usage\n\nThe test should use a simple mock plugin that emits files, not a real plugin.\n\nCurrently blocked by: plugin runner doesn't return emissions, inflection is a stub, etc.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:11.83692399-06:00","updated_at":"2026-01-06T11:58:46.207096804-06:00","closed_at":"2026-01-06T11:58:46.207096804-06:00","close_reason":"Core integration test complete: 6 tests covering full pipeline (IR build → plugin prep → run → validate → write), artifact passing, and error cases","labels":["core","rewrite","testing"],"dependencies":[{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-zgf","type":"blocks","created_at":"2026-01-05T21:46:37.266281445-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-j42","type":"blocks","created_at":"2026-01-05T21:46:37.295233151-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-2pv","type":"blocks","created_at":"2026-01-05T21:46:37.321227-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-bwx","type":"blocks","created_at":"2026-01-05T21:46:37.345656963-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-dje","title":"Types Plugin - TypeScript Interfaces","description":"Generate TypeScript interfaces for each entity's shapes.\n\nOutput example for User entity:\n```typescript\nexport interface UserRow {\n  id: string\n  username: string\n  name: string | null\n  createdAt: Date\n}\n\nexport interface UserInsert {\n  id?: string\n  username: string\n  name?: string | null\n}\n\nexport interface UserUpdate {\n  id?: string\n  username?: string\n  name?: string | null\n}\n```\n\nRequirements:\n- Generate Row, Insert, Update, Patch shapes for tables\n- Generate only Row shape for views\n- Handle nullable vs optional correctly per shape\n- Map PostgreSQL types to TypeScript (uuid→string, timestamptz→Date, etc.)\n- Support arrays (text[]→string[])\n- Support enums (generate enum types)\n- Respect @omit tags (skip fields/entities)\n- Respect @name tags (rename)\n- Query TypeHintRegistry for custom type mappings\n- Register symbols for cross-plugin imports\n- Emit to configurable output directory","notes":"Deferred - Kysely types plugin covers this need. Can implement later for users who want plain TS types without Kysely.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T21:41:19.084255688-06:00","updated_at":"2026-01-06T14:38:31.763105565-06:00","closed_at":"2026-01-06T14:38:31.763105565-06:00","close_reason":"Implemented in src/plugins/types.ts - generates Row/Insert/Update/Patch interfaces, handles domains, enums, arrays, nullable/optional, @omit/@name tags, symbol registration. TypeHintRegistry integration can be added as enhancement.","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-dje","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:19.104708801-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-dkt","title":"sql-queries: Missing sql template tag import","notes":"Found: Line 376 uses `symbols:` instead of `names:` for RelativeImportRef. TypeScript catches this: 'symbols' does not exist in type 'RelativeImportRef'","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-07T16:11:22.78398061-06:00","updated_at":"2026-01-07T20:27:18.08670146-06:00","closed_at":"2026-01-07T20:27:18.08670146-06:00","close_reason":"Fixed: Changed `symbols:` to `names:` in RelativeImportRef for sql template tag import"}
{"id":"pg-sourcerer-dpp","title":"Define new Effect-native Plugin interface","description":"Define the new Effect-native Plugin interface where `run` returns an Effect with service requirements in the type.\n\n```typescript\n// Services available to all plugins\ntype PluginServices = IR | Inflection | Emissions | Symbols | TypeHints | ArtifactStoreSvc | PluginMetaSvc\n\ninterface Plugin\u003cTConfig = unknown\u003e {\n  readonly name: string\n  readonly requires?: readonly CapabilityKey[]\n  readonly provides: readonly CapabilityKey[]\n  readonly configSchema: S.Schema\u003cTConfig, unknown\u003e\n  readonly inflection: PluginInflection\n  \n  // New signature: no ctx parameter, services come from Effect context\n  readonly run: (config: TConfig) =\u003e Effect.Effect\u003cvoid, PluginExecutionFailed, PluginServices\u003e\n}\n```\n\nPlugins yield the services they need:\n```typescript\nrun: (config) =\u003e Effect.gen(function* () {\n  const ir = yield* IR\n  const emissions = yield* Emissions\n  // ...\n})\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T11:28:05.922482108-06:00","updated_at":"2026-01-06T11:37:08.105747525-06:00","closed_at":"2026-01-06T11:37:08.105747525-06:00","close_reason":"Created new Effect-native Plugin interface in src/services/plugin.ts. Key change: `run: (config) =\u003e Effect\u003cvoid, E, Services\u003e` - no ctx parameter, plugins yield services from Effect context. Also exports PluginInflection, PluginServices, ConfiguredPlugin types.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-dpp","depends_on_id":"pg-sourcerer-vvw","type":"blocks","created_at":"2026-01-06T11:28:05.93715052-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-dpp","depends_on_id":"pg-sourcerer-mj8","type":"blocks","created_at":"2026-01-06T11:28:05.949390541-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-dpp","depends_on_id":"pg-sourcerer-bok","type":"blocks","created_at":"2026-01-06T11:28:05.95103818-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-drn","title":"Plugin Runner: Accept TypeHints from Config","description":"TypeHints registry is hardcoded to empty:\n\n```typescript\n// plugin-runner.ts line 249\nconst typeHints = emptyTypeHintRegistry  // User config ignored!\n```\n\nThe runner should accept `TypeHint[]` from config and create a real registry via `createTypeHintRegistry(hints)`.\n\nThis allows users to configure type overrides as designed in ARCHITECTURE.md.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:39.02615082-06:00","updated_at":"2026-01-06T12:22:57.216272573-06:00","closed_at":"2026-01-06T12:22:57.216272573-06:00","close_reason":"PluginRunner.run() now yields TypeHints from context instead of using hardcoded emptyTypeHintRegistry. Tests updated with TypeHintsLive([]) in their layers.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-ds3a","title":"Add functions generation to kysely-queries plugin","description":"Wire up function generation in the kysely-queries plugin.\n\n## Config additions\n```typescript\nconst KyselyQueriesPluginConfig = S.Struct({\n  // ... existing ...\n  generateFunctions: S.optionalWith(S.Boolean, { default: () =\u003e true }),\n  functionsFile: S.optionalWith(S.String, { default: () =\u003e \"functions.ts\" }),\n})\n```\n\n## Plugin run() changes\n1. If `generateFunctions` is false, skip\n2. Get all functions via `getFunctionEntities(ctx.ir)`\n3. Filter using the filtering utility\n4. Split into queries/mutations by volatility\n5. Generate wrapper for each function\n6. Build namespace objects\n7. Emit to `{outputDir}/{functionsFile}`\n\n## Imports\n- `Kysely` from `'kysely'` (type)\n- `DB` from dbTypesPath\n- Table/composite types as needed from dbTypesPath\n\n## Output structure\n```typescript\nexport const queries = { ... } as const\nexport const mutations = { ... } as const\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T22:26:26.500318262-06:00","created_by":"dan","updated_at":"2026-01-08T22:53:31.931818741-06:00","closed_at":"2026-01-08T22:53:31.931818741-06:00","close_reason":"Wiring already in place - simplified to emit flat statements from generateFunctionWrapper","dependencies":[{"issue_id":"pg-sourcerer-ds3a","depends_on_id":"pg-sourcerer-hykf","type":"blocks","created_at":"2026-01-08T22:26:26.522905446-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-ds3a","depends_on_id":"pg-sourcerer-fdiw","type":"blocks","created_at":"2026-01-08T22:26:40.373705652-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-e12","title":"ir-builder: Refactor getPrimaryKeyConstraint to Arr.findFirst","description":"Refactor `getPrimaryKeyConstraint` (lines 330-333) to use pipe with Arr.findFirst instead of Array.find.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:50:39.309426024-06:00","updated_at":"2026-01-07T21:24:28.596097071-06:00","closed_at":"2026-01-07T21:24:28.596097071-06:00","close_reason":"Refactored getPrimaryKeyConstraint to use pipe + Arr.findFirst + Option.getOrUndefined"}
{"id":"pg-sourcerer-een","title":"Add LICENSE file (MIT)","description":"Add an MIT LICENSE file to the repository root. Required for open source publication.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:55:32.746919366-06:00","updated_at":"2026-01-07T11:04:38.388521167-06:00","closed_at":"2026-01-07T11:04:38.388521167-06:00","close_reason":"Added MIT LICENSE file at repo root with credit to Benjie Gillam / graphile-crystal for inspiration.","labels":["p0","publish"],"dependencies":[{"issue_id":"pg-sourcerer-een","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:06.270773064-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-esj","title":"Symbol Registry Import Resolution","description":"Implement relative import path calculation in SymbolRegistry.importFor():\n\n- Calculate relative path from importer to importee\n- Add .js extension for ESM\n- Separate type imports from value imports\n- Handle same directory vs parent directory\n\nCurrent implementation is naive stub.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:14.311590952-06:00","updated_at":"2026-01-05T21:23:58.230286487-06:00","closed_at":"2026-01-05T21:23:58.230286487-06:00","close_reason":"Implemented relative import path calculation in SymbolRegistry.importFor(). Handles: same directory (./), sibling directories (../), nested paths, common parent directories, .ts to .js extension conversion. Separates type imports, named imports, and default exports. 22 tests covering all path calculation scenarios and import types.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-esj","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:14.312838243-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-eyv","title":"Update README with current API documentation","description":"The current README is outdated - references old API like `makeTypesPlugin`, `makeZodSchemasPlugin`, `makeQueriesPlugin`. Update to document:\n- Installation instructions\n- Current plugin names: `typesPlugin`, `zodPlugin`, `effectModelPlugin`\n- `defineConfig` usage\n- CLI usage (`pgsourcerer generate`)\n- Basic example configuration\n- Smart tags documentation","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:55:41.910068156-06:00","updated_at":"2026-01-07T11:06:04.103724491-06:00","closed_at":"2026-01-07T11:06:04.103724491-06:00","close_reason":"Rewrote README with: installation, quick start with defineConfig example, CLI usage, plugin table, smart tags examples, type hints config, and development instructions.","labels":["docs","p1","publish"],"dependencies":[{"issue_id":"pg-sourcerer-eyv","depends_on_id":"pg-sourcerer-p1l","type":"parent-child","created_at":"2026-01-07T10:57:10.803594912-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ezj","title":"Refactor TypeHintRegistry.getHint() to return Option\u003cT\u003e","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T19:09:28.852191125-06:00","updated_at":"2026-01-07T21:17:01.673354402-06:00","closed_at":"2026-01-07T21:17:01.673354402-06:00","close_reason":"Duplicate of pg-sourcerer-vcg"}
{"id":"pg-sourcerer-f4ha","title":"Add pgsourcerer init CLI command","description":"Interactive config generator using @effect/cli Prompt. Prompts for connection string, schemas, output dir, plugins, inflection, formatter. Tests connection before writing. Generates pgsourcerer.config.ts with proper imports.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-08T12:21:07.560807312-06:00","created_by":"dan","updated_at":"2026-01-08T12:25:45.929199899-06:00","closed_at":"2026-01-08T12:25:45.929199899-06:00","close_reason":"Init command fully implemented with prompts, connection testing, config generation, and overwrite protection"}
{"id":"pg-sourcerer-fav","title":"Add file path inflection to plugin config","description":"File paths in generated output should be configurable through inflection, not just entity/field names. For example, users might want 'User.ts' vs 'user.ts' vs 'users.ts'. This should compose with plugin defaults just like entity names do.","design":"## Design: fileName via Effect Context (DI)\n\n### Principle\nConfig stays pure/immutable data. Derived behavior accessed via Effect context.\n\n### Architecture\n1. **Config = pure data**: `{ outputDir: \"models\", enumStyle: \"separate\" }`\n2. **fileName lives in plugin definition**: `inflection.outputFile` (already updated)\n3. **Plugin runner provides via context**: Add `pluginInflection` to `SimplePluginContext`\n\n### SimplePluginContext addition\n```typescript\ninterface SimplePluginContext {\n  // ... existing ...\n  \n  /** Plugin's inflection for file/symbol naming */\n  readonly pluginInflection: PluginInflection\n}\n```\n\n### Usage in plugin run()\n```typescript\nrun: (ctx, config) =\u003e {\n  for (const entity of ctx.ir.entities.values()) {\n    const fileNameCtx: FileNameContext = {\n      entityName: className,\n      tableName: entity.tableName,\n      schema: entity.schemaName,\n      inflection: ctx.inflection,\n      entity,\n    }\n    const fileName = ctx.pluginInflection.outputFile(fileNameCtx)\n    const filePath = `${config.outputDir}/${fileName}`\n    // ...\n  }\n}\n```\n\n### User customization (future)\nUsers can wrap/override plugins to customize fileName:\n```typescript\nconst myPlugin = effectModelPlugin({ outputDir: \"models\" })\n// Override inflection at plugin level (mechanism TBD)\n```\n\n### Benefits\n- Config stays serializable/immutable\n- Plugin definition declares defaults  \n- Behavior accessed via DI, consistent with Effect patterns\n- No function-in-schema complexity","notes":"## Progress\n\n### Completed\n1. Updated PluginInflection.outputFile signature: (ctx: FileNameContext) =\u003e string\n2. Added FileNameContext type with entityName, tableName, schema, inflection, entity\n3. Updated all tests to use new signature\n4. Updated all plugins (effect-model, types, zod) to use new signature\n5. All 439 tests passing\n\n### Next Steps\n1. Add pluginInflection to SimplePluginContext (provide via plugin runner)\n2. Update plugins to use ctx.pluginInflection.outputFile(fileNameCtx) for paths\n3. Remove fileName from InflectionConfig (lines 217-230, added prematurely)\n4. Add tests for custom outputFile behavior\n\n### Files Modified (uncommitted)\n- src/services/plugin.ts - FileNameContext type, updated PluginInflection\n- src/services/inflection.ts - has fileName in InflectionConfig (to remove)\n- src/plugins/effect-model.ts, types.ts, zod.ts - updated outputFile signatures\n- src/__tests__/*.ts - updated test plugins","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T23:13:45.403010639-06:00","updated_at":"2026-01-07T10:10:25.795494969-06:00","closed_at":"2026-01-07T10:10:25.795494969-06:00","close_reason":"Merged into pg-sourcerer-4ia - the work is tightly coupled","labels":["rewrite"]}
{"id":"pg-sourcerer-fdiw","title":"Generate function wrapper AST","description":"Generate the AST for individual function wrappers using conjure.\n\n## Wrapper patterns\n\n### SETOF / table return (multiple rows)\n```typescript\npostsWithTags: (db: Kysely\u003cDB\u003e, tags: string[]) =\u003e\n  db.selectFrom(eb =\u003e eb.fn\u003cPosts\u003e('app_public.posts_with_tags', [eb.val(tags)]).as('f'))\n    .selectAll()\n    .execute()\n```\n\n### Single row return\n```typescript\ncurrentUser: (db: Kysely\u003cDB\u003e) =\u003e\n  db.selectFrom(eb =\u003e eb.fn\u003cUsers\u003e('app_public.current_user', []).as('f'))\n    .selectAll()\n    .executeTakeFirst()\n```\n\n### Scalar return\n```typescript\ncurrentUserId: (db: Kysely\u003cDB\u003e) =\u003e\n  db.selectNoFrom(eb =\u003e eb.fn\u003cstring\u003e('app_public.current_user_id', []).as('result'))\n    .executeTakeFirst()\n    .then(r =\u003e r?.result)\n```\n\n## AST structure\n- Arrow function with typed `db` param and function args\n- Method chain: selectFrom/selectNoFrom → fn call → selectAll → execute\n- For scalars: additional `.then()` to unwrap result\n\n## Implementation\nBuild AST using existing `conjure` utilities. May need new helpers for:\n- Arrow function inside `selectFrom()` callback\n- `eb.fn\u003cType\u003e()` with generic type parameter\n- Method chaining with `.then()`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T22:26:19.097311328-06:00","created_by":"dan","updated_at":"2026-01-08T22:53:27.329207206-06:00","closed_at":"2026-01-08T22:53:27.329207206-06:00","close_reason":"Changed generateFunctionWrapper to emit flat exports with camelCase names","dependencies":[{"issue_id":"pg-sourcerer-fdiw","depends_on_id":"pg-sourcerer-hykf","type":"blocks","created_at":"2026-01-08T22:26:19.117735331-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-fdiw","depends_on_id":"pg-sourcerer-ltfm","type":"blocks","created_at":"2026-01-08T22:26:38.425217913-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-fdiw","depends_on_id":"pg-sourcerer-hbrw","type":"blocks","created_at":"2026-01-08T22:26:39.420489102-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-fmxp","title":"Add composite type generation to arktype.ts","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:15:09.885579492-06:00","created_by":"dan","updated_at":"2026-01-08T15:15:41.835344729-06:00","closed_at":"2026-01-08T15:15:41.835344729-06:00","close_reason":"Duplicate - keeping 0kkz, vswe, 22u9"}
{"id":"pg-sourcerer-gbj","title":"Kysely Types Plugin","description":"## Overview\nGenerate Kysely-compatible type definitions from SemanticIR, following patterns from kysely-codegen but leveraging our RLS-aware permissions.\n\n## Config Schema\n```typescript\nconst KyselyTypesPluginConfig = S.Struct({\n  outputFile: S.String,  // e.g., \"generated/db.d.ts\"\n  runtimeEnums: S.optionalWith(S.Boolean, { default: () =\u003e false }),\n  typeOnlyImports: S.optionalWith(S.Boolean, { default: () =\u003e true }),\n})\n```\n\n## Output Structure (single file)\n```typescript\nimport type { ColumnType } from 'kysely';\n\n// Helper type (from kysely-codegen)\nexport type Generated\u003cT\u003e = T extends ColumnType\u003cinfer S, infer I, infer U\u003e\n  ? ColumnType\u003cS, I | undefined, U\u003e\n  : ColumnType\u003cT, T | undefined, T\u003e;\n\n// Enums (string union or runtime enum based on config)\nexport type Status = 'active' | 'inactive';\n\n// Table interfaces\nexport interface Users {\n  id: Generated\u003cstring\u003e;           // hasDefault \u0026\u0026 !canInsert via RLS\n  username: string;\n  name: string | null;             // nullable\n  created_at: Generated\u003cDate\u003e;     // hasDefault\n}\n\n// DB interface with schema-qualified keys\nexport interface DB {\n  'app_public.users': Users;\n  'app_public.posts': Posts;\n}\n```\n\n## Permission-Aware Logic (RLS integration)\n\n**For each field:**\n- `Generated\u003cT\u003e`: field has default AND field is NOT insertable (RLS blocks writes)\n- Skip field entirely: not selectable by connected role\n\n**For entity:**\n- Skip entire table if `!entity.permissions.canSelect`\n- JSDoc comments indicating permissions:\n  ```typescript\n  /** @insertable @updateable */\n  export interface Users { ... }\n  ```\n\n## Plugin Definition\n```typescript\nexport const kyselyTypesPlugin = definePlugin({\n  name: \"kysely-types\",\n  provides: [\"types:kysely\"],\n  requires: [],  // standalone, does not need our types plugin\n  configSchema: KyselyTypesPluginConfig,\n  // ...\n})\n```\n\n## Files to Create\n1. `src/plugins/kysely-types.ts` - The plugin\n2. `src/__tests__/kysely-types-plugin.test.ts` - Tests\n\n## Test Strategy\n1. Unit test with mock IR (verify interface shape)\n2. Integration test against example DB\n3. Verify generated types compile with Kysely\n\n## Key Differences from kysely-codegen\n| kysely-codegen | Our plugin |\n|---------------|------------|\n| Introspects DB directly | Uses SemanticIR from our pipeline |\n| No RLS awareness | Uses permissions to determine `Generated\u003cT\u003e` |\n| Standalone CLI | Plugin in our codegen system |\n| Imports from kysely | Imports `ColumnType` from kysely |\n\n## Dependencies\n- All blockers are closed (type-mappings, permissions in IR)\n- Imports `ColumnType` from kysely (peer dependency)","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-06T12:58:45.273917149-06:00","updated_at":"2026-01-08T21:38:52.198552989-06:00","closed_at":"2026-01-08T21:38:52.198552989-06:00","close_reason":"Implemented kysely-types plugin with 26 passing tests. Generates Kysely-compatible type definitions with Generated\u003cT\u003e, ColumnType\u003cS,I,U\u003e, enum unions, table interfaces, and DB interface. Uses RLS permissions for Generated wrapping.","labels":["kysely","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-gbj","depends_on_id":"pg-sourcerer-hbl","type":"blocks","created_at":"2026-01-06T12:58:59.167870557-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-gbj","depends_on_id":"pg-sourcerer-cdb","type":"blocks","created_at":"2026-01-06T12:58:59.883646671-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-gbj","depends_on_id":"pg-sourcerer-v2b","type":"blocks","created_at":"2026-01-06T13:06:24.308110853-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-gbj","depends_on_id":"pg-sourcerer-0t2","type":"parent-child","created_at":"2026-01-06T14:43:01.208591346-06:00","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"pg-sourcerer-gbj","author":"dan","text":"Resetting - was not actively being worked","created_at":"2026-01-07T16:05:25Z"}]}
{"id":"pg-sourcerer-gdv","title":"Add DomainEntity and CompositeEntity to IR","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T14:52:51.789930207-06:00","updated_at":"2026-01-07T15:03:06.417104892-06:00","closed_at":"2026-01-07T15:03:06.417104892-06:00","close_reason":"Added DomainEntity and CompositeEntity to IR. Domains capture base type info and CHECK constraints. Composites filter by relkind='c' to exclude table row types. Added type guards, helpers, and 8 integration tests."}
{"id":"pg-sourcerer-gmb","title":"Add file() method to SimplePluginContext","description":"Wire FileBuilder into the plugin context.\n\n## Changes to plugin.ts\n```typescript\ninterface SimplePluginContext {\n  // ... existing ...\n  \n  /** Create a file builder for structured emission */\n  file(path: string): FileBuilder\n}\n```\n\n## Implementation\n- file() creates FileBuilder with access to:\n  - EmissionBuffer (for queueing)\n  - SymbolRegistry (for registration on emit)\n  - Plugin name (for tracking)\n\n## Deprecation\n- Keep ctx.emit() and ctx.emitAst() working for now\n- Mark as deprecated in JSDoc\n- Remove in future version","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T17:46:29.14877421-06:00","updated_at":"2026-01-06T18:00:35.878069655-06:00","closed_at":"2026-01-06T18:00:35.878069655-06:00","close_reason":"Added file() method to SimplePluginContext. Plugins can now use ctx.file(path).header().import().ast().emit() for structured emission with automatic symbol registration. 2 new tests, all 377 tests pass.","labels":["core","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-gmb","depends_on_id":"pg-sourcerer-9pr","type":"parent-child","created_at":"2026-01-06T17:46:39.674677032-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-gmb","depends_on_id":"pg-sourcerer-skq","type":"blocks","created_at":"2026-01-06T17:46:46.434262783-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-gzj","title":"Remove inflected name from Relation, keep raw constraint data","description":"Simplify `Relation` in the IR - remove the `name` field (which requires inflection complexity), keep only raw constraint data. Plugins can derive names themselves if needed.\n\n## Changes:\n\n1. **Remove `name` from `Relation` interface** in semantic-ir.ts\n\n2. **Remove `relationName` from `CoreInflection`** interface and all implementations\n\n3. **Remove `relationName` from `InflectionConfig`**\n\n4. **Update `buildRelation` in ir-builder.ts** - stop calling inflection.relationName\n\n5. **Update tests** - remove relationName tests from inflection.test.ts, update ir-builder tests\n\n6. **Remove from classicInflectionConfig** \n\n7. **Remove from composeInflection/composeInflectionConfigs**","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T13:33:32.485061338-06:00","updated_at":"2026-01-07T13:45:05.371439696-06:00","closed_at":"2026-01-07T13:45:05.371439696-06:00","close_reason":"Simplified relationName to be a simple string transform (name: string) =\u003e string. Removed constraint parsing, side detection, and smart tag handling from inflection - that logic belongs at the call site (plugins). Relations in IR now only store raw constraint data (constraintName, targetEntity, columns, kind, tags) - no inflected name field.","labels":["rewrite"]}
{"id":"pg-sourcerer-ha9","title":"Simplify plugin config syntax with curried definePlugin","description":"Change plugin configuration from object syntax to function call syntax:\n\nBefore:\n  plugins: [\n    { plugin: typesPlugin, config: { outputDir: \"types\" } },\n    { plugin: zodPlugin, config: { outputDir: \"schemas\" } },\n  ]\n\nAfter:\n  plugins: [\n    typesPlugin({ outputDir: \"types\" }),\n    zodPlugin({ outputDir: \"schemas\" }),\n    effectModelPlugin({ outputDir: \"models\" }),\n  ]\n\nImplementation:\n- Update definePlugin to return a curried function that accepts config\n- The returned function returns a ConfiguredPlugin object\n- Update ConfiguredPlugin type or create PluginInstance type\n- Update plugin-runner to handle the new format\n- Update all existing configs and tests","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T23:24:11.274266415-06:00","updated_at":"2026-01-06T23:36:41.092940693-06:00","closed_at":"2026-01-06T23:36:41.092940693-06:00","close_reason":"Implemented curried definePlugin that returns PluginFactory. Plugins now use simpler syntax: typesPlugin({ outputDir: \"types\" }) instead of { plugin: typesPlugin, config: {...} }"}
{"id":"pg-sourcerer-hbl","title":"Add permissions to SemanticIR","description":"Enrich Entity and Field with permission data during IR building.\n\n**Entity permissions:**\n```typescript\ninterface EntityPermissions {\n  canSelect: boolean\n  canInsert: boolean\n  canUpdate: boolean\n  canDelete: boolean\n}\n```\n\n**Field permissions:**\n```typescript\ninterface FieldPermissions {\n  canSelect: boolean\n  canInsert: boolean\n  canUpdate: boolean\n}\n```\n\n**Implementation:**\n1. Add `permissions` property to `Entity` interface in `semantic-ir.ts`\n2. Add `permissions` property to `Field` interface in `semantic-ir.ts`\n3. Update `ir-builder.ts` to populate permissions using pg-introspection:\n   - Use `entityPermissions(introspection, pgClass, role)` for table-level\n   - Use column ACLs (`PgAttribute.attacl`) for field-level\n   - Fallback to table-level permissions if column ACLs are null\n\n**Reference:** See `packages/pg-sourcerer/introspection.mjs:420-466` for existing pattern using `entityPermissions()`.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T12:58:38.077762291-06:00","updated_at":"2026-01-06T13:17:23.13195516-06:00","closed_at":"2026-01-06T13:17:23.13195516-06:00","close_reason":"Phase 2 complete: permissions wired throughout IR builder with types, helpers, and tests","labels":["ir","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-hbl","depends_on_id":"pg-sourcerer-bt7","type":"parent-child","created_at":"2026-01-06T13:03:00.836693078-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-hbrw","title":"Implement function argument type resolution","description":"Resolve function argument types to TypeScript for wrapper parameters.\n\n## Argument handling\n\n1. **Type mapping**: Map `arg.typeName` to TypeScript type\n   - Use same utilities as return type resolution\n   - Handle arrays (e.g., `text[]` → `string[]`)\n\n2. **Optional arguments** (`hasDefault: true`)\n   - Generate optional TypeScript parameter: `param?: Type`\n   - Only pass to `eb.val()` if value is defined\n\n3. **Parameter naming**: Use `arg.name` directly (already camelCase from PG)\n\n## Implementation\n```typescript\ninterface ResolvedArg {\n  name: string\n  tsType: string\n  isOptional: boolean\n  needsImport?: string\n}\n\nconst resolveArgs = (fn: FunctionEntity, ir: SemanticIR): ResolvedArg[]\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T22:26:11.037837923-06:00","created_by":"dan","updated_at":"2026-01-08T22:34:32.832658442-06:00","closed_at":"2026-01-08T22:34:32.832658442-06:00","close_reason":"Argument type resolution implemented in resolveArg() and resolveArgs() - handles enums, composites, arrays, and scalars","dependencies":[{"issue_id":"pg-sourcerer-hbrw","depends_on_id":"pg-sourcerer-hykf","type":"blocks","created_at":"2026-01-08T22:26:11.103270324-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-hbrw","depends_on_id":"pg-sourcerer-ks90","type":"blocks","created_at":"2026-01-08T22:26:37.557868298-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-huxy","title":"Define init command prompts with @effect/cli Prompt","description":"Create prompt sequence: connection string (text), schemas (list), output dir (text), plugins (multiSelect), classic inflection (confirm), formatter (text optional). Wire into cli.ts as 'init' subcommand.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T12:21:12.545565131-06:00","created_by":"dan","updated_at":"2026-01-08T12:25:32.211764618-06:00","closed_at":"2026-01-08T12:25:32.211764618-06:00","close_reason":"Implemented init command prompts using @effect/cli Prompt (text, multiSelect, confirm). Wired into cli.ts as 'init' subcommand.","dependencies":[{"issue_id":"pg-sourcerer-huxy","depends_on_id":"pg-sourcerer-f4ha","type":"parent-child","created_at":"2026-01-08T12:21:32.561251572-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-hykf","title":"kysely-queries: Add stored function wrappers (queries/mutations)","description":"Generate typed wrappers for PostgreSQL stored functions in the kysely-queries plugin.\n\n## Pattern\n\n```typescript\n// SETOF / table-valued function (multiple rows)\ndb.selectFrom(eb =\u003e eb.fn\u003cPosts\u003e('schema.func', [eb.val(arg)]).as('f'))\n  .selectAll()\n  .execute()\n\n// Single row return (e.g., current_user() → users)  \ndb.selectFrom(eb =\u003e eb.fn\u003cUsers\u003e('schema.func', []).as('f'))\n  .selectAll()\n  .executeTakeFirst()\n\n// Scalar function (returns single value)\ndb.selectNoFrom(eb =\u003e eb.fn\u003cstring\u003e('schema.func', [eb.val(arg)]).as('result'))\n  .executeTakeFirst()\n  .then(r =\u003e r?.result)\n```\n\n## Scope\n\n**Include:**\n- Functions with `canExecute: true`\n- Scalar returns (text, boolean, uuid, etc.)\n- Single row returns (table/composite types)\n- SETOF returns (multiple rows)\n\n**Exclude (MVP):**\n- Functions with row-type arguments (computed fields like `posts_short_body(posts)`)\n- Trigger functions\n- Extension functions\n- `@omit` tagged functions\n\n## Output\n\nSingle `functions.ts` file with namespaces:\n- `queries` - STABLE/IMMUTABLE functions\n- `mutations` - VOLATILE functions","design":"## Generated Output Example\n\n```typescript\n// kysely-queries/functions.ts\nimport type { Kysely } from 'kysely'\nimport type { DB, Users, Posts, TagSearchResult } from '../db.js'\n\nexport const queries = {\n  currentUser: (db: Kysely\u003cDB\u003e) =\u003e\n    db.selectFrom(eb =\u003e eb.fn\u003cUsers\u003e('app_public.current_user', []).as('f'))\n      .selectAll()\n      .executeTakeFirst(),\n\n  currentUserId: (db: Kysely\u003cDB\u003e) =\u003e\n    db.selectNoFrom(eb =\u003e eb.fn\u003cstring\u003e('app_public.current_user_id', []).as('result'))\n      .executeTakeFirst()\n      .then(r =\u003e r?.result),\n\n  postsWithTags: (db: Kysely\u003cDB\u003e, tags: string[]) =\u003e\n    db.selectFrom(eb =\u003e eb.fn\u003cPosts\u003e('app_public.posts_with_tags', [eb.val(tags)]).as('f'))\n      .selectAll()\n      .execute(),\n\n  searchTags: (db: Kysely\u003cDB\u003e, substr: string) =\u003e\n    db.selectFrom(eb =\u003e eb.fn\u003cTagSearchResult\u003e('app_public.search_tags', [eb.val(substr)]).as('f'))\n      .selectAll()\n      .execute(),\n} as const\n\nexport const mutations = {\n  verifyEmail: (db: Kysely\u003cDB\u003e, userEmailId: string, token: string) =\u003e\n    db.selectNoFrom(eb =\u003e eb.fn\u003cboolean\u003e('app_public.verify_email', [\n      eb.val(userEmailId),\n      eb.val(token)\n    ]).as('result'))\n      .executeTakeFirst()\n      .then(r =\u003e r?.result ?? false),\n} as const\n```\n\n## Type Resolution\n\n- Table/view returns → Reference existing type from DB types\n- Composite returns → Reference composite type from DB types  \n- Scalar returns → Map via pg-types utilities\n- SETOF → Same as above, but `.execute()` returns array\n\n## Config Additions\n\n```typescript\ngenerateFunctions: S.optionalWith(S.Boolean, { default: () =\u003e true }),\nfunctionsFile: S.optionalWith(S.String, { default: () =\u003e \"functions.ts\" }),\n```","status":"in_progress","priority":3,"issue_type":"feature","created_at":"2026-01-08T15:10:56.561618762-06:00","created_by":"dan","updated_at":"2026-01-08T22:30:49.011654775-06:00","dependencies":[{"issue_id":"pg-sourcerer-hykf","depends_on_id":"pg-sourcerer-ki23","type":"blocks","created_at":"2026-01-08T15:11:10.975800869-06:00","created_by":"dan"}],"comments":[{"id":3,"issue_id":"pg-sourcerer-hykf","author":"dan","text":"Reopened","created_at":"2026-01-09T04:26:46Z"}]}
{"id":"pg-sourcerer-i2n","title":"Update types plugin to handle unified Entity","description":"Refactor types.ts to iterate ir.entities and switch on entity.kind. Enums use same outputFile inflection as tables/views. Remove hardcoded enums.ts path.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T14:23:13.340286833-06:00","updated_at":"2026-01-07T14:28:55.119183114-06:00","closed_at":"2026-01-07T14:28:55.119183114-06:00","close_reason":"Types plugin now uses getEnumEntities() and getTableEntities(). Each enum gets its own file via outputFile inflection. Uses pgName instead of tableName. Helper functions updated to use Iterable\u003cEnumEntity\u003e.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-i2n","depends_on_id":"pg-sourcerer-6w8","type":"blocks","created_at":"2026-01-07T14:23:24.081777542-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-i5a","title":"Integrate Effect logger for plugin logging","description":"Replace console.* calls with Effect's structured logging.\n\nFor simple plugins via `definePlugin`:\n- `ctx.log.info(\"message\")` → internally calls `Effect.logInfo`\n- `ctx.log.debug(\"message\")` → `Effect.logDebug`\n- `ctx.log.warn(\"message\")` → `Effect.logWarning`\n\nFor Effect-native plugins:\n- Use `yield* Effect.logInfo(\"message\")` directly\n\nLogger should include plugin name as annotation (from PluginMeta service).\n\nMay need to configure a LogLayer for the runtime.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T11:27:56.390164317-06:00","updated_at":"2026-01-06T12:30:00.442450043-06:00","closed_at":"2026-01-06T12:30:00.442450043-06:00","close_reason":"Integrated Effect logging for both simple and Effect-native plugins. SimplePluginContext.log methods now use Effect.logDebug/Info/Warning with annotateLogs for plugin name. PluginRunner also adds log annotation around each plugin execution so Effect-native plugins get automatic plugin name context.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-i5a","depends_on_id":"pg-sourcerer-ilk","type":"blocks","created_at":"2026-01-06T11:27:56.403345785-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-i8q","title":"Add integration tests for error scenarios","description":"Add integration tests for error scenarios to verify error handling works correctly:\n\n1. **Config errors**: Missing config file, invalid config schema, missing connectionString\n2. **Database errors**: Invalid connection string, unreachable database  \n3. **Plugin errors**: Plugin throws during execution, capability conflicts, missing dependencies\n\nThese tests verify the error types (ConfigNotFound, ConfigInvalid, ConnectionFailed, etc.) are properly surfaced.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T12:41:54.828132223-06:00","updated_at":"2026-01-07T13:27:24.713194818-06:00","closed_at":"2026-01-07T13:27:24.713194818-06:00","close_reason":"Added 7 error scenario tests in generate.errors.test.ts covering: ConfigNotFound, ConfigInvalid, ConnectionFailed, PluginExecutionFailed (sync and async), CapabilityNotSatisfied, CapabilityConflict","dependencies":[{"issue_id":"pg-sourcerer-i8q","depends_on_id":"pg-sourcerer-pj1","type":"parent-child","created_at":"2026-01-07T12:42:51.465806079-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ia7","title":"E2E config integration tests (in-memory)","description":"Add integration tests that exercise full config scenarios without writing to disk.\n\nKey features:\n- runConfigInMemory(config, fixture) helper that returns emissions\n- Test different plugin combinations (effect-only, types+zod, all three)\n- Assert on file names (PascalCase with inflectionDefaults)\n- Assert on class/interface names matching file names\n- Test cross-plugin imports work\n- Test type hints applied correctly\n- Test inflection composition (plugin defaults + user config)\n- Test enum handling (inline vs separate file modes)\n\nThis replaces the need for separate config files like pgsourcerer-effect.config.ts","notes":"Created e2e-config.test.ts with 10 tests. 9/10 passing. Last test fails due to inflection composition bug which is being addressed by the inflection refactor tasks (pg-sourcerer-4ia and deps).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T23:21:37.616898569-06:00","updated_at":"2026-01-07T10:35:39.97233253-06:00","closed_at":"2026-01-07T10:35:39.97233253-06:00","close_reason":"All 10 e2e-config tests now passing after inflection refactor"}
{"id":"pg-sourcerer-ib7","title":"Migrate zod plugin to FileBuilder + exp.*","description":"Refactor zod plugin to use new APIs:\n\n## Changes\n- Replace manual symbol registration with exp.* helpers\n- Replace ctx.emitAst() with ctx.file().ast().emit()\n- Replace hardcoded zod import string with package import ref\n- Use exp.const() for zod schemas\n- Use exp.type() for z.infer type exports\n\n## Example\n```typescript\nconst zodStatements = [\n  exp.const(\n    `${entityName}Row`,\n    { capability: \"schemas:zod\", entity: entityName, shape: \"row\" },\n    generateZodObject(entity.shapes.row)\n  ),\n  exp.type(\n    `${entityName}Row`,\n    { capability: \"schemas:zod\", entity: entityName, shape: \"row\" },\n    ts.infer(ts.typeOf(`${entityName}Row`))\n  ),\n]\n\nctx.file(`${config.outputDir}/${entityName}.ts`)\n  .header(\"// Auto-generated. Do not edit.\")\n  .import({ kind: \"package\", names: [\"z\"], from: \"zod\" })\n  .ast(program(...zodStatements))\n  .emit()\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T17:46:24.919475917-06:00","updated_at":"2026-01-06T18:10:57.042106804-06:00","closed_at":"2026-01-06T18:10:57.042106804-06:00","close_reason":"Migrated zod plugin to FileBuilder + exp.* API. Uses ctx.file().header().import().ast().emit() pattern, exp.const() for schema exports, exp.type() for inferred type exports, and package import refs for zod.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-ib7","depends_on_id":"pg-sourcerer-9pr","type":"parent-child","created_at":"2026-01-06T17:46:38.626995087-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-ib7","depends_on_id":"pg-sourcerer-7yv","type":"blocks","created_at":"2026-01-06T17:46:48.595491354-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-ib7","depends_on_id":"pg-sourcerer-gmb","type":"blocks","created_at":"2026-01-06T17:46:51.000483173-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ilk","title":"Effect-Native Plugin System","description":"Refactor plugin system to use Effect's DI/context instead of prop-drilling a PluginContext object.\n\nCore principle: Plugins become Effects that yield the services they need, rather than receiving an opaque context object.\n\nTwo-tier API:\n- Simple plugins: `definePlugin({ run: (ctx, config) =\u003e void | Promise\u003cvoid\u003e })`\n- Advanced plugins: Return `Effect\u003cvoid, E, Services\u003e` and yield services directly\n\nBenefits:\n- No more manual dependency wiring in PluginRunner\n- Adding new services doesn't require modifying PluginContext\n- Plugins only depend on what they actually use\n- Testing is simpler (provide only needed layers)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-06T11:27:36.806924357-06:00","updated_at":"2026-01-06T12:30:12.79942855-06:00","closed_at":"2026-01-06T12:30:12.79942855-06:00","close_reason":"Effect-Native Plugin System complete. All subtasks done: IR/ArtifactStore/PluginMeta services created, Effect logging integrated, IR builder refactored to yield Inflection, old PluginContext removed. Plugins now use Effect DI (yield* Service) instead of prop-drilling.","labels":["architecture","rewrite"]}
{"id":"pg-sourcerer-im0","title":"sql-queries: Fix type errors and implement QueryKind classification","description":"## Goal\nFix the sql-queries plugin to pass all tests.\n\n## Type Errors to Fix\n1. Line 148 - wrapPromise: Change `b.tsTypeParameterInstantiation([innerType])` to `b.tsTypeParameterInstantiation([toTSType(innerType)])`\n2. Line 376 - Import syntax: Change `symbols: [\"sql\"]` to `names: [\"sql\"]`\n\n## Add QueryKind Classification\nAdd after line ~110:\n```typescript\ntype QueryKind =\n  | { type: \"exactLookup\"; unique: boolean }\n  | { type: \"search\"; method: \"trigram\" | \"fulltext\" }\n  | { type: \"skip\"; reason: string }\n\nfunction classifyIndex(index: IndexDef): QueryKind {\n  if (index.hasExpressions) return { type: \"skip\", reason: \"expression index\" }\n  if (index.isPartial) return { type: \"skip\", reason: \"partial index\" }\n  if (index.columns.length \u003e 1) return { type: \"skip\", reason: \"composite index (future)\" }\n  if (index.method === \"gin\") return { type: \"skip\", reason: \"gin index (future trigram/array support)\" }\n  if (index.method === \"gist\") return { type: \"skip\", reason: \"gist index (future fulltext support)\" }\n  return { type: \"exactLookup\", unique: index.isUnique || index.isPrimary }\n}\n```\n\n## Refactor generateLookupFunctions\n- Use classifyIndex for filtering\n- Deduplicate by column set (unique wins over non-unique)\n- Track `Map\u003ccolumnKey, { index, kind }\u003e`\n\n## Tests to Pass\nRun: `cd packages/pg-sourcerer \u0026\u0026 bun run test src/__tests__/sql-queries-plugin.test.ts`\n\nFailing tests:\n- return types \u003e unique index returns Promise\u003cRow | null\u003e\n- return types \u003e non-unique index returns Promise\u003cRow[]\u003e\n- return types \u003e async functions use await\n- parameter types \u003e uses correct TypeScript types for parameters\n- imports \u003e imports Row type from types plugin\n- imports \u003e imports sql template tag\n- edge cases \u003e no duplicate functions for same column\n\n## Closes\n- pg-sourcerer-102 (field types)\n- pg-sourcerer-yoy (duplicate functions)\n- pg-sourcerer-dkt (sql import)\n- pg-sourcerer-ccd (Promise wrapper)\n- pg-sourcerer-3d9 (await)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T16:34:29.007954716-06:00","updated_at":"2026-01-07T20:27:35.337864395-06:00","closed_at":"2026-01-07T20:27:35.337864395-06:00","close_reason":"Fixed: TypeScript typecheck passes. Fixed wrapPromise to use toTSType() for TSTypeKind compatibility.","dependencies":[{"issue_id":"pg-sourcerer-im0","depends_on_id":"pg-sourcerer-102","type":"blocks","created_at":"2026-01-07T16:34:33.575810611-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-im0","depends_on_id":"pg-sourcerer-yoy","type":"blocks","created_at":"2026-01-07T16:34:33.613908776-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-im0","depends_on_id":"pg-sourcerer-dkt","type":"blocks","created_at":"2026-01-07T16:34:33.649104051-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-im0","depends_on_id":"pg-sourcerer-ccd","type":"blocks","created_at":"2026-01-07T16:34:33.68087988-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-im0","depends_on_id":"pg-sourcerer-3d9","type":"blocks","created_at":"2026-01-07T16:34:33.712125139-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ip2f","title":"Interactive Query Builder TUI","description":"TUI for interactively building multi-table queries by navigating FK relationships and selecting columns. Phase 1: fzf prototype. Phase 2: custom opentui implementation.\n\nFlow:\n1. Pick starting table\n2. Navigate joinable tables via FKs (bidirectional - belongsTo + reverse hasMany)\n3. Multi-select columns from joined tables\n4. Generate query using existing plugin styles (raw SQL or Kysely)\n\nKey components needed:\n- JoinGraph service (bidirectional FK navigation)\n- FzfRunner service (subprocess wrapper)\n- QueryBuilder state machine\n- CLI command: pgsourcerer query","status":"open","priority":4,"issue_type":"epic","created_at":"2026-01-08T11:07:31.928181437-06:00","created_by":"dan","updated_at":"2026-01-08T11:07:31.928181437-06:00"}
{"id":"pg-sourcerer-j3f","title":"Fix effect-model smart tag tests","description":"Smart tag tests are failing due to IR mutation leaking between tests. Need to either: 1) Clone the IR before mutating, or 2) Build fresh IR for each test that needs mutations. Also fix the test assertions to match actual output patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T22:46:08.464912929-06:00","updated_at":"2026-01-06T22:55:51.641275184-06:00","closed_at":"2026-01-06T22:55:51.641275184-06:00","close_reason":"Tests updated for new clean output patterns (Model.Sensitive instead of FieldExcept, DateTimeInsertFromDate instead of S.Date). All 29 effect-model tests pass.","labels":["effect-model","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-j3f","depends_on_id":"pg-sourcerer-4h9","type":"blocks","created_at":"2026-01-06T22:46:20.103229174-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-j42","title":"Plugin Runner: Use Live Inflection Instead of Stub","description":"The plugin runner currently passes `InflectionStub` to plugin contexts:\n\n```typescript\n// plugin-runner.ts line 258\ninflection: InflectionStub,  // Throws \"not implemented\"!\n```\n\nIf any plugin calls `ctx.inflection.camelCase()` etc., it will crash.\n\nFix: Accept inflection as a parameter to `run()` or use `InflectionLive` by default.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-05T21:46:11.896056994-06:00","updated_at":"2026-01-06T10:18:43.407644863-06:00","closed_at":"2026-01-06T10:18:43.407644863-06:00","close_reason":"Refactored PluginRunner to use Effect.Service pattern. The service now depends on Inflection via layer composition - inflection is captured at service construction time, not required from callers. Tests use createPluginRunner(liveInflection) helper for direct testing without Effect context.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-jfv","title":"Implement insert optionality override via smart tags","description":"Support smart tag to override whether a field is optional on insert.\n\nTag format:\n```json\n{\"sourcerer\": {\"effect:model\": {\"insert\": \"optional\"}}}\n{\"sourcerer\": {\"effect:model\": {\"insert\": \"required\"}}}\n```\n\nUse cases:\n- Force optional even without DB default\n- Force required even with DB default\n\nDefault behavior (without tag) is determined by hasDefault/isGenerated.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T22:12:32.893448573-06:00","updated_at":"2026-01-06T22:40:04.385935899-06:00","closed_at":"2026-01-06T22:40:04.385935899-06:00","close_reason":"Implemented smart tag support: sensitive fields excluded from json variants via Model.FieldExcept, insert optionality override via Model.FieldOption","labels":["effect-model","smart-tags"]}
{"id":"pg-sourcerer-jg6","title":"Add integration test for runGenerate() pipeline","description":"Create integration test that exercises the full runGenerate() pipeline:\n\n1. Create a temp directory with a valid pgsourcerer.config.ts\n2. Call runGenerate() with that config\n3. Verify generated files exist and have correct content\n4. Test with different plugin combinations\n\nThis covers generate.ts (currently 0%) and config-loader.ts (currently 0%) through real usage rather than mocking.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T12:41:51.412731915-06:00","updated_at":"2026-01-07T13:03:44.291859822-06:00","closed_at":"2026-01-07T13:03:44.291859822-06:00","close_reason":"Added generate.integration.test.ts with 4 tests covering:\n- Full pipeline with types plugin (detailed output validation)\n- Dry run mode\n- Multiple plugins together\n- Inflection config application\n\nAlso fixed bug in generate.ts where PluginRunner.Default was overriding user inflection config. Coverage for generate.ts: 0% → 97%","dependencies":[{"issue_id":"pg-sourcerer-jg6","depends_on_id":"pg-sourcerer-pj1","type":"parent-child","created_at":"2026-01-07T12:42:50.815721383-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-jgs","title":"Refactor ir-builder.ts getTypeName to use Option\u003cPgType\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:09:23.831178876-06:00","updated_at":"2026-01-07T21:24:29.887379742-06:00","closed_at":"2026-01-07T21:24:29.887379742-06:00","close_reason":"Refactored getTypeName to use pipe + Option.fromNullable + Option.map + Option.getOrElse"}
{"id":"pg-sourcerer-jpi","title":"Add list/pagination/count functions to query plugin","description":"Add utility query functions beyond index-based lookups.\n\n## Functions to Generate\n\n### List with pagination:\n```typescript\nlistUsers(options?: { \n  limit?: number, \n  offset?: number,\n  orderBy?: 'id' | 'createdAt' | 'username',\n  order?: 'asc' | 'desc'\n}): Promise\u003cUser[]\u003e\n```\n\n### Count:\n```typescript\ncountUsers(): Promise\u003cnumber\u003e\n```\n\n### Existence check:\n```typescript\nuserExistsById(id: string): Promise\u003cboolean\u003e\n```\n\n## Implementation Notes\n- orderBy options from entity columns (or subset - indexed columns?)\n- Default limit to prevent unbounded queries? (configurable)\n- Existence uses `SELECT 1 ... LIMIT 1` for efficiency","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-07T11:41:58.936196095-06:00","updated_at":"2026-01-07T19:59:17.17883297-06:00","dependencies":[{"issue_id":"pg-sourcerer-jpi","depends_on_id":"pg-sourcerer-7a1","type":"blocks","created_at":"2026-01-07T11:42:06.004915599-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-kdz","title":"ir-builder: Refactor resolveDomainBaseType to Option pipe","description":"Refactor `resolveDomainBaseType` (lines 164-191) to use pipe with Option.filter/flatMap/chain instead of 4 nested guard clauses.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:50:38.650925833-06:00","updated_at":"2026-01-07T20:03:34.327959464-06:00","closed_at":"2026-01-07T20:03:34.327959464-06:00","close_reason":"Refactored resolveDomainBaseType to use pipe with Option.fromNullable/filter/flatMap chain"}
{"id":"pg-sourcerer-ki23","title":"Generate composite types in validation plugins (zod, arktype, effect-model)","description":"Add composite type generation to validation plugins. Currently only `types.ts` uses `getCompositeEntities()`. \n\n## Scope\n- **zod.ts**: Generate Zod schemas for composite types\n- **arktype.ts**: Generate Arktype validators for composites  \n- **effect-model.ts**: Generate Effect Schema for composites\n\n## Why\nFunctions can return composite types. Without composite support in these plugins, function wrapper generation must skip or inline types.\n\n## Implementation Pattern\nFollow the existing pattern in `types.ts`:\n```typescript\ngetCompositeEntities(ir)\n  .filter(e =\u003e e.tags.omit !== true)\n  .forEach(composite =\u003e { ... })\n```\n\n## Files to Modify\n- `packages/pg-sourcerer/src/plugins/zod.ts`\n- `packages/pg-sourcerer/src/plugins/arktype.ts`\n- `packages/pg-sourcerer/src/plugins/effect-model.ts`\n- Corresponding test files","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:10:16.284077666-06:00","created_by":"dan","updated_at":"2026-01-08T15:20:40.389060708-06:00","closed_at":"2026-01-08T15:20:40.389060708-06:00","close_reason":"All three validation plugins now generate composite types: zod, arktype, effect-model"}
{"id":"pg-sourcerer-knj","title":"Implement function composition for inflection","description":"Update composeInflectionConfigs to compose functions: (name) =\u003e user(plugin(name)). Plugin defaults run first, user config refines the result.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T10:03:05.1366603-06:00","updated_at":"2026-01-07T10:10:41.783993339-06:00","closed_at":"2026-01-07T10:10:41.783993339-06:00","close_reason":"Merged into pg-sourcerer-4ia","dependencies":[{"issue_id":"pg-sourcerer-knj","depends_on_id":"pg-sourcerer-4ia","type":"blocks","created_at":"2026-01-07T10:03:15.352958739-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ks90","title":"Add function filtering and categorization utilities","description":"Create utility functions to filter and categorize functions for code generation.\n\n## Filter criteria\n- `canExecute: true` \n- `returnTypeName !== \"trigger\"`\n- `!isFromExtension`\n- `tags.omit !== true`\n- No row-type arguments (args where `typeName` matches a table/view entity)\n\n## Categorization\n- `volatility === \"volatile\"` → mutations\n- `volatility === \"stable\" | \"immutable\"` → queries\n\n## Implementation\nAdd to `kysely-queries.ts` or create separate helper module:\n```typescript\nconst isGeneratableFunction = (fn: FunctionEntity, ir: SemanticIR): boolean =\u003e {\n  if (!fn.canExecute) return false\n  if (fn.returnTypeName === \"trigger\") return false\n  if (fn.isFromExtension) return false\n  if (fn.tags.omit === true) return false\n  // Check for row-type args\n  return !fn.args.some(arg =\u003e hasRowTypeArg(arg, ir))\n}\n\nconst hasRowTypeArg = (arg: FunctionArg, ir: SemanticIR): boolean =\u003e {\n  // Check if arg.typeName matches a table entity's qualified name\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T22:25:58.530188276-06:00","created_by":"dan","updated_at":"2026-01-08T22:34:30.289297556-06:00","closed_at":"2026-01-08T22:34:30.289297556-06:00","close_reason":"Added function filtering utilities (isGeneratableFunction, categorizeFunction, getGeneratableFunctions) and type resolution (resolveReturnType, resolveArg, resolveArgs) to kysely-queries.ts","dependencies":[{"issue_id":"pg-sourcerer-ks90","depends_on_id":"pg-sourcerer-hykf","type":"blocks","created_at":"2026-01-08T22:25:58.572147283-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-kxb","title":"Update example config for new plugin format","description":"Rewrite packages/example/pgsourcerer.config.mjs to use the new Effect-based plugin system:\n- Use new Config schema format\n- Use typesPlugin and zodPlugin\n- Remove old makeEffectModelsPlugin etc references","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T15:06:28.70239618-06:00","updated_at":"2026-01-06T15:15:57.017728117-06:00","closed_at":"2026-01-06T15:15:57.017728117-06:00","close_reason":"Created pgsourcerer.config.ts with new plugin format. Updated package.json scripts. Deleted old .mjs config. Example now generates 25 files (types + zod schemas) successfully.","labels":["example","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-kxb","depends_on_id":"pg-sourcerer-7e6","type":"blocks","created_at":"2026-01-06T15:06:36.051682378-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-lt6","title":"Plugin Runner: Validate Plugin Configs Against Schemas","description":"Plugin configs are never validated against their declared schemas:\n\n```typescript\n// plugin-runner.ts - config passed directly without validation\nreturn plugin.run(ctx, config)  // config could be invalid!\n```\n\nShould decode config through `Schema.decode(plugin.configSchema, config)` either in `prepare()` or at the start of `run()`.\n\nThis will catch config errors early with good error messages via Effect Schema.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:35.837819626-06:00","updated_at":"2026-01-06T10:05:23.044743088-06:00","closed_at":"2026-01-06T10:05:23.044743088-06:00","close_reason":"Implemented config validation in prepare(). Plugin configs are now decoded through Schema.decodeUnknown before execution, catching invalid configs early with clear error messages using ParseResult.ArrayFormatter.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-ltfm","title":"Implement function return type resolution","description":"Resolve function return types to TypeScript type references.\n\n## Return type categories\n\n1. **Scalar types** (text, boolean, uuid, int4, etc.)\n   - Map via `pg-types` utilities (defaultPgToTs)\n   - Result: primitive TS type string\n\n2. **Table returns** (e.g., `returns app_public.users`)\n   - Look up table entity by qualified name\n   - Result: reference to table's row type (e.g., `Users`)\n\n3. **Composite returns** (e.g., `returns tag_search_result`)\n   - Look up composite entity by name\n   - Result: reference to composite type\n\n4. **SETOF returns** (`returnsSet: true`)\n   - Same type resolution as above\n   - Affects execution method (`.execute()` vs `.executeTakeFirst()`)\n\n## Implementation\n```typescript\ninterface ResolvedReturnType {\n  tsType: string           // e.g., \"string\", \"boolean\", \"Users\", \"TagSearchResult\"\n  isArray: boolean         // true for SETOF\n  isScalar: boolean        // true for primitives\n  needsImport?: string     // type name to import from DB types\n}\n\nconst resolveReturnType = (fn: FunctionEntity, ir: SemanticIR): ResolvedReturnType\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T22:26:06.120725782-06:00","created_by":"dan","updated_at":"2026-01-08T22:34:31.885142959-06:00","closed_at":"2026-01-08T22:34:31.885142959-06:00","close_reason":"Return type resolution implemented in resolveReturnType() - handles table, composite, and scalar returns","dependencies":[{"issue_id":"pg-sourcerer-ltfm","depends_on_id":"pg-sourcerer-hykf","type":"blocks","created_at":"2026-01-08T22:26:06.136433362-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-ltfm","depends_on_id":"pg-sourcerer-ks90","type":"blocks","created_at":"2026-01-08T22:26:36.534911497-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-ma4m","title":"Mermaid ERD Plugin","description":"Plugin to generate Mermaid ERD diagrams from IR.\n\nUses core relation-graph utilities (buildRelationGraph, getJoinableEntities) to generate proper ERD syntax:\n\n```mermaid\nerDiagram\n    User {\n        uuid id PK\n        string username\n        UserRole role\n    }\n    Post {\n        uuid id PK\n        uuid authorId FK\n        string title\n    }\n    User ||--o{ Post : \"author\"\n```\n\nPlugin options:\n- includeColumns: boolean (default true)\n- includeTypes: boolean (default true)  \n- outputFormat: 'md' | 'mermaid' (default 'md' with fenced block)\n\nProvides: ['mermaid-erd']\nEmits: schema.erd.md or configurable filename\n\nAlso: remove irToMermaid() from core relation-graph.ts (flowchart not useful, plugin does it better)","status":"open","priority":4,"issue_type":"feature","created_at":"2026-01-08T12:08:25.75677124-06:00","created_by":"dan","updated_at":"2026-01-08T12:08:25.75677124-06:00"}
{"id":"pg-sourcerer-mj8","title":"Create ArtifactStore service","description":"Create an `ArtifactStore` service for plugin-to-plugin data passing.\n\nReplaces `ctx.getArtifact()` and `ctx.setArtifact()`.\n\n```typescript\ninterface ArtifactStore {\n  get: (capability: CapabilityKey) =\u003e Artifact | undefined\n  set: (capability: CapabilityKey, data: unknown) =\u003e void\n}\n\nexport class ArtifactStoreSvc extends Context.Tag(\"ArtifactStore\")\u003cArtifactStoreSvc, ArtifactStore\u003e() {}\n```\n\nThe store is created once per run and shared across all plugins.\nPluginRunner injects the current plugin name when calling `set`.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T11:27:48.470340069-06:00","updated_at":"2026-01-06T11:34:01.048974163-06:00","closed_at":"2026-01-06T11:34:01.048974163-06:00","close_reason":"Created ArtifactStore service using Effect.Service pattern in src/services/artifact-store.ts. Stateful service with get/set/getAll methods for plugin-to-plugin artifact passing.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-mj8","depends_on_id":"pg-sourcerer-ilk","type":"blocks","created_at":"2026-01-06T11:27:48.492634171-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-n6xo","title":"Add export/exportDefault helpers to conjure","description":"Add helpers to conjure for creating export statements cleanly without type casts. Include both named exports and export default.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-08T12:35:04.834298328-06:00","created_by":"dan","updated_at":"2026-01-08T12:35:04.834298328-06:00"}
{"id":"pg-sourcerer-npp","title":"Implement sensitive field exclusion via smart tags","description":"Support smart tag to mark fields as sensitive (excluded from json variants).\n\nTag format:\n```json\n{\"sourcerer\": {\"effect:model\": {\"sensitive\": true}}}\n```\n\nBehavior:\n- sensitive: true → exclude from json, jsonCreate, jsonUpdate variants\n- Field still appears in select/insert/update (if RLS allows)\n\nThis mirrors Model.Sensitive() behavior.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T22:12:29.963019727-06:00","updated_at":"2026-01-06T22:40:04.394206349-06:00","closed_at":"2026-01-06T22:40:04.394206349-06:00","close_reason":"Implemented smart tag support: sensitive fields excluded from json variants via Model.FieldExcept, insert optionality override via Model.FieldOption","labels":["effect-model","smart-tags"]}
{"id":"pg-sourcerer-ntu","title":"Plugin Integration Test with Fixture","description":"Create integration tests that verify the full pipeline:\n1. Load introspection fixture (from example database)\n2. Build IR\n3. Run plugin(s)\n4. Assert emitted files match expected output\n\nUse the introspection fixture created in Phase 1 (src/__tests__/fixtures/).\n\nTest scenarios:\n- Types plugin generates correct interfaces for User, Post entities\n- Zod plugin generates correct schemas\n- Effect Schema plugin generates correct schemas\n- Plugins respect @omit tags\n- Plugins respect @name tags\n- TypeHintRegistry overrides are applied\n- Symbol registration works for cross-file imports\n- Enum types are generated correctly\n\nThis validates the full integration without needing a live database.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T21:41:44.373199941-06:00","updated_at":"2026-01-06T12:34:04.564029494-06:00","closed_at":"2026-01-06T12:34:04.564029494-06:00","close_reason":"Already implemented in core-pipeline.integration.test.ts - covers full pipeline with IR building, plugin execution, emissions validation, symbol registration, artifact passing, file writing, and error cases","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-ntu","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:44.38766068-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-p1l","title":"Publish pg-sourcerer to npm","description":"Epic tracking all tasks required to make pg-sourcerer publishable to npm as a proper package that works for all Node.js consumers (not just Bun).\n\nWhen this epic is closed, the package is ready for `npm publish`.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-07T10:57:02.29428852-06:00","updated_at":"2026-01-07T11:14:08.142603809-06:00","closed_at":"2026-01-07T11:14:08.142603809-06:00","close_reason":"All publish tasks complete: LICENSE, build script, package.json exports, Node.js verification, README with plugin docs, release-please automation for changelog + npm publish.","labels":["publish"]}
{"id":"pg-sourcerer-paz","title":"field-utils: Refactor resolveFieldType enum check to Option chain","description":"Refactor `resolveFieldType` enum check (lines 109-120) to use Option chain instead of 3-level nested if.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:50:37.090161987-06:00","updated_at":"2026-01-07T20:03:31.648803569-06:00","closed_at":"2026-01-07T20:03:31.648803569-06:00","close_reason":"Refactored resolveFieldType enum check to use Option.fromNullable/flatMap chain"}
{"id":"pg-sourcerer-pbe","title":"Delete dead imports.ts file","description":"The file src/services/imports.ts exports Imports, ImportCollector, createImportCollector, and ImportsLive but none are imported or used anywhere in the codebase. Delete it to reduce confusion and improve coverage metrics.","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-01-07T12:41:34.875152619-06:00","updated_at":"2026-01-07T12:44:12.327741955-06:00","closed_at":"2026-01-07T12:44:12.327741955-06:00","close_reason":"Deleted dead imports.ts file - typecheck and tests pass","dependencies":[{"issue_id":"pg-sourcerer-pbe","depends_on_id":"pg-sourcerer-pj1","type":"parent-child","created_at":"2026-01-07T12:42:49.184782447-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-pcu","title":"Type Hint Registry Implementation","description":"Implement TypeHintRegistry matching and precedence:\n\n- Match fields against configured type hints\n- Specificity scoring: table+column \u003e table \u003e column \u003e pgType\n- Merge hints from multiple matching rules\n- Later rules override earlier (same specificity)\n\nCurrently stubbed - returns empty hints.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:08.820308639-06:00","updated_at":"2026-01-05T21:22:00.840700579-06:00","closed_at":"2026-01-05T21:22:00.840700579-06:00","close_reason":"Implemented TypeHintRegistry with matching and precedence logic. Scoring: schema=2, table=3, column=4, pgType=1. Higher scores override lower, later rules override earlier at same specificity. 23 tests covering basic matching, non-matching, precedence, merging, and complex scenarios.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-pcu","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:08.821918675-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-pj1","title":"Improve test coverage with focus on integration tests","description":"## Goal\nImprove test coverage from 83% to 90%+ with emphasis on integration/behavior tests over implementation detail tests.\n\n## Current State\n- Overall: 83.38% coverage\n- Many unit tests test implementation details (buffer mechanics, registry internals)\n- Good integration tests exist (core-pipeline, e2e-config) but don't cover full pipeline\n\n## Key Gaps\n\n### 0% Coverage (Entry Points)\n- `cli.ts` - CLI entry point\n- `generate.ts` - Main orchestrator  \n- `config-loader.ts` - Config file discovery/loading\n- `imports.ts` - **DEAD CODE** - not used anywhere, should delete\n\n### Low Coverage\n- `introspection.ts` (61%) - DB connection error paths\n- `plugin.ts` (70%) - async plugin execution, error handling\n- `inflection.ts` (74%) - `composeInflection()` function\n\n## Approach\n\n### Phase 1: Cleanup\n- Delete dead `imports.ts` file\n- Configure coverage exclusions for entry points (`cli.ts`, `index.ts`, `scripts/`)\n\n### Phase 2: Integration Tests (HIGH PRIORITY)\n- Test `runGenerate()` end-to-end with temp config files\n- Test real plugin output with actual database\n- Test error scenarios (invalid config, bad connection string, plugin failures)\n\n### Phase 3: Targeted Unit Tests\n- `composeInflection()` - plugin inflection composition\n- Config validation error messages\n- Plugin async error handling paths\n\n## Success Criteria\n- 90%+ coverage on non-excluded files\n- Integration tests cover: happy path, config errors, DB errors, plugin errors\n- Reduced reliance on implementation-detail tests","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-07T12:40:41.00236706-06:00","updated_at":"2026-01-07T21:26:58.014533676-06:00","closed_at":"2026-01-07T21:26:58.014533676-06:00","close_reason":"All subtasks complete. Coverage at 93.76% (target was 90%)"}
{"id":"pg-sourcerer-prh","title":"Add index information to SemanticIR","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T11:36:56.607181735-06:00","updated_at":"2026-01-07T11:41:29.626279068-06:00","closed_at":"2026-01-07T11:41:29.626279068-06:00","close_reason":"Duplicate of pg-sourcerer-t1b which has better description","dependencies":[{"issue_id":"pg-sourcerer-prh","depends_on_id":"pg-sourcerer-6lg","type":"blocks","created_at":"2026-01-07T11:37:02.958844279-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-q8zo","title":"Add relation graph utilities (join path finding)","description":"Utilities for navigating entity relationships in the IR. Needed for query builder TUI but also useful for documentation generators, ERD tools, etc.\n\nLocation: ir/relation-graph.ts\n\nFunctions:\n```typescript\n// Get all entities directly joinable from this entity (via FK in either direction)\nfunction getJoinableEntities(ir: SemanticIR, entityName: string): JoinableEntity[]\n\ninterface JoinableEntity {\n  entity: TableEntity\n  direction: 'belongsTo' | 'hasMany'\n  relation: Relation\n  // For display: \"orders via user_id → users.id\"\n  description: string\n}\n\n// Find shortest path between two entities (for multi-hop joins)\nfunction findJoinPath(ir: SemanticIR, from: string, to: string): JoinStep[] | null\n\ninterface JoinStep {\n  from: string\n  to: string\n  relation: Relation\n  direction: 'belongsTo' | 'hasMany'\n}\n\n// Build complete join graph (for visualization/caching)\nfunction buildJoinGraph(ir: SemanticIR): JoinGraph\n```\n\nDepends on: hasMany relations task (pg-sourcerer-73mr)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T11:09:02.113606734-06:00","created_by":"dan","updated_at":"2026-01-08T12:04:34.649592231-06:00","closed_at":"2026-01-08T12:04:34.649592231-06:00","close_reason":"Implemented relation-graph.ts with buildRelationGraph(), getJoinableEntities(), findJoinPath(), and irToMermaid(). Uses Effect Graph module for BFS path-finding. 14 tests passing.","dependencies":[{"issue_id":"pg-sourcerer-q8zo","depends_on_id":"pg-sourcerer-73mr","type":"blocks","created_at":"2026-01-08T11:09:07.458353191-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-q8zo","depends_on_id":"pg-sourcerer-ip2f","type":"parent-child","created_at":"2026-01-08T11:09:14.134201066-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-qn1","title":"Zod Plugin - Zod Schemas","description":"Generate Zod schemas for each entity's shapes.\n\nOutput example for User entity:\n```typescript\nimport { z } from \"zod\"\n\nexport const UserRow = z.object({\n  id: z.string().uuid(),\n  username: z.string(),\n  name: z.string().nullable(),\n  createdAt: z.coerce.date(),\n})\nexport type UserRow = z.infer\u003ctypeof UserRow\u003e\n\nexport const UserInsert = z.object({\n  id: z.string().uuid().optional(),\n  username: z.string(),\n  name: z.string().nullable().optional(),\n})\nexport type UserInsert = z.infer\u003ctypeof UserInsert\u003e\n```\n\nRequirements:\n- provides: [\"schemas:zod\", \"schemas\"]\n- Generate schemas for Row, Insert, Update, Patch shapes\n- Use z.infer for type exports\n- Map pg types to Zod (uuid→z.string().uuid(), etc.)\n- Handle nullable (.nullable()) vs optional (.optional())\n- Support arrays (z.array())\n- Support enums (z.enum())\n- Respect smart tags\n- Query TypeHintRegistry for custom Zod schemas\n- Register symbols for import resolution","notes":"Deferred - Focus on Kysely first. Can implement later for Zod validation use cases.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-05T21:41:24.77286389-06:00","updated_at":"2026-01-06T14:52:49.500910119-06:00","closed_at":"2026-01-06T14:52:49.500910119-06:00","close_reason":"Implemented Zod plugin with full support for:\\n- Generates z.object() schemas for Row, Insert, Update, Patch shapes\\n- Maps PG types to Zod (uuid→z.string().uuid(), timestamp→z.coerce.date(), etc.)\\n- Handles nullable (.nullable()) and optional (.optional()) correctly\\n- Supports arrays (z.array())\\n- Supports enums (z.enum())\\n- Exports inferred types via z.infer when exportTypes: true\\n- Registers symbols for import resolution\\n- Respects @omit smart tag\\n- 16 tests all passing","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-qn1","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:24.79265166-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-qxg","title":"Refactor IR builder helpers to yield Inflection","description":"Refactor IR builder internal helper functions to yield Inflection from Effect context instead of passing it as a parameter.\n\nFunctions to convert:\n- `buildField(attr, tags, inflection, kind)` → `buildField(attr, tags, kind): Effect\u003cField, never, Inflection\u003e`\n- `buildShape(entityName, kind, attributes, attributeTags, inflection)` → remove inflection param\n- `buildEntity(pgClass, inflection, entityNameLookup)` → remove inflection param\n- `buildRelation(fk, inflection, entityNameLookup)` → remove inflection param\n- `buildEnum(pgType, inflection)` → remove inflection param\n- `buildEntityNameLookup(classes, inflection)` → remove inflection param\n\nEach function becomes an Effect that yields `Inflection`:\n```typescript\nfunction buildField(attr, tags, kind): Effect.Effect\u003cField, never, Inflection\u003e {\n  return Effect.gen(function* () {\n    const inflection = yield* Inflection\n    // ... rest of logic\n  })\n}\n```\n\nThe top-level `IRBuilderLive` layer already provides Inflection, so no additional wiring needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T11:28:37.992044266-06:00","updated_at":"2026-01-06T12:28:40.616523424-06:00","closed_at":"2026-01-06T12:28:40.616523424-06:00","close_reason":"Refactored all IR builder helpers to yield Inflection from Effect context. Functions updated: buildField, buildShape, buildEntity, buildRelation, buildRelations, buildEnum, buildEntityNameLookup. IRBuilder.build() now requires Inflection in R type. createIRBuilderService() takes no args.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-qxg","depends_on_id":"pg-sourcerer-ilk","type":"blocks","created_at":"2026-01-06T11:28:38.008353895-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-r40x","title":"Generate config file from prompt answers","description":"Take prompt answers and generate valid pgsourcerer.config.ts. Handle imports for defineConfig, inflection helpers, and selected plugins. Use template literals or AST builder.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T12:21:14.61760958-06:00","created_by":"dan","updated_at":"2026-01-08T12:25:41.710603305-06:00","closed_at":"2026-01-08T12:25:41.710603305-06:00","close_reason":"Implemented as part of init.ts","dependencies":[{"issue_id":"pg-sourcerer-r40x","depends_on_id":"pg-sourcerer-f4ha","type":"parent-child","created_at":"2026-01-08T12:21:32.644805284-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-r40x","depends_on_id":"pg-sourcerer-huxy","type":"blocks","created_at":"2026-01-08T12:21:32.904241935-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-rb8","title":"plugin-runner: Refactor checkDuplicates to Effect.reduce","description":"Refactor checkDuplicates for...of with Set mutation to use Effect.reduce with HashMap","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:07:09.188331036-06:00","updated_at":"2026-01-07T20:07:34.656357773-06:00","closed_at":"2026-01-07T20:07:34.656357773-06:00","close_reason":"Refactored checkDuplicates: for...of with Set mutation → Effect.reduce with immutable Set spread"}
{"id":"pg-sourcerer-s5v","title":"Design Effect Model plugin architecture","description":"Define the overall plugin structure for generating @effect/sql Model classes from the semantic IR.\n\nKey decisions:\n- Plugin config schema (outputDir, string type default, etc.)\n- File organization (one Model per entity file)\n- Import structure (@effect/sql Model, effect Schema)\n- How to handle enums (separate const or inline S.Union)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T22:12:14.081023324-06:00","updated_at":"2026-01-06T22:23:32.71369049-06:00","closed_at":"2026-01-06T22:23:32.71369049-06:00","close_reason":"Implemented in effect-model.ts plugin with 22 passing tests","labels":["design","effect-model"]}
{"id":"pg-sourcerer-skq","title":"FileBuilder API for structured file emission","description":"Create FileBuilder class with fluent API for emitting files.\n\n## API\n```typescript\nctx.file(\"types/User.ts\")\n  .header(\"// Auto-generated\")\n  .import({ kind: \"symbol\", ref: { capability: \"types\", entity: \"Role\" } })\n  .import({ kind: \"package\", names: [\"z\"], from: \"zod\" })\n  .ast(program(...))\n  .emit()\n```\n\n## Interface\n```typescript\ninterface FileBuilder {\n  header(content: string | readonly n.Statement[]): FileBuilder\n  import(ref: ImportRef): FileBuilder\n  ast(program: n.Program | SymbolProgram): FileBuilder\n  content(text: string): FileBuilder\n  emit(): void\n}\n```\n\n## Behavior\n- Mutable builder (method calls accumulate state)\n- Multiple .ast() calls append to program body\n- .ast() extracts symbols from SymbolProgram automatically\n- .emit() registers symbols and queues file for serialization\n- .content() for non-AST files (mutually exclusive with .ast())","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T17:46:06.063859316-06:00","updated_at":"2026-01-06T17:56:46.494438031-06:00","closed_at":"2026-01-06T17:56:46.494438031-06:00","close_reason":"Created FileBuilder with fluent API for structured file emission. Supports headers, imports (tracked for later resolution), AST with symbol extraction, and raw content. 12 new tests, all 375 tests pass.","labels":["core","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-skq","depends_on_id":"pg-sourcerer-9pr","type":"parent-child","created_at":"2026-01-06T17:46:35.263509886-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-skq","depends_on_id":"pg-sourcerer-bxf","type":"blocks","created_at":"2026-01-06T17:46:44.481568733-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-smwt","title":"Extract SQL query building primitives to lib/sql-builder.ts","description":"sql-queries.ts has useful helpers that are duplicated/similar in kysely-queries.ts and would be needed by the query builder TUI:\n\nFrom sql-queries.ts:\n- buildSqlTemplate() - template literal construction\n- buildAwaitSqlTag() - tagged template with type param\n- buildAwaitSqlString() - parameterized query style\n- buildQuery() - unified dispatcher\n- buildFirstRowDecl() / buildAllRowsDecl() - result destructuring\n\nThese should move to lib/sql-builder.ts so they can be reused by:\n1. sql-queries plugin (current user)\n2. kysely-queries plugin (partial overlap)\n3. Query builder TUI (new)\n4. Future query-related plugins\n\nKeep plugin-specific logic in plugins, extract pure SQL/AST building to lib.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T11:08:52.896001803-06:00","created_by":"dan","updated_at":"2026-01-08T11:24:26.559633877-06:00","closed_at":"2026-01-08T11:24:26.559633877-06:00","close_reason":"Created lib/hex.ts with SQL query building primitives (tag + string styles). Added param namespace to conjure.ts for typed/optional/destructured/pick parameters. Refactored sql-queries.ts to use hex and conjure.param. All 554 tests pass.","dependencies":[{"issue_id":"pg-sourcerer-smwt","depends_on_id":"pg-sourcerer-ip2f","type":"parent-child","created_at":"2026-01-08T11:09:13.390069863-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-spt","title":"Add EntityPermissions and FieldPermissions types to semantic-ir.ts","description":"Add new permission interfaces to the Semantic IR types.\n\n**Add to `src/ir/semantic-ir.ts`:**\n\n```typescript\n/**\n * Permissions for an entity (table/view) based on connected role's ACLs\n */\nexport interface EntityPermissions {\n  readonly canSelect: boolean\n  readonly canInsert: boolean\n  readonly canUpdate: boolean\n  readonly canDelete: boolean\n}\n\n/**\n * Permissions for a field (column) based on connected role's ACLs\n */\nexport interface FieldPermissions {\n  readonly canSelect: boolean\n  readonly canInsert: boolean\n  readonly canUpdate: boolean\n}\n```\n\n**Update `Entity` interface:**\n```typescript\nexport interface Entity {\n  // ... existing fields ...\n  /** Permissions for the connected role */\n  readonly permissions: EntityPermissions\n}\n```\n\n**Update `Field` interface:**\n```typescript\nexport interface Field {\n  // ... existing fields ...\n  /** Permissions for the connected role */\n  readonly permissions: FieldPermissions\n}\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T13:05:38.46059622-06:00","updated_at":"2026-01-06T13:15:58.536279824-06:00","closed_at":"2026-01-06T13:15:58.536279824-06:00","close_reason":"Added EntityPermissions and FieldPermissions types to semantic-ir.ts, updated Field and Entity interfaces with permissions property","labels":["ir","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-spt","depends_on_id":"pg-sourcerer-hbl","type":"parent-child","created_at":"2026-01-06T13:06:16.326564896-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-sql1","title":"SQL Queries Plugin - Core Infrastructure","description":"## Overview\nCreate `sql-queries` plugin that generates raw SQL query functions using tagged template strings.\n\n## Output Format\n\n### CRUD Functions\n```typescript\n// queries/User.ts\nexport async function findUserById({ id }: { id: string }): Promise\u003cUserRow | null\u003e {\n  const [result] = await sql\u003cUserRow\u003e`select * from app_public.users where id = ${id}`\n  return result\n}\n\nexport async function findManyUsers({ limit = 50, offset = 0 }: { limit?: number; offset?: number } = {}): Promise\u003cUserRow[]\u003e {\n  return sql\u003cUserRow\u003e`select * from app_public.users limit ${limit} offset ${offset}`\n}\n\nexport async function createUser(data: UserInsert): Promise\u003cUserRow\u003e {\n  const [result] = await sql\u003cUserRow\u003e`insert into app_public.users (name, email) values (${data.name}, ${data.email}) returning *`\n  return result\n}\n\nexport async function updateUser({ id }: { id: string }, data: UserUpdate): Promise\u003cUserRow | null\u003e {\n  const [result] = await sql\u003cUserRow\u003e`update app_public.users set name = ${data.name} where id = ${id} returning *`\n  return result\n}\n\nexport async function deleteUser({ id }: { id: string }): Promise\u003cvoid\u003e {\n  await sql`delete from app_public.users where id = ${id}`\n}\n```\n\n### Index-Based Lookups\n```typescript\nexport async function getUserByUsername({ username }: { username: string }): Promise\u003cUserRow | null\u003e {\n  const [result] = await sql\u003cUserRow\u003e`select * from app_public.users where username = ${username}`\n  return result\n}\n\nexport async function findPostsByUserId({ userId }: { userId: string }): Promise\u003cPostRow[]\u003e {\n  return sql\u003cPostRow\u003e`select * from app_public.posts where user_id = ${userId}`\n}\n```\n\n## Plugin Definition\n\n```typescript\nexport const sqlQueriesPlugin = definePlugin({\n  name: \"sql-queries\",\n  provides: [\"queries\", \"queries:sql\"],\n  requires: [\"types\"],\n  configSchema: S.Struct({\n    outputDir: S.String,\n    /** Custom header to prepend to each generated file (e.g., imports) */\n    header: S.optional(S.String),\n  }),\n  inflection: {\n    outputFile: (ctx) =\u003e `${ctx.entityName}.ts`,\n    symbolName: (entityName, artifactKind) =\u003e `${entityName}${artifactKind}`,\n  },\n  run: (ctx, config) =\u003e { ... }\n})\n```\n\n## Implementation Details\n\n### Query Type Classification\n| Index Kind | Return Type | Destructuring |\n|------------|-------------|---------------|\n| Primary Key | `T \\| null` | `[result]` |\n| Unique Constraint | `T \\| null` | `[result]` |\n| Non-Unique Index | `T[]` | No destructure |\n\n### CRUD Generation Rules (EntityPermissions-based)\n- `findById`: Generate if `canSelect` + has primary key\n- `findMany`: Generate if `canSelect`\n- `create`: Generate if `canInsert`\n- `update`: Generate if `canUpdate`\n- `delete`: Generate if `canDelete`\n\n### Index-Based Generation Rules\n- Skip `isPartial === true`\n- Skip `hasExpressions === true`\n- Skip GIN/GIST indexes (not for equality lookups)\n- Skip multicolumn indexes (feature for later)\n- Skip if column not in shape (permissions)\n\n### SQL Patterns\n- Table references: `schema.table` (e.g., `app_public.users`)\n- Tagged template: `sql\u003cRowType\u003e`...`${params}`\n- INSERT with VALUES: `insert into table (cols) values (${val1}, ${val2}) returning *`\n- Parameter types: `{ columnName: RowShape[columnName].type }`\n\n## Tasks\n1. Create `sql-queries.ts` plugin file\n2. Implement CRUD function generation (findById, findMany, create, update, delete)\n3. Implement index-based lookup generation\n4. Add tests for CRUD generation with permissions\n5. Add tests for index-based lookups (unique vs non-unique)\n6. Export plugin from `index.ts`\n\n## Dependencies\n- `types` capability (for Row/Insert/Update types)\n- `Entity.permissions` (for CRUD filtering)\n- `Entity.indexes` (for lookup generation)\n- `Entity.shapes.row` (for parameter/return types)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T15:59:08.061624168-06:00","updated_at":"2026-01-07T21:16:01.255736591-06:00","closed_at":"2026-01-07T21:16:01.255736591-06:00","close_reason":"Implemented: Core infrastructure in src/plugins/sql-queries.ts","labels":["phase-2","query-generator","sql-queries"]}
{"id":"pg-sourcerer-sql2","title":"SQL Queries Plugin - Tests","description":"## Overview\nAdd tests for the SQL queries plugin covering CRUD operations, index-based lookups, and permission filtering.\n\n## Test Categories\n\n### Plugin Structure Tests\n- Plugin has correct name\n- Provides `[\"queries\", \"queries:sql\"]` capabilities\n- Requires `[\"types\"]` capability\n- Config schema accepts `outputDir` and optional `header`\n\n### CRUD Function Tests\n- `findById` returns `Promise\u003cT | null\u003e` with destructure\n- `findMany` returns `Promise\u003cT[]\u003e` with limit/offset defaults (50/0)\n- `create` generates INSERT with VALUES clause and RETURNING\n- `update` generates UPDATE with WHERE id and RETURNING\n- `delete` generates DELETE with WHERE id\n- Functions respect EntityPermissions:\n  - Skip `create` if `!canInsert`\n  - Skip `update` if `!canUpdate`\n  - Skip `delete` if `!canDelete`\n  - Always generate `findById`/`findMany` if `canSelect`\n\n### Index-Based Lookup Tests\n- Unique index (PK, unique constraint) generates `T | null` with destructure\n- Non-unique index generates `T[]` without destructure\n- Skips partial indexes (`isPartial === true`)\n- Skips expression indexes (`hasExpressions === true`)\n- Skips GIN/GIST indexes\n- Skips multicolumn indexes\n\n### Parameter Type Tests\n- Single column parameter typed as `{ columnName: Type }`\n- Type matches Row shape field type (respects nullable)\n\n### SQL Format Tests\n- Table references use `schema.table` format\n- INSERT uses VALUES clause with column list\n- UPDATE uses SET and WHERE clauses\n- Destructuring only for unique lookups\n\n### Integration Tests\n- Works with fixture database introspection data\n- Generated code compiles without type errors\n- Symbol registration for cross-file imports (types plugin)\n\n## Fixtures Needed\n- Entity with all CRUD permissions\n- Entity with restricted permissions (no insert/update/delete)\n- Entity with unique index (username)\n- Entity with non-unique index (user_id FK)\n- Entity with primary key","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T15:59:15.124398642-06:00","updated_at":"2026-01-07T21:16:02.380380255-06:00","closed_at":"2026-01-07T21:16:02.380380255-06:00","close_reason":"Implemented: 17 tests in src/__tests__/sql-queries-plugin.test.ts"}
{"id":"pg-sourcerer-sql3","title":"SQL Queries Plugin - Export from index.ts","description":"## Overview\nUpdate `packages/pg-sourcerer/src/index.ts` to export the new `sqlQueriesPlugin`.\n\n## Changes Required\n\nIn `index.ts`, add to the Plugins section:\n```typescript\nexport { sqlQueriesPlugin } from \"./plugins/sql-queries.js\"\n```\n\n## Verification\nAfter export, users should be able to:\n```typescript\nimport { sqlQueriesPlugin } from \"pg-sourcerer\"\n```\n\n## Pre-requisites\n- `pg-sourcerer-sql1` must be completed first (plugin file exists)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T15:59:17.889233237-06:00","updated_at":"2026-01-07T21:16:03.50843275-06:00","closed_at":"2026-01-07T21:16:03.50843275-06:00","close_reason":"Implemented: Exported from src/index.ts"}
{"id":"pg-sourcerer-sql4","title":"SQL Queries Plugin - Documentation","description":"## Overview\nUpdate documentation to include the new SQL queries plugin.\n\n## Changes Required\n\n### 1. ARCHITECTURE.md\nAdd to \"Phase 3: Query \u0026 HTTP Plugins\":\n```markdown\n- [x] SQL Queries Plugin - Generate raw SQL query functions with template strings\n```\n\n### 2. README.md\nAdd to plugins list:\n```markdown\n| `sqlQueriesPlugin` | Generates raw SQL query functions using template strings |\n```\n\n### 3. Config documentation\nAdd example:\n```typescript\nexport default defineConfig({\n  plugins: [\n    typesPlugin({ outputDir: \"types\" }),\n    sqlQueriesPlugin({ \n      outputDir: \"queries\",\n      header: 'import { sql } from \"../db\"',  // optional custom imports\n    }),\n  ],\n})\n```\n\n## Pre-requisites\n- `pg-sourcerer-sql1` must be completed first\n- `pg-sourcerer-sql2` tests should pass","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-07T15:59:22.702367556-06:00","updated_at":"2026-01-08T15:06:22.215340711-06:00","external_ref":"https://github.com/DanielFGray/pg-sourcerer/issues/17"}
{"id":"pg-sourcerer-svm","title":"Wire permissions into buildEntity and main build function","description":"Update `buildEntity` and the main `build` function to handle permissions.\n\n**Update `buildEntity` signature:**\n```typescript\nfunction buildEntity(\n  pgClass: PgClass,\n  entityNameLookup: ReadonlyMap\u003cstring, string\u003e,\n  introspection: Introspection,\n  role: PgRoles\n): Effect.Effect\u003cEntity, TagParseError, Inflection\u003e\n```\n\n**Update `buildEntity` implementation:**\n1. Call `buildEntityPermissions(introspection, pgClass, role)` early\n2. Pass `introspection`, `role`, `entityPerms` to all `buildShape` calls\n3. Add `permissions: entityPerms` to the entity object\n\n**Update main `build` function:**\n1. Get role: `const role = introspection.getCurrentUser()`\n2. Add error if role is undefined: `Effect.fail(new IntrospectionFailed({ message: \"Could not determine current user\" }))`\n3. Pass `introspection` and `role` to `buildEntity` calls\n\n**Optional: Add role override to `IRBuilderOptions`:**\n```typescript\nexport interface IRBuilderOptions {\n  readonly schemas: readonly string[]\n  /** Override role for permission checking (uses current_user if not specified) */\n  readonly role?: string\n}\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T13:05:59.965564957-06:00","updated_at":"2026-01-06T13:16:39.995817682-06:00","closed_at":"2026-01-06T13:16:39.995817682-06:00","close_reason":"buildEntity now accepts introspection and role params, createIRBuilderImpl gets current user and passes through","labels":["ir","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-svm","depends_on_id":"pg-sourcerer-9b3","type":"blocks","created_at":"2026-01-06T13:06:13.998270603-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-svm","depends_on_id":"pg-sourcerer-hbl","type":"parent-child","created_at":"2026-01-06T13:06:18.882999938-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-t1b","title":"Add Index representation to SemanticIR","description":"Extend SemanticIR to include index information for each entity. This is foundational for the query plugin.\n\n## New Index Type\n\n```typescript\ninterface IndexDef {\n  name: string                    // PostgreSQL index name\n  columns: readonly string[]      // Column names in order (field names, not column names)\n  columnNames: readonly string[]  // Original PostgreSQL column names\n  isUnique: boolean\n  isPrimary: boolean\n  isPartial: boolean\n  predicate?: string              // WHERE clause for partial indexes (raw SQL)\n  method: 'btree' | 'gin' | 'gist' | 'hash' | 'brin' | 'spgist'\n  hasExpressions: boolean         // true if any \"column\" is actually an expression\n}\n```\n\n## Entity Changes\n\n```typescript\ninterface Entity {\n  // ... existing fields ...\n  indexes: readonly IndexDef[]    // All indexes on this entity\n}\n```\n\n## Implementation in ir-builder.ts\n\n```typescript\nconst indexes = pgClass.getIndexes().map(idx =\u003e {\n  const keys = idx.getKeys()  // Array\u003cPgAttribute | null\u003e\n  const hasExpressions = keys.some(k =\u003e k === null)\n  const columns = keys.filter(k =\u003e k !== null).map(k =\u003e inflection.fieldName(k))\n  \n  return {\n    name: idx.getIndexClass()?.relname ?? 'unknown',\n    columns,\n    columnNames: keys.filter(k =\u003e k !== null).map(k =\u003e k.attname),\n    isUnique: idx.indisunique === true,\n    isPrimary: idx.indisprimary === true,\n    isPartial: idx.indpred !== null,\n    predicate: idx.indpred ?? undefined,\n    method: getIndexMethod(idx),  // helper to resolve amname\n    hasExpressions,\n  }\n})\n```\n\n## Acceptance Criteria\n- [ ] IndexDef type added to semantic-ir.ts\n- [ ] Entity.indexes populated by ir-builder.ts\n- [ ] Primary key index included (with isPrimary: true)\n- [ ] Unique indexes marked correctly\n- [ ] Partial indexes captured with predicate\n- [ ] Expression indexes marked (hasExpressions: true)\n- [ ] Index method captured (btree, gin, etc.)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T11:38:48.525756918-06:00","updated_at":"2026-01-07T12:22:43.662677815-06:00","closed_at":"2026-01-07T12:22:43.662677815-06:00","close_reason":"IndexDef type, Entity.indexes field, and buildIndexes() function implemented as part of writing tests (pg-sourcerer-afn). All acceptance criteria satisfied.","dependencies":[{"issue_id":"pg-sourcerer-t1b","depends_on_id":"pg-sourcerer-afn","type":"blocks","created_at":"2026-01-07T11:44:10.959707-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-tau","title":"Refactor types plugin to Effect-idiomatic patterns","description":"The types plugin uses imperative patterns throughout:\n- `for` loops with `if/continue`\n- Mutable arrays with `.push()`\n- `let` bindings reassigned in branches\n\nShould refactor to use:\n- `pipe()` with `Array.filter`, `Array.map`\n- `Effect.forEach` if any async needed\n- Immutable data transformations\n- `Option.match` instead of `if (Option.isSome(...))`\n\nSee EFFECT_STYLE.md for patterns.\n\nLow priority since the plugin works correctly.","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-01-07T22:11:18.078975845-06:00","updated_at":"2026-01-08T09:38:28.839307238-06:00","closed_at":"2026-01-08T09:38:28.839307238-06:00","close_reason":"Refactored types plugin: replaced Option.isSome checks with Option.match, eliminated mutable push patterns with pure transforms, simplified pipe usage where native methods suffice"}
{"id":"pg-sourcerer-tefy","title":"Add FK-based semantic naming to kysely-queries plugin","description":"Port the FK-based semantic naming from sql-queries plugin to kysely-queries plugin.\n\n## What was done in sql-queries (pg-sourcerer-7a1)\n- Added findRelationForColumn() to find belongsTo relations for index columns\n- Added deriveSemanticName() with priority: @fieldName tag → column minus _id/_fk suffix → target entity\n- Updated generateLookupName() to use semantic names for FK-indexed columns\n- Updated generateLookupFunction() to use:\n  - Semantic param names (e.g., 'user' instead of 'userId')\n  - Indexed access type for FK params: Post[\"userId\"] instead of Pick\u003cPost, \"userId\"\u003e\n  - Plural function names for non-unique FK lookups\n\n## Files to reference\n- packages/pg-sourcerer/src/plugins/sql-queries.ts (lines 55-95, 245-310)\n- packages/pg-sourcerer/src/__tests__/sql-queries-plugin.test.ts\n\n## Expected output\n- getPostsByUser(user: Post[\"userId\"]) instead of getPostByUserId({userId}: Pick\u003cPost, \"userId\"\u003e)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T16:41:38.88827726-06:00","created_by":"dan","updated_at":"2026-01-08T16:57:45.334687016-06:00","closed_at":"2026-01-08T16:57:45.334687016-06:00","close_reason":"Ported FK-based semantic naming from sql-queries to kysely-queries plugin. Uses findOneBy/findManyBy prefixes with semantic names derived from FK relations. Parameter types use indexed access (AppPublicPosts[\"userId\"]) with proper imports.","dependencies":[{"issue_id":"pg-sourcerer-tefy","depends_on_id":"pg-sourcerer-7a1","type":"blocks","created_at":"2026-01-08T16:41:43.088170221-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-u47","title":"Kysely Queries Plugin","description":"Generate permission-aware CRUD query functions using Kysely.\n\n**Output:**\n```typescript\n// generated/queries/users.ts\nimport { Kysely } from 'kysely'\nimport type { Database, User, NewUser, UserUpdate } from '../database'\n\nexport const users = {\n  findById: (db: Kysely\u003cDatabase\u003e, id: string) =\u003e\n    db.selectFrom('app_public.users').selectAll().where('id', '=', id).executeTakeFirst(),\n\n  findMany: (db: Kysely\u003cDatabase\u003e, opts?: { limit?: number; offset?: number }) =\u003e\n    db.selectFrom('app_public.users').selectAll()\n      .$if(opts?.limit != null, q =\u003e q.limit(opts!.limit!))\n      .$if(opts?.offset != null, q =\u003e q.offset(opts!.offset!))\n      .execute(),\n\n  create: (db: Kysely\u003cDatabase\u003e, data: NewUser) =\u003e\n    db.insertInto('app_public.users').values(data).returningAll().executeTakeFirstOrThrow(),\n\n  update: (db: Kysely\u003cDatabase\u003e, id: string, data: UserUpdate) =\u003e\n    db.updateTable('app_public.users').set(data).where('id', '=', id).returningAll().executeTakeFirstOrThrow(),\n\n  // delete only if canDelete permission\n  delete: (db: Kysely\u003cDatabase\u003e, id: string) =\u003e\n    db.deleteFrom('app_public.users').where('id', '=', id).execute(),\n}\n```\n\n**Requirements:**\n- `provides: [\"queries:kysely\", \"queries\"]`\n- `requires: [\"types:kysely\"]`\n- Only generate CRUD methods if entity has corresponding permissions\n- Filter insertable/updateable columns by field-level permissions\n- Use primary key for findById/update/delete\n- Object namespace style (matches existing queries.mjs pattern)\n- Pass `db: Kysely\u003cDatabase\u003e` as first parameter\n\n**Future (not this task):**\n- Index-based `findBy*` methods\n- Relation-following queries\n\n**Reference:** `packages/pg-sourcerer/plugins/queries.mjs` for permission filtering patterns","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-06T12:58:55.577561141-06:00","updated_at":"2026-01-08T21:51:57.506364095-06:00","closed_at":"2026-01-08T21:51:57.506364095-06:00","close_reason":"Fixed kysely-queries plugin: table refs now match DB interface keys (unqualified for defaultSchemas), import path defaults to ../db.js, removed dumb global headers","labels":["kysely","phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-u47","depends_on_id":"pg-sourcerer-gbj","type":"blocks","created_at":"2026-01-06T12:59:00.718055787-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-u47","depends_on_id":"pg-sourcerer-0t2","type":"parent-child","created_at":"2026-01-06T14:43:01.247172198-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ubz6","title":"Add enumStyle config to zod and arktype plugins","description":"Add two config options to zod, arktype, and effect-model plugins:\n\n1. enumStyle: 'strings' | 'enum' - How to represent enum values\n   - 'strings': z.enum(['a','b']) / S.Union(S.Literal(...)) / \"'a' | 'b'\"\n   - 'enum': Use native TS enum with z.nativeEnum(MyEnum) etc\n\n2. typeReferences: 'inline' | 'separate' - Where to define enums\n   - 'inline': Embed definition at every usage (current behavior)\n   - 'separate': Generate one enum file, import and reference by name\n\nDefaults: enumStyle='strings', typeReferences='separate' for DRY code generation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-08T16:09:39.361776477-06:00","created_by":"dan","updated_at":"2026-01-08T16:28:13.040766962-06:00","closed_at":"2026-01-08T16:28:13.040766962-06:00","close_reason":"Added enumStyle ('strings'|'enum') and typeReferences ('inline'|'separate') config options to zod, arktype, and effect-model plugins. Defaults to strings+separate for DRY enum generation."}
{"id":"pg-sourcerer-ues","title":"sql-queries: Add QueryKind discriminator for index classification","description":"Introduce a QueryKind type to classify indexes by their query pattern:\n- exactLookup (btree WHERE col = $1) - implemented\n- search/trigram (ILIKE pattern matching) - future\n- fulltext (tsvector @@) - future  \n- range (btree WHERE col \u003e $1) - future\n- contains (GIN array @\u003e) - future\n- skip (not supported)\n\nThis enables extending the plugin to generate different query functions based on index type.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T16:30:46.190047996-06:00","updated_at":"2026-01-07T21:44:29.520456394-06:00","closed_at":"2026-01-07T21:44:29.520456394-06:00","close_reason":"Added opclassNames to IndexDef via vendored pg-introspection; tests verify gin_trgm_ops and tsvector_ops detection"}
{"id":"pg-sourcerer-ug3","title":"Refactor utilities to return Option\u003cT\u003e instead of T | undefined","description":"## Overview\\nConvert functions returning `T | undefined` to return `Option\u003cT\u003e` for idiomatic Effect patterns.\\n\\n## Scope\\n\\n### Phase 1: Core Utility Functions (pg-types.ts)\\n- `getExtensionTypeMapping(...)` → returns `Option\u003cTsType\u003e`\\n- `findEnumByPgName(...)` → returns `Option\u003cEnumLookupResult\u003e`\\n- Update callers to use `Option` methods instead of `undefined` checks\\n\\n### Phase 2: ir-builder.ts\\n- `getTypeName(pgType: PgType | undefined)` → `getTypeName(pgType: Option\u003cPgType\u003e)`\\n- Update all call sites\\n\\n### Phase 3: Type Hints \u0026 Other Utilities\\n- `TypeHintRegistry.getHint()` → returns `Option\u003cT\u003e`\\n- Any other utility functions with `| undefined` returns\\n\\n## Changes Required\\n\\n### Before\\n```typescript\\nfunction findEnumByPgName(...): EnumLookupResult | undefined {\\n  // ... loop\\n  return undefined\\n}\\n\\nconst result = findEnumByPgName(enums, type)\\nif (result) { ... }\\n```\\n\\n### After\\n```typescript\\nfunction findEnumByPgName(...): Option\u003cEnumLookupResult\u003e {\\n  return pipe(\\n    Arr.from(enums),\\n    Arr.findFirst(enumDef =\u003e enumDef.pgName === pgTypeName),\\n    Option.map(enumDef =\u003e ({ ... }))\\n  )\\n}\\n\\nconst result = findEnumByPgName(enums, type)\\nOption.match(result, {\\n  onNone: () =\u003e ...,\\n  onSome: (r) =\u003e ...\\n})\\n```\\n\\n## Benefits\\n- Explicit about optionality in type signature\\n- Composable with other Effect operations\\n- Cannot accidentally forget null check\\n- Type-safe pipeline with `pipe`\\n\\n## Tasks\\n1. Update `getExtensionTypeMapping` return type and implementation\\n2. Update `findEnumByPgName` return type and implementation\\n3. Update all call sites in codebase\\n4. Update `getTypeName` parameter type\\n5. Update TypeHintRegistry.getHint() return type\\n6. Add tests for new Option-based signatures","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T18:42:29.84269951-06:00","updated_at":"2026-01-07T19:09:34.579309685-06:00","closed_at":"2026-01-07T19:09:34.579309685-06:00","close_reason":"Phase 1 complete: Converted defaultPgToTs, getExtensionTypeMapping, findEnumByPgName to return Option\u003cT\u003e. Fixed extension namespace lookup bug. Updated callers and tests. Created separate tasks for Phase 2 (pg-sourcerer-3si) and Phase 3 (pg-sourcerer-ezj)."}
{"id":"pg-sourcerer-ugl","title":"Update inflection tests for function-based API","description":"Update inflection.test.ts and e2e-config.test.ts to use the new function-based inflection API.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T10:03:09.907264251-06:00","updated_at":"2026-01-07T10:32:29.574351713-06:00","closed_at":"2026-01-07T10:32:29.574351713-06:00","close_reason":"Completed as part of pg-sourcerer-4ia - inflection tests now use function-based API","dependencies":[{"issue_id":"pg-sourcerer-ugl","depends_on_id":"pg-sourcerer-395","type":"blocks","created_at":"2026-01-07T10:03:15.464863452-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-uk0a","title":"Test database connection before writing config","description":"After collecting prompts, attempt to connect to database using provided connection string. Report success/failure with PG version. Fail gracefully if connection fails - still offer to write config.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T12:21:16.588191049-06:00","created_by":"dan","updated_at":"2026-01-08T12:25:41.728233535-06:00","closed_at":"2026-01-08T12:25:41.728233535-06:00","close_reason":"Implemented as part of init.ts","dependencies":[{"issue_id":"pg-sourcerer-uk0a","depends_on_id":"pg-sourcerer-f4ha","type":"parent-child","created_at":"2026-01-08T12:21:32.729957731-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-uk0a","depends_on_id":"pg-sourcerer-huxy","type":"blocks","created_at":"2026-01-08T12:21:32.994989114-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-v2b","title":"Add permission tests to ir-builder.test.ts","description":"Add tests verifying permissions are correctly populated in the IR.\n\n**Test cases:**\n\n1. **Entity has permissions object:**\n```typescript\nit.effect(\"entities have permissions\", () =\u003e\n  Effect.gen(function* () {\n    const ir = yield* buildTestIR\n    const user = ir.entities.get(\"User\")\n    expect(user?.permissions).toBeDefined()\n    expect(user?.permissions.canSelect).toBe(true) // visitor role should have select\n  })\n)\n```\n\n2. **Field has permissions object:**\n```typescript\nit.effect(\"fields have permissions\", () =\u003e\n  Effect.gen(function* () {\n    const ir = yield* buildTestIR\n    const user = ir.entities.get(\"User\")\n    const idField = user?.shapes.row.fields.find(f =\u003e f.name === \"id\")\n    expect(idField?.permissions).toBeDefined()\n    expect(idField?.permissions.canSelect).toBe(true)\n  })\n)\n```\n\n3. **Views have permissions:**\n```typescript\nit.effect(\"views have permissions\", () =\u003e\n  Effect.gen(function* () {\n    const ir = yield* buildTestIR\n    // Find a view entity and check permissions\n  })\n)\n```\n\n4. **Permissions reflect role's actual access:**\n- The fixture uses `visitor` role\n- Verify permissions match what that role can actually do\n\n**Note:** May need to examine the fixture to understand what permissions `visitor` has","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T13:06:08.013308028-06:00","updated_at":"2026-01-06T13:17:23.095057631-06:00","closed_at":"2026-01-06T13:17:23.095057631-06:00","close_reason":"Added 4 permission tests: entities have permissions, fields have permissions, views have permissions, permissions are consistent across shapes","labels":["ir","phase-2","rewrite","testing"],"dependencies":[{"issue_id":"pg-sourcerer-v2b","depends_on_id":"pg-sourcerer-svm","type":"blocks","created_at":"2026-01-06T13:06:14.725055007-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-v2b","depends_on_id":"pg-sourcerer-hbl","type":"parent-child","created_at":"2026-01-06T13:06:19.709691397-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-v3v","title":"Update remaining code and tests for unified Entity","description":"Fix any remaining references to ir.enums, EnumDef, entity.tableName. Update test fixtures and assertions. Ensure all tests pass.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T14:23:19.851975748-06:00","updated_at":"2026-01-07T14:47:13.918163941-06:00","closed_at":"2026-01-07T14:47:13.918163941-06:00","close_reason":"Updated all remaining code and tests for unified Entity type. Fixed generate.ts, zod.ts, query.ts, and all test files to use getEnumEntities/getTableEntities/isTableEntity. Renamed tableName to pgName in FileNameContext.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-v3v","depends_on_id":"pg-sourcerer-i2n","type":"blocks","created_at":"2026-01-07T14:23:26.487109881-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-v3v","depends_on_id":"pg-sourcerer-c5g","type":"blocks","created_at":"2026-01-07T14:23:27.341584191-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-v3v","depends_on_id":"pg-sourcerer-37k","type":"blocks","created_at":"2026-01-07T14:23:28.256055402-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-vcg","title":"Refactor TypeHintRegistry.getHint() to return Option\u003cT\u003e","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T19:09:24.693491359-06:00","updated_at":"2026-01-07T21:24:31.146380978-06:00","closed_at":"2026-01-07T21:24:31.146380978-06:00","close_reason":"Changed getHint to return Option\u003cT\u003e instead of T | undefined. Updated interface, implementations, and tests."}
{"id":"pg-sourcerer-vl1","title":"ir-builder: Refactor entity assembly for loops to single forEach","description":"Refactor 5 sequential for loops (entities, enums, domains, composites, functions) to single Array.forEach or flatMap pattern","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:06:20.852934815-06:00","updated_at":"2026-01-07T20:06:59.677930789-06:00","closed_at":"2026-01-07T20:06:59.677930789-06:00","close_reason":"Refactored entity assembly: 5 sequential for loops → single Array.forEach over combined array"}
{"id":"pg-sourcerer-vre","title":"Generated type files have empty interfaces despite IR having fields","description":"Generated TypeScript files contain empty interfaces (e.g., `export interface Post {}`) even though the IR correctly has 8 fields for the Post entity.\n\n**Observed behavior:**\n```typescript\n// generated/types/Post.ts\nexport interface Post {}\n```\n\n**Expected:**\n```typescript\nexport interface PostRow {\n  id: string;\n  userId: string;\n  body: string;\n  // ... all 8 fields\n}\n```\n\n**Debugging done:**\n1. IR has correct fields: `post.shapes.row.fields.length === 8` ✓\n2. Manual AST generation works: `conjure.symbolProgram()` produces correct code ✓\n3. Types plugin unit tests pass ✓\n4. Bug exists even WITHOUT the permission filtering changes (tested with git stash)\n\n**This is a pre-existing bug**, not caused by permission work.","design":"**Investigation needed:**\n\nThe disconnect is somewhere between:\n1. Plugin generating statements → FileBuilder.ast() → Emissions → FileWriter\n\nPossible causes:\n- State not being passed correctly between plugin runs\n- Emissions being overwritten or cleared\n- FileBuilder state issue\n- Recast serialization issue\n\n**Files to investigate:**\n- `src/services/file-builder.ts` - how .ast() accumulates statements\n- `src/services/emissions.ts` - how emitAst stores/retrieves\n- `src/generate.ts` - orchestration between IR build and plugin runs\n- Plugin integration tests vs unit tests (unit tests mock emissions)","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-07T23:53:17.108373783-06:00","updated_at":"2026-01-08T08:30:18.827421258-06:00","closed_at":"2026-01-08T08:30:18.827421258-06:00","close_reason":"Fixed - interfaces now generate with all fields correctly","labels":["blocker","core","plugins"]}
{"id":"pg-sourcerer-vswe","title":"Add composite type generation to arktype.ts","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-08T15:15:17.008208713-06:00","created_by":"dan","updated_at":"2026-01-08T15:18:24.400456202-06:00","closed_at":"2026-01-08T15:18:24.400456202-06:00","close_reason":"Implemented composite generation in arktype.ts with tests","dependencies":[{"issue_id":"pg-sourcerer-vswe","depends_on_id":"pg-sourcerer-ki23","type":"parent-child","created_at":"2026-01-08T15:15:22.277912053-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-vvw","title":"Create IR service for plugin access to SemanticIR","description":"Create an `IR` service (Context.Tag) that provides read-only access to the SemanticIR.\n\nThis replaces `ctx.ir` in the current PluginContext. Plugins will `yield* IR` to get the IR.\n\n```typescript\nexport class IR extends Context.Tag(\"IR\")\u003cIR, SemanticIR\u003e() {}\n\n// In plugin:\nconst ir = yield* IR\nfor (const entity of ir.entities.values()) { ... }\n```\n\nLayer created per-run by PluginRunner after IR is built.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T11:27:43.964935613-06:00","updated_at":"2026-01-06T11:33:04.478330309-06:00","closed_at":"2026-01-06T11:33:04.478330309-06:00","close_reason":"Created IR service as Context.Tag in src/services/ir.ts. Simple value service providing SemanticIR to plugins. Layer created per-run with Layer.succeed(IR, builtIR).","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-vvw","depends_on_id":"pg-sourcerer-ilk","type":"blocks","created_at":"2026-01-06T11:27:43.978584356-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-vzzm","title":"Handle existing config file in init command","description":"If pgsourcerer.config.ts exists, prompt for confirmation before overwriting. Parse existing config to pre-fill prompts with current values where possible (nice-to-have).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T12:21:18.478147922-06:00","created_by":"dan","updated_at":"2026-01-08T12:25:41.744060544-06:00","closed_at":"2026-01-08T12:25:41.744060544-06:00","close_reason":"Implemented as part of init.ts","dependencies":[{"issue_id":"pg-sourcerer-vzzm","depends_on_id":"pg-sourcerer-f4ha","type":"parent-child","created_at":"2026-01-08T12:21:32.816529984-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-vzzm","depends_on_id":"pg-sourcerer-huxy","type":"blocks","created_at":"2026-01-08T12:21:33.080019825-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-w1i","title":"Update PluginRunner to provide layers","description":"Refactor PluginRunner to provide Effect layers instead of creating a PluginContext object.\n\nCurrent flow:\n```typescript\nconst ctx = createPluginContext({ ir, inflection, symbols, ... })\nreturn plugin.run(ctx, config)\n```\n\nNew flow:\n```typescript\n// Create layers for this run\nconst irLayer = Layer.succeed(IR, ir)\nconst artifactLayer = Layer.succeed(ArtifactStoreSvc, artifactStore)\n// ... etc\n\n// For each plugin, create plugin-specific layer\nconst pluginMetaLayer = Layer.succeed(PluginMetaSvc, { name: plugin.name })\n\n// Run plugin with all layers provided\nreturn plugin.run(config).pipe(\n  Effect.provide(irLayer),\n  Effect.provide(pluginMetaLayer),\n  Effect.provide(runLayers),  // Combined layers for run\n)\n```\n\nKey changes:\n- Remove createPluginContext calls\n- Build Layer composition for each run\n- Per-plugin layers for PluginMeta\n- All other services are shared across plugins in a run","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T11:28:26.053777297-06:00","updated_at":"2026-01-06T11:47:32.606056221-06:00","closed_at":"2026-01-06T11:47:32.606056221-06:00","close_reason":"Refactored PluginRunner to use Effect layers instead of PluginContext object. Key changes:\n- Deleted duplicate type definitions (Plugin, PluginInflection, ConfiguredPlugin) from plugin-runner.ts - now imported from plugin.ts\n- Updated run() method to create layers for all services (IR, Inflection, Emissions, Symbols, TypeHints, ArtifactStore)\n- Per-plugin PluginMeta layer created for each plugin execution\n- Plugins now run via plugin.run(config).pipe(Effect.provide(allLayers))\n- Fixed ArtifactStore to use Context.Tag + factory function instead of Effect.Service\n- Updated definePlugin to catch sync errors with Effect.try\n- Updated tests to use new SimplePluginContext API\nAll 133 tests pass.","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-w1i","depends_on_id":"pg-sourcerer-dpp","type":"blocks","created_at":"2026-01-06T11:28:26.070919227-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-w1i","depends_on_id":"pg-sourcerer-187","type":"blocks","created_at":"2026-01-06T11:28:26.077665444-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-wj8","title":"symbols: Refactor validate/getAll nested for loops to flatMap","description":"Refactor validate() and getAll() nested for loops to use Array.flatMap pattern","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T20:04:08.168533907-06:00","updated_at":"2026-01-07T20:06:02.981795876-06:00","closed_at":"2026-01-07T20:06:02.981795876-06:00","close_reason":"Refactored validate/getAll: nested for loops → Arr.fromIterable + Arr.flatten + Arr.reduce + Arr.filterMap + Arr.flatMap"}
{"id":"pg-sourcerer-xwn","title":"Add unit tests for composeInflection()","description":"Add unit tests for the composeInflection() function in inflection.ts (lines 440-516, currently uncovered).\n\nTest cases:\n- Plugin defaults compose with user config (plugin runs first, user refines)\n- Smart tags still take precedence over composed transforms\n- Empty/undefined configs handled correctly\n- All transform types: entityName, fieldName, enumName, enumValue, shapeSuffix, relationName","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-07T12:42:00.506154501-06:00","updated_at":"2026-01-07T13:27:30.840125075-06:00","closed_at":"2026-01-07T13:27:30.840125075-06:00","close_reason":"Added 21 unit tests for composeInflection() covering all transform types (entityName, fieldName, enumName, enumValue, shapeSuffix, relationName), smart tag precedence, primitive transform preservation, and multi-transform composition. One test documents bug pg-sourcerer-boq (double-cleaning in relationName).","dependencies":[{"issue_id":"pg-sourcerer-xwn","depends_on_id":"pg-sourcerer-pj1","type":"parent-child","created_at":"2026-01-07T12:42:52.509078175-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-y71","title":"Remove old PluginContext interface","description":"Remove the old PluginContext interface and related code:\n\n- `interface PluginContext` in plugin-context.ts\n- `interface PluginContextDeps`\n- `createPluginContext()` function\n- `class PluginCtx extends Context.Tag` (replaced by individual services)\n\nKeep the file if needed for other exports, or delete entirely if empty.\n\nAlso remove any test utilities like `createStubPluginContext` - tests should use Effect layers instead.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T11:28:30.761883805-06:00","updated_at":"2026-01-06T12:24:48.386679225-06:00","closed_at":"2026-01-06T12:24:48.386679225-06:00","close_reason":"Deleted plugin-context.ts and removed exports from index.ts. Old PluginContext/PluginCtx/createPluginContext were unused - replaced by SimplePluginContext in plugin.ts and individual services (IR, ArtifactStore, PluginMeta, etc.).","labels":["rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-y71","depends_on_id":"pg-sourcerer-ilk","type":"blocks","created_at":"2026-01-06T11:28:30.777221652-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-y9v","title":"Add tests for query plugin core (index lookups)","description":"Test-first development for the query plugin core functionality.\n\n## Test Cases\n\n### SQL Generation\n- Primary key lookup generates correct SELECT with WHERE id = $1\n- Unique index lookup generates correct parameterized SQL\n- Non-unique index lookup returns array type\n- Composite key lookup has multiple parameters ($1, $2)\n- Schema-qualified table names in SQL\n\n### Function Naming\n- `getUserById` from users table + id PK\n- `getUserByUsername` from unique username index\n- `getPostsByUserId` from non-unique user_id index\n- `getVoteByPostIdAndUserId` from composite index\n\n### Type Imports\n- Row type imported from types plugin\n- Import path correctly resolved\n\n### Edge Cases\n- Skip expression-only indexes\n- Skip partial indexes (for now)\n- Handle tables with only PK (no other indexes)\n- Composite primary key\n\n### Integration (against example DB)\n- Generated queries actually execute\n- Return correct types\n- null returned for missing rows (unique)\n- Empty array for missing rows (non-unique)","notes":"Tests complete for single-column indexes. Remaining work:\n- Composite key lookup tests (currently skipped in implementation)\n- Integration tests against example DB (execute generated queries)\n- Tables with only PK edge case\nThese can be separate follow-up tasks.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T11:44:18.510870321-06:00","updated_at":"2026-01-07T20:28:05.534335205-06:00","closed_at":"2026-01-07T20:28:05.534335205-06:00","close_reason":"Core unit tests complete: 17 tests covering SQL generation, function naming, return types, imports, and edge cases. Composite indexes and integration tests deferred.","dependencies":[{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-t1b","type":"blocks","created_at":"2026-01-07T11:44:29.659794863-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-102","type":"blocks","created_at":"2026-01-07T16:11:31.076062626-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-yoy","type":"blocks","created_at":"2026-01-07T16:11:31.211727938-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-dkt","type":"blocks","created_at":"2026-01-07T16:11:31.332943359-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-ccd","type":"blocks","created_at":"2026-01-07T16:11:31.456183162-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-3d9","type":"blocks","created_at":"2026-01-07T16:11:31.571637188-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-y9v","depends_on_id":"pg-sourcerer-im0","type":"blocks","created_at":"2026-01-07T16:34:37.116964029-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-ylu","title":"Create generate() orchestration function","description":"Create a composable generate() Effect that threads together:\n- Config loading\n- DB introspection\n- IR building\n- Plugin execution\n- File writing\n\nThis is the core pipeline that CLI and programmatic use share.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T15:06:25.534424801-06:00","updated_at":"2026-01-06T15:12:37.438078679-06:00","closed_at":"2026-01-06T15:12:37.438078679-06:00","close_reason":"Created src/generate.ts with generate() and runGenerate() functions that orchestrate the full pipeline: config → introspect → IR → plugins → write files","labels":["cli","rewrite"]}
{"id":"pg-sourcerer-ymtj","title":"kysely-queries: Generate search methods for GIN/GiST indexes","description":"Generate search/lookup methods for GIN and GiST indexes.\n\n## GIN trigram indexes (pg_trgm)\nFor indexes like `CREATE INDEX ... USING gin(column gin_trgm_ops)`:\n- Generate `searchByColumn(db, query, limit)` method\n- Use ILIKE, similarity(), or % operator\n- Handle query escaping for special characters\n- Return multiple results\n\n## GiST indexes\n- Geometric/spatial queries if applicable\n- Range type queries\n\n## Design considerations\n- How to detect pg_trgm vs other GIN index types\n- Which operator to use (ILIKE vs similarity threshold)\n- Whether to expose similarity score in results\n- Escaping user input for LIKE patterns","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-08T17:40:08.864024289-06:00","created_by":"dan","updated_at":"2026-01-08T17:40:16.334556996-06:00"}
{"id":"pg-sourcerer-yoy","title":"sql-queries: Duplicate function generation for same index","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-07T16:11:22.032030321-06:00","updated_at":"2026-01-07T20:27:34.147543469-06:00","closed_at":"2026-01-07T20:27:34.147543469-06:00","close_reason":"Already implemented: Test 'no duplicate functions for same column' passes - seenNames Set prevents duplicates"}
{"id":"pg-sourcerer-z1t","title":"Implement Generated field detection","description":"Detect and handle database-generated fields.\n\nRules:\n- isGenerated: true OR isIdentity: true → Model.Generated(schema)\n- hasDefault: true AND !isGenerated AND !isIdentity AND !nullable → Model.Field with S.optional on insert\n- nullable: true → S.NullOr(schema)\n\nModel.Generated excludes field from insert variant.\nS.optional on insert allows omitting (DB uses DEFAULT).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T22:12:22.140458428-06:00","updated_at":"2026-01-06T22:23:32.723184081-06:00","closed_at":"2026-01-06T22:23:32.723184081-06:00","close_reason":"Implemented in effect-model.ts plugin with 22 passing tests","labels":["effect-model"]}
{"id":"pg-sourcerer-z3r","title":"sql-queries: Add stored function wrappers (queries/mutations)","description":"## Overview\n\nExtend the existing `sql-queries.ts` plugin to generate typed wrapper functions for PostgreSQL stored functions, separating queries (STABLE/IMMUTABLE) from mutations (VOLATILE).\n\nInspired by PostGraphile's custom queries and custom mutations:\n- https://postgraphile.org/postgraphile/next/custom-queries\n- https://postgraphile.org/postgraphile/next/custom-mutations\n\n## Classification Logic (at generation time)\n\n```ts\ntype FunctionRole = \"query\" | \"mutation\" | \"computed-column\" | \"skip\"\n\nfunction classifyFunction(fn: FunctionEntity, ir: SemanticIR): FunctionRole {\n  // Skip: trigger functions\n  if (fn.returnTypeName === \"trigger\") return \"skip\"\n  \n  // Skip: void returns\n  if (fn.returnTypeName === \"void\") return \"skip\"\n  \n  // Skip: computed columns (first arg is table type)\n  if (isComputedColumn(fn, ir)) return \"computed-column\"\n  \n  // Mutation: volatile functions\n  if (fn.volatility === \"volatile\") return \"mutation\"\n  \n  // Query: stable/immutable non-computed functions\n  return \"query\"\n}\n\nfunction isComputedColumn(fn: FunctionEntity, ir: SemanticIR): boolean {\n  const firstArg = fn.args[0]\n  if (!firstArg) return false\n  \n  // Check if first arg type matches a table/view entity\n  return [...ir.entities.values()].some(\n    e =\u003e (e.kind === \"table\" || e.kind === \"view\") \n      \u0026\u0026 matchesTypeName(e, firstArg.typeName)\n  )\n}\n```\n\n## Return Type Resolution\n\nOnly generate functions where we can resolve the return type:\n\n| Return Type | Detection Method | Generated TS Type |\n|-------------|-----------------|-------------------|\n| Table/View row | `returnTypeName` matches TableEntity | `{Entity}Row` |\n| Enum | `returnTypeName` matches EnumEntity | `{Enum}` |\n| Composite | `returnTypeName` matches CompositeEntity | `{Composite}` (needs types plugin support) |\n| Scalar | Known pg type name → TsType mapping | `string`, `number`, etc. |\n| **Skip** | `void`, `trigger`, `record`, unknown | Don't generate |\n\nFor `SETOF` returns, wrap in array: `{Type}[]`\n\n## Implementation Approach\n\nExtend `sql-queries.ts` with new generation functions:\n- `generateStoredFunctions(ctx)` - main entry point\n- `classifyFunction(fn, ir)` - determine query/mutation/skip\n- `generateQueryFunction(fn, ctx)` - generate query wrapper\n- `generateMutationFunction(fn, ctx)` - generate mutation wrapper\n\nOutput files:\n- `{outputDir}/functions/queries.ts` - all query functions  \n- `{outputDir}/functions/mutations.ts` - all mutation functions\n\n## Configuration Additions\n\nAdd to existing `SqlQueriesPluginConfig`:\n```ts\n/** Whether to generate stored function wrappers (default: true) */\nstoredFunctions: S.optionalWith(S.Boolean, { default: () =\u003e true }),\n\n/** Whether to generate query functions (default: true) */\nqueries: S.optionalWith(S.Boolean, { default: () =\u003e true }),\n\n/** Whether to generate mutation functions (default: true) */  \nmutations: S.optionalWith(S.Boolean, { default: () =\u003e true }),\n```\n\n## Capability Additions\n\nExtend provides:\n```ts\nprovides: [\"queries\", \"queries:sql\", \"queries:functions\", \"mutations:functions\"]\n```\n\n## Outstanding Decisions\n\n1. **Composite types**: Should we:\n   - A) Skip functions returning composites until types plugin supports them\n   - B) Block on adding composite support to types plugin first\n   - C) Generate inline types for composite returns in the functions file\n\n## Example Functions from DB\n\n| Function | First Arg | Volatility | Classification |\n|----------|-----------|------------|----------------|\n| `current_session_id()` | none | stable | **query** |\n| `current_user_id()` | none | stable | **query** |\n| `username_search(text, enum)` | text | stable | **query** |\n| `posts_short_body(posts)` | table type | stable | **computed column** (skip) |\n| `posts_with_tags(text[])` | array | stable | **query** |\n| `search_tags(text)` | text | stable | **query** |\n\n## Files to Modify\n\n- **Modify**: `packages/pg-sourcerer/src/plugins/sql-queries.ts`\n- **Modify**: `packages/pg-sourcerer/src/__tests__/sql-queries.test.ts`","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-07T22:01:59.889769754-06:00","updated_at":"2026-01-08T15:11:11.716378531-06:00","external_ref":"https://github.com/DanielFGray/pg-sourcerer/issues/14","dependencies":[{"issue_id":"pg-sourcerer-z3r","depends_on_id":"pg-sourcerer-9k7","type":"blocks","created_at":"2026-01-07T22:04:34.814611167-06:00","created_by":"dan"},{"issue_id":"pg-sourcerer-z3r","depends_on_id":"pg-sourcerer-ki23","type":"blocks","created_at":"2026-01-08T15:11:10.855546176-06:00","created_by":"dan"}]}
{"id":"pg-sourcerer-zbb","title":"Smart Tags Parser","description":"Parse JSON smart tags from PostgreSQL COMMENT ON statements.\n\nFormat: `{\"sourcerer\": {...}}` embedded in pg_description comments.\n\nBehavior:\n- Valid JSON with `sourcerer` key → extract and validate against SmartTags schema\n- Valid JSON without `sourcerer` key → no tags (other tools may use their own namespaces)\n- Malformed JSON → TagParseError (fail fast, consider repairjson fixer later)\n- Schema validation failure → TagParseError\n- Empty/no comment → no tags\n\nSee ARCHITECTURE.md \"Smart Tags\" section for full spec.","design":"## Smart Tags Parser - Implementation Plan\n\n### Goal\nParse JSON smart tags from PostgreSQL `COMMENT ON` statements, extracting the `sourcerer` namespace.\n\n### Input/Output\n- **Input**: A comment string from `pg_description`\n- **Output**: `SmartTags` object (validated against the Effect Schema) + optional description text\n\n### Comment Format\n\nValid formats (JSON must be at start, description after newline):\n\n```\n{\"sourcerer\": {...}}\n```\n\n```\n{\"sourcerer\": {...}}\ndescription text here\n```\n\n```\n{\"sourcerer\": {...}}\nline 1\nline 2\n```\n\n**Invalid**: JSON anywhere else, multiple JSON objects, JSON on same line as text after.\n\n### Parsing Behavior\n\n| Scenario | Behavior |\n|----------|----------|\n| Comment starts with `{` | Parse as JSON, extract sourcerer, rest after newline is description |\n| Valid JSON with `sourcerer` key | Extract and validate against SmartTags schema |\n| Valid JSON without `sourcerer` key | No tags (other tools' namespace), rest is description |\n| **Malformed JSON** | **Error (TagParseError)** |\n| Invalid `sourcerer` value (fails schema) | **Error (TagParseError)** |\n| Comment doesn't start with `{` | No tags, entire comment is description |\n| Empty/null comment | No tags, no description |\n\n### Parsing Algorithm\n\n```\n1. If comment is null/empty → return { tags: {}, description: undefined }\n2. Trim leading whitespace\n3. If doesn't start with `{` → return { tags: {}, description: comment }\n4. Find the end of JSON object (first newline after balanced braces, or end of string)\n5. Parse JSON substring with JSON.parse (or Effect equivalent)\n   - On failure → TagParseError\n6. If no `sourcerer` key → return { tags: {}, description: rest after newline }\n7. Validate sourcerer value against SmartTags schema\n   - On failure → TagParseError\n8. Return { tags: sourcerer value, description: rest after newline or undefined }\n```\n\n### API Design\n\n```typescript\ninterface ParsedComment {\n  readonly tags: SmartTags\n  readonly description: string | undefined\n}\n\ntype TagContext = {\n  readonly objectType: \"table\" | \"column\" | \"constraint\" | \"type\"\n  readonly objectName: string\n}\n\nfunction parseSmartTags(\n  comment: string | null | undefined,\n  context: TagContext\n): Effect.Effect\u003cParsedComment, TagParseError\u003e\n```\n\n### Test Cases\n\n**Happy path:**\n- `{\"sourcerer\": {\"name\": \"Foo\"}}` → tags with name, no description\n- `{\"sourcerer\": {\"name\": \"Foo\"}}\\nSome description` → tags + description\n- `{\"sourcerer\": {\"name\": \"Foo\"}}\\nLine 1\\nLine 2` → tags + multiline description\n- `{\"sourcerer\": {\"omit\": true}}` → tags with omit boolean\n- `{\"sourcerer\": {\"omit\": [\"insert\", \"update\"]}}` → tags with omit array\n- `{\"sourcerer\": {\"deprecated\": \"Use other field\"}}` → deprecated with message\n- `{\"sourcerer\": {\"custom\": \"extension\"}}` → extension keys allowed\n\n**No tags (valid):**\n- `null` → empty tags, no description\n- `\"\"` → empty tags, no description\n- `\"Just a description\"` → empty tags, description is the text\n- `{\"other_tool\": {...}}` → empty tags (no sourcerer key), no description\n- `{\"other_tool\": {...}}\\nDescription` → empty tags, description extracted\n\n**Errors:**\n- `{\"sourcerer\": {\"omit\": \"invalid\"}}` → TagParseError (schema validation)\n- `{malformed json}` → TagParseError\n- `{\"sourcerer\": {}` → TagParseError (unclosed brace)\n\n### Implementation\n\n1. Create `src/services/smart-tags-parser.ts`\n2. Tests in `src/__tests__/smart-tags-parser.test.ts`\n3. Export from `src/index.ts`\n\n### Future\n\n- `repairjson` integration for auto-fix suggestions in error messages","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T17:22:44.771111608-06:00","updated_at":"2026-01-05T20:16:55.19479283-06:00","closed_at":"2026-01-05T20:16:55.19479283-06:00","close_reason":"Implemented Smart Tags Parser. Parses JSON from PostgreSQL COMMENT ON statements with format: JSON at start, optional description after newline. Validates against SmartTags Effect Schema. Errors on malformed JSON or invalid schema. 25 tests covering valid formats, no-tags cases, and error cases.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-zbb","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:22:44.773318535-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-zgf","title":"Plugin Runner: Return Emissions and Symbols from run()","description":"The plugin runner's run() method currently returns Effect\u003cvoid\u003e, but after execution:\n- The emissions buffer is a local variable (lost)\n- The symbol registry is a local variable (lost)\n- There's no way to validate or retrieve outputs\n\nChange run() to return a result object:\n```typescript\ninterface RunResult {\n  readonly emissions: EmissionBuffer\n  readonly symbols: SymbolRegistry\n  readonly artifacts: ReadonlyMap\u003cCapabilityKey, Artifact\u003e\n}\n```\n\nOr alternatively, have run() accept these as parameters so the caller owns them.\n\nThis is blocking the integration test and file writing.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-05T21:45:16.981419772-06:00","updated_at":"2026-01-05T21:53:01.248412437-06:00","closed_at":"2026-01-05T21:53:01.248412437-06:00","close_reason":"Implemented RunResult return type for run() method. Now returns emissions buffer, symbol registry, and artifacts map. Fixed emissions conflict detection bug. Added 5 comprehensive tests.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-zn7","title":"Refactor zod plugin to use Conjure DSL","description":"Replace raw recast builder calls with conjure DSL in the zod plugin. Should simplify code and remove need for local cast helpers.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T15:32:40.100030587-06:00","updated_at":"2026-01-06T15:37:36.420795723-06:00","closed_at":"2026-01-06T15:37:36.420795723-06:00","close_reason":"Refactored zod.ts to use conjure DSL. Replaced raw recast builders with conjure.id().method(), conjure.obj(), conjure.ts.*, etc. Removed local cast helpers, now imports from conjure. All 355 tests pass.","labels":["conjure","rewrite"]}
