{"id":"pg-sourcerer-0un","title":"Fix packages/lib/prompt.ts and packages/example/scripts lint errors","description":"ESLint errors in example scripts (dbEnsure.ts, dbSetup.ts, generateEnvFile.ts) and lib/prompt.ts. These are copied from another Effect project and need cleanup. Issues include: recursive confirm() bug, missing Bun global types, npm-run-all missing types, various unsafe access patterns.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-06T10:58:42.216483865-06:00","updated_at":"2026-01-06T10:58:42.216483865-06:00","labels":["example"]}
{"id":"pg-sourcerer-1n1","title":"Add Unit Tests for Emissions Buffer","description":"EmissionBuffer has no dedicated tests. Should test:\n\n- `emit()` - basic file emission\n- `emit()` - same file, same plugin (overwrites)\n- `emit()` - same file, different plugin (conflict on validate)\n- `appendEmit()` - appends to existing\n- `appendEmit()` - different plugin tries to append (error)\n- `validate()` - returns clean for no conflicts\n- `validate()` - fails with EmitConflict for conflicts\n- `clear()` - empties the buffer\n- `getAll()` - returns all entries","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-05T21:45:59.773722614-06:00","updated_at":"2026-01-05T21:45:59.773722614-06:00","labels":["core","rewrite","testing"]}
{"id":"pg-sourcerer-2nj","title":"Config Loader Service","description":"Load and validate pgsourcerer.config.ts:\n\n- Config file discovery (CLI flag, then pgsourcerer.config.{ts,js,mjs})\n- Parse with Effect Schema\n- Validate plugin configs individually\n- Resolve environment variables\n\nResearch needed: Effect.Config vs lilconfig vs Bun native import.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:25.921417722-06:00","updated_at":"2026-01-05T21:40:26.237083116-06:00","closed_at":"2026-01-05T21:40:26.237083116-06:00","close_reason":"Config Loader Service complete: lilconfig integration with Effect wrapper, Schema validation, proper error handling. Also created introspection fixture from example database for future testing.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-2nj","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:25.922938443-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-2pv","title":"Call emissions.validate() After Plugin Execution","description":"`EmissionBuffer.validate()` exists to detect conflicts (same file emitted by different plugins), but nothing ever calls it:\n\n```typescript\n// emissions.ts - validate() defined\nreadonly validate: () =\u003e Effect.Effect\u003cvoid, EmitConflict\u003e\n\n// plugin-runner.ts - never called!\n```\n\nAfter all plugins execute, should call `emissions.validate()` to catch conflicts before writing files.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:47.572794008-06:00","updated_at":"2026-01-06T10:09:41.33706227-06:00","closed_at":"2026-01-06T10:09:41.33706227-06:00","close_reason":"run() now automatically validates emissions and symbols after plugin execution. Fails with EmitConflict or SymbolConflict errors.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-2r3","title":"File Writer Service","description":"Write buffered emissions to disk:\n\n- Take EmissionBuffer contents after all plugins complete\n- Add generated file header with timestamp\n- Create directories as needed\n- Write files (overwrite existing)\n- Support dry-run mode (show what would be written)\n\nUses @effect/platform FileSystem service.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:20.082752601-06:00","updated_at":"2026-01-05T20:00:07.060720919-06:00","closed_at":"2026-01-05T20:00:07.060720919-06:00","close_reason":"Implemented FileWriter service using @effect/platform FileSystem. Features: writes emissions to disk with auto-generated header, creates directories recursively, supports dry-run mode, parallel file writes with configurable concurrency. Full test coverage with real filesystem operations.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-2r3","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:20.084147028-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-3pg","title":"Fix generated file imports: @sorcery/db path not resolving","description":"ESLint shows ~185 errors in packages/example/generated/ - all are 'unsafe' errors because the import from @sorcery/db is not resolving correctly. The generator is emitting incorrect import paths.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-06T10:31:44.957198415-06:00","updated_at":"2026-01-06T10:31:44.957198415-06:00","labels":["rewrite"]}
{"id":"pg-sourcerer-72u","title":"Inflection Service Implementation","description":"Implement CoreInflection service with naming transformations:\n- camelCase, pascalCase\n- pluralize, singularize\n- safeIdentifier (handle reserved words)\n- entityName, shapeName, fieldName\n- enumName, enumValueName\n- relationName\n\nCurrently stubbed - all methods throw \"not implemented\".","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:22:56.727789317-06:00","updated_at":"2026-01-05T19:50:38.846239791-06:00","closed_at":"2026-01-05T19:50:38.846239791-06:00","close_reason":"Implemented all CoreInflection methods: camelCase/pascalCase via Effect String module, naive pluralize/singularize, safeIdentifier with reserved words, entityName/shapeName/fieldName/enumName/enumValueName/relationName with tag overrides.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-72u","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:22:56.729599696-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-7zk","title":"Plugin Runner: Use Live Inflection Instead of Stub","description":"The plugin runner currently passes `InflectionStub` to plugin contexts:\n\n```typescript\n// plugin-runner.ts line 258\ninflection: InflectionStub,  // Throws \"not implemented\"!\n```\n\nIf any plugin calls `ctx.inflection.camelCase()` etc., it will crash.\n\nFix: Accept inflection as a parameter to `run()` or use `InflectionLive` by default.","status":"closed","issue_type":"task","created_at":"2026-01-05T21:45:43.271405572-06:00","updated_at":"2026-01-05T21:46:27.542337867-06:00","closed_at":"2026-01-05T21:46:27.542337867-06:00","close_reason":"Duplicate of pg-sourcerer-j42","labels":["core","rewrite"]}
{"id":"pg-sourcerer-85g","title":"IR Builder Service","description":"Build SemanticIR from pg-introspection output.\n\nTransforms raw introspection into:\n- Entities (tables, views, composites)\n- Shapes (row, insert, update, patch)\n- Fields with semantic properties\n- Relations from foreign keys\n- Enums\n\nRequires smart tags parser to be complete for tag extraction.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T17:22:50.795897422-06:00","updated_at":"2026-01-05T20:40:24.023099135-06:00","closed_at":"2026-01-05T20:40:24.023099135-06:00","close_reason":"Implemented IR Builder Service with 16 integration tests against real PostgreSQL database.\n\nFeatures:\n- Transforms pg-introspection output into SemanticIR\n- Builds entities (tables, views) with proper kind detection\n- Builds all 4 shapes (row, insert, update, patch) for tables, row-only for views\n- Fields include: name (camelCase), columnName (original), nullable, optional, hasDefault, isGenerated, isIdentity, isArray, elementTypeName\n- Field optionality varies by shape: row (nullable only), insert (has default/generated/nullable), update/patch (all optional)\n- Relations from FK constraints with column mappings (supports composite FKs)\n- Primary key detection (real PKs and virtual @primaryKey tags for views)\n- Smart tags parsed from comments for all entities/fields/constraints\n- Preserves raw pg-introspection references (pgClass, pgAttribute) for plugin access\n- Tested against real example database with users, posts, views, multiple schemas","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-85g","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:22:50.797132934-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-85g","depends_on_id":"pg-sourcerer-zbb","type":"blocks","created_at":"2026-01-05T17:22:50.798032465-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-90w","title":"Plugin Runner: Use Live Inflection Instead of Stub","description":"The plugin runner currently passes `InflectionStub` to plugin contexts:\n\n```typescript\n// plugin-runner.ts line 258\ninflection: InflectionStub,  // Throws \"not implemented\"!\n```\n\nIf any plugin calls `ctx.inflection.camelCase()` etc., it will crash.\n\nFix: Accept inflection as a parameter to `run()` or use `InflectionLive` by default.","status":"closed","issue_type":"task","created_at":"2026-01-05T21:45:31.502735501-06:00","updated_at":"2026-01-05T21:46:27.533436608-06:00","closed_at":"2026-01-05T21:46:27.533436608-06:00","close_reason":"Duplicate of pg-sourcerer-j42","labels":["core","rewrite"]}
{"id":"pg-sourcerer-a06","title":"Add Unit Tests for Inflection Service","description":"The live inflection implementation exists but has no dedicated unit tests:\n\n- `camelCase` / `pascalCase` (delegates to Effect String)\n- `pluralize` / `singularize` (naive implementation)\n- `safeIdentifier` (reserved word handling)\n- `entityName` / `shapeName` / `fieldName` / `enumName`\n- `relationName` (FK constraint → relation name)\n\nAdd tests for edge cases:\n- Reserved words: `class`, `type`, `default`\n- Pluralization: `person` → `people`? (currently naive)\n- Snake case with numbers: `user_v2` → `userV2`\n- Already camelCase input","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-05T21:45:55.881766831-06:00","updated_at":"2026-01-05T21:45:55.881766831-06:00","labels":["core","rewrite","testing"]}
{"id":"pg-sourcerer-an1","title":"Plugin Runner: Implement run() and duplicate detection","description":"Complete the plugin-runner.ts implementation:\n1. Add duplicate plugin detection to prepare()\n2. Implement run() method to execute plugins with PluginContext","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T19:40:58.33664391-06:00","updated_at":"2026-01-05T19:44:50.991054105-06:00","closed_at":"2026-01-05T19:44:50.991054105-06:00","close_reason":"Implemented plugin-runner.ts: added duplicate plugin detection to prepare(), implemented run() method that executes plugins sequentially with shared artifacts/emissions/symbols. All 38 tests pass.","labels":["phase-1","rewrite"]}
{"id":"pg-sourcerer-b2n","title":"Plugin Runner Core Infrastructure","description":"Build the core plugin runner infrastructure for pg-sourcerer rewrite. This is Phase 1 of the rewrite - establishing the Effect-ts based service layer with stubs, then implementing via RED-GREEN-REFACTOR.\n\nSee ARCHITECTURE.md for full design and packages/sourcerer-rewrite/AGENTS.md for implementation notes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-05T17:22:37.781529599-06:00","updated_at":"2026-01-05T17:23:38.413587315-06:00","closed_at":"2026-01-05T17:23:38.413587315-06:00","close_reason":"Initial stubs and wiring complete. All services defined with Context.Tag, stub layers created, tests passing (9/9). See packages/sourcerer-rewrite/","labels":["phase-1","rewrite"]}
{"id":"pg-sourcerer-bk6","title":"Effect Schema Plugin","description":"Generate Effect Schema definitions for each entity's shapes.\n\nOutput example for User entity:\n```typescript\nimport { Schema as S } from \"effect\"\n\nexport class UserRow extends S.Class\u003cUserRow\u003e(\"UserRow\")({\n  id: S.UUID,\n  username: S.String,\n  name: S.NullOr(S.String),\n  createdAt: S.Date,\n}) {}\n\nexport class UserInsert extends S.Class\u003cUserInsert\u003e(\"UserInsert\")({\n  id: S.optional(S.UUID),\n  username: S.String,\n  name: S.optional(S.NullOr(S.String)),\n}) {}\n```\n\nRequirements:\n- provides: [\"schemas:effect\", \"schemas\"]\n- Generate S.Class or S.Struct for each shape\n- Map pg types to Effect Schema (uuid→S.UUID, etc.)\n- Handle nullable (S.NullOr) vs optional (S.optional)\n- Support arrays (S.Array)\n- Support enums (S.Literal union or S.Enums)\n- Respect smart tags\n- Query TypeHintRegistry for custom schemas\n- Register symbols for import resolution\n\nNote: Research the best Effect Schema patterns for this use case.","notes":"Reference existing implementation: packages/pg-sourcerer/plugins/effect-models.mjs\n\nKey patterns to port:\n- mapPgToEffect() function for type mapping\n- Uses S.Union(S.Literal(...)) for enums\n- Uses S.Struct({...}) for composites\n- Uses Model.Class\u003cT\u003e(\"T\")({...}) for tables\n- Handles arrays via S.Array()\n- Handles nullable via S.NullOr()\n- Handles generated columns via Model.Generated()\n- Cross-file imports for enum/domain references\n\nFor the rewrite:\n- Consider using S.Class vs S.Struct\n- May not need @effect/sql Model.Class pattern (configurable?)\n- Use string templates instead of AST builders\n- Update import from \"@effect/schema\" to \"effect\" (Schema is now in main effect package)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-05T21:41:30.447175078-06:00","updated_at":"2026-01-05T21:42:07.249541968-06:00","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bk6","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:30.466450499-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bsq","title":"Plugin Runner Capability Resolution","description":"Implement PluginRunner capability resolution:\n\n1. Collect all provides/requires from plugins\n2. Expand implicit provisions (schemas:zod → also provides schemas)\n3. Check for conflicts (same capability from multiple plugins)\n4. Check all requires are satisfied\n5. Topological sort (error on cycles)\n6. Execute plugins in sorted order\n\nCurrently stubbed - prepare() and run() return stub errors.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T17:23:03.184670503-06:00","updated_at":"2026-01-05T18:02:45.541040642-06:00","closed_at":"2026-01-05T18:02:45.541040642-06:00","close_reason":"Implemented plugin runner capability resolution with idiomatic Effect patterns: HashMap for providers, Effect.reduce for single-pass validation, Graph module for topo sort and cycle detection. All 8 tests pass.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bsq","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:03.186612366-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bt7","title":"Phase 2: Base Plugins","description":"Implement the first set of code generation plugins that use the Phase 1 infrastructure.\n\nPlugins to build:\n1. Types plugin - generates TypeScript interfaces for entities\n2. Effect Schema plugin - generates Effect Schema definitions + inferred types\n3. Zod plugin - generates Zod schemas + inferred types\n\nEach plugin should:\n- Declare capabilities (provides: \"types\", \"schemas:effect\", \"schemas:zod\")\n- Use PluginContext to emit files\n- Register symbols for cross-file imports\n- Respect smart tags (@omit, @name, @type)\n- Query TypeHintRegistry for user overrides\n- Handle all field types (scalars, arrays, enums, nullable)","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-05T21:41:09.54899253-06:00","updated_at":"2026-01-05T21:41:09.54899253-06:00","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-bt7","depends_on_id":"pg-sourcerer-d7s","type":"blocks","created_at":"2026-01-05T21:46:41.165089426-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-bwx","title":"Call symbols.validate() After Plugin Execution","description":"`SymbolRegistry.validate()` exists to detect collisions (same symbol name in same file from different plugins), but nothing ever calls it:\n\n```typescript\n// symbols.ts - validate() defined\nreadonly validate: () =\u003e readonly SymbolCollision[]\n\n// plugin-runner.ts - never called!\n```\n\nAfter all plugins execute, should call `symbols.validate()` and fail if collisions found.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:50.337289998-06:00","updated_at":"2026-01-06T10:09:41.347129501-06:00","closed_at":"2026-01-06T10:09:41.347129501-06:00","close_reason":"run() now automatically validates emissions and symbols after plugin execution. Fails with EmitConflict or SymbolConflict errors.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-cdb","title":"PostgreSQL to TypeScript Type Mapping Utility","description":"Create a shared utility for mapping PostgreSQL types to TypeScript types.\n\nThis is used by multiple plugins and should be extracted to avoid duplication.\n\n```typescript\ninterface PgTypeMapping {\n  // Map pg type name to TS type\n  toTypeScript(pgTypeName: string, options?: { nullable?: boolean, array?: boolean }): string\n  \n  // Map pg type to Zod schema expression\n  toZod(pgTypeName: string, options?: { nullable?: boolean, array?: boolean }): string\n  \n  // Map pg type to Effect Schema expression  \n  toEffectSchema(pgTypeName: string, options?: { nullable?: boolean, array?: boolean }): string\n}\n\n// Example mappings:\n// uuid → string / z.string().uuid() / S.UUID\n// text → string / z.string() / S.String\n// integer → number / z.number().int() / S.Int\n// boolean → boolean / z.boolean() / S.Boolean\n// timestamptz → Date / z.coerce.date() / S.Date\n// jsonb → unknown / z.unknown() / S.Unknown\n// text[] → string[] / z.array(z.string()) / S.Array(S.String)\n```\n\nRequirements:\n- Handle common pg types (text, varchar, int, bigint, uuid, boolean, date, timestamp, timestamptz, jsonb, json)\n- Handle arrays\n- Handle domains (unwrap to base type)\n- Extensible for custom types via TypeHintRegistry\n- Well-tested with comprehensive type coverage","notes":"Reference existing implementations:\n- packages/pg-sourcerer/plugins/effect-models.mjs: mapPgToEffect()\n- packages/pg-sourcerer/utils/index.mjs: getTSTypeNameFromPgType()\n\nExisting type mappings to consolidate:\n- pg_catalog.int2/int4/float4/float8/numeric → number / z.number() / S.Number\n- pg_catalog.int8 → bigint / z.bigint() / S.BigInt\n- pg_catalog.text/varchar/char → string / z.string() / S.String\n- pg_catalog.bool → boolean / z.boolean() / S.Boolean\n- pg_catalog.uuid → string / z.string().uuid() / S.UUID\n- pg_catalog.date/timestamp/timestamptz → Date / z.coerce.date() / S.Date\n- pg_catalog.json/jsonb → unknown / z.unknown() / S.Unknown\n- public.citext → string / z.string() / S.String\n\nCreate a single source of truth for type mappings that all plugins can use.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-05T21:41:39.053018429-06:00","updated_at":"2026-01-05T21:42:12.363329315-06:00","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-cdb","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:39.070837257-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-d7s","title":"Core Integration Test - Full Pipeline","description":"Write an integration test that exercises the complete core pipeline:\n\n1. Build IR from test introspection fixture\n2. Prepare plugins (capability resolution, ordering)\n3. Run plugins (they emit code, register symbols)\n4. Validate emissions (no conflicts)\n5. Validate symbols (no collisions)\n6. Write files (or dry-run)\n\nThis test will:\n- Prove the components work together\n- Force resolution of API shape questions\n- Catch missing handoffs between components\n- Serve as documentation of intended usage\n\nThe test should use a simple mock plugin that emits files, not a real plugin.\n\nCurrently blocked by: plugin runner doesn't return emissions, inflection is a stub, etc.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:11.83692399-06:00","updated_at":"2026-01-05T21:45:11.83692399-06:00","labels":["core","rewrite","testing"],"dependencies":[{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-zgf","type":"blocks","created_at":"2026-01-05T21:46:37.266281445-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-j42","type":"blocks","created_at":"2026-01-05T21:46:37.295233151-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-2pv","type":"blocks","created_at":"2026-01-05T21:46:37.321227-06:00","created_by":"daemon"},{"issue_id":"pg-sourcerer-d7s","depends_on_id":"pg-sourcerer-bwx","type":"blocks","created_at":"2026-01-05T21:46:37.345656963-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-dje","title":"Types Plugin - TypeScript Interfaces","description":"Generate TypeScript interfaces for each entity's shapes.\n\nOutput example for User entity:\n```typescript\nexport interface UserRow {\n  id: string\n  username: string\n  name: string | null\n  createdAt: Date\n}\n\nexport interface UserInsert {\n  id?: string\n  username: string\n  name?: string | null\n}\n\nexport interface UserUpdate {\n  id?: string\n  username?: string\n  name?: string | null\n}\n```\n\nRequirements:\n- Generate Row, Insert, Update, Patch shapes for tables\n- Generate only Row shape for views\n- Handle nullable vs optional correctly per shape\n- Map PostgreSQL types to TypeScript (uuid→string, timestamptz→Date, etc.)\n- Support arrays (text[]→string[])\n- Support enums (generate enum types)\n- Respect @omit tags (skip fields/entities)\n- Respect @name tags (rename)\n- Query TypeHintRegistry for custom type mappings\n- Register symbols for cross-plugin imports\n- Emit to configurable output directory","notes":"Reference existing implementation: packages/pg-sourcerer/plugins/types.mjs\n\nKey patterns to port:\n- Uses AST builders (recast) for code generation\n- Maps pg types via utils.getTSTypeNameFromPgType()\n- Handles enums as union of literal types\n- Generates type aliases with comments from descriptions\n- Supports schema/table filtering via pluginOpts\n\nFor the rewrite:\n- Use string templates instead of AST builders (simpler)\n- Use Effect Schema for plugin config validation\n- Use PluginContext.emit() instead of returning Output[]\n- Register symbols for cross-plugin imports","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-05T21:41:19.084255688-06:00","updated_at":"2026-01-05T21:41:57.711030566-06:00","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-dje","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:19.104708801-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-drn","title":"Plugin Runner: Accept TypeHints from Config","description":"TypeHints registry is hardcoded to empty:\n\n```typescript\n// plugin-runner.ts line 249\nconst typeHints = emptyTypeHintRegistry  // User config ignored!\n```\n\nThe runner should accept `TypeHint[]` from config and create a real registry via `createTypeHintRegistry(hints)`.\n\nThis allows users to configure type overrides as designed in ARCHITECTURE.md.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:39.02615082-06:00","updated_at":"2026-01-05T21:45:39.02615082-06:00","labels":["core","rewrite"]}
{"id":"pg-sourcerer-esj","title":"Symbol Registry Import Resolution","description":"Implement relative import path calculation in SymbolRegistry.importFor():\n\n- Calculate relative path from importer to importee\n- Add .js extension for ESM\n- Separate type imports from value imports\n- Handle same directory vs parent directory\n\nCurrent implementation is naive stub.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:14.311590952-06:00","updated_at":"2026-01-05T21:23:58.230286487-06:00","closed_at":"2026-01-05T21:23:58.230286487-06:00","close_reason":"Implemented relative import path calculation in SymbolRegistry.importFor(). Handles: same directory (./), sibling directories (../), nested paths, common parent directories, .ts to .js extension conversion. Separates type imports, named imports, and default exports. 22 tests covering all path calculation scenarios and import types.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-esj","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:14.312838243-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-j42","title":"Plugin Runner: Use Live Inflection Instead of Stub","description":"The plugin runner currently passes `InflectionStub` to plugin contexts:\n\n```typescript\n// plugin-runner.ts line 258\ninflection: InflectionStub,  // Throws \"not implemented\"!\n```\n\nIf any plugin calls `ctx.inflection.camelCase()` etc., it will crash.\n\nFix: Accept inflection as a parameter to `run()` or use `InflectionLive` by default.","status":"closed","issue_type":"task","created_at":"2026-01-05T21:46:11.896056994-06:00","updated_at":"2026-01-06T10:18:43.407644863-06:00","closed_at":"2026-01-06T10:18:43.407644863-06:00","close_reason":"Refactored PluginRunner to use Effect.Service pattern. The service now depends on Inflection via layer composition - inflection is captured at service construction time, not required from callers. Tests use createPluginRunner(liveInflection) helper for direct testing without Effect context.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-lt6","title":"Plugin Runner: Validate Plugin Configs Against Schemas","description":"Plugin configs are never validated against their declared schemas:\n\n```typescript\n// plugin-runner.ts - config passed directly without validation\nreturn plugin.run(ctx, config)  // config could be invalid!\n```\n\nShould decode config through `Schema.decode(plugin.configSchema, config)` either in `prepare()` or at the start of `run()`.\n\nThis will catch config errors early with good error messages via Effect Schema.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T21:45:35.837819626-06:00","updated_at":"2026-01-06T10:05:23.044743088-06:00","closed_at":"2026-01-06T10:05:23.044743088-06:00","close_reason":"Implemented config validation in prepare(). Plugin configs are now decoded through Schema.decodeUnknown before execution, catching invalid configs early with clear error messages using ParseResult.ArrayFormatter.","labels":["core","rewrite"]}
{"id":"pg-sourcerer-ntu","title":"Plugin Integration Test with Fixture","description":"Create integration tests that verify the full pipeline:\n1. Load introspection fixture (from example database)\n2. Build IR\n3. Run plugin(s)\n4. Assert emitted files match expected output\n\nUse the introspection fixture created in Phase 1 (src/__tests__/fixtures/).\n\nTest scenarios:\n- Types plugin generates correct interfaces for User, Post entities\n- Zod plugin generates correct schemas\n- Effect Schema plugin generates correct schemas\n- Plugins respect @omit tags\n- Plugins respect @name tags\n- TypeHintRegistry overrides are applied\n- Symbol registration works for cross-file imports\n- Enum types are generated correctly\n\nThis validates the full integration without needing a live database.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-05T21:41:44.373199941-06:00","updated_at":"2026-01-05T21:41:44.373199941-06:00","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-ntu","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:44.38766068-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-pcu","title":"Type Hint Registry Implementation","description":"Implement TypeHintRegistry matching and precedence:\n\n- Match fields against configured type hints\n- Specificity scoring: table+column \u003e table \u003e column \u003e pgType\n- Merge hints from multiple matching rules\n- Later rules override earlier (same specificity)\n\nCurrently stubbed - returns empty hints.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T17:23:08.820308639-06:00","updated_at":"2026-01-05T21:22:00.840700579-06:00","closed_at":"2026-01-05T21:22:00.840700579-06:00","close_reason":"Implemented TypeHintRegistry with matching and precedence logic. Scoring: schema=2, table=3, column=4, pgType=1. Higher scores override lower, later rules override earlier at same specificity. 23 tests covering basic matching, non-matching, precedence, merging, and complex scenarios.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-pcu","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:23:08.821918675-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-qn1","title":"Zod Plugin - Zod Schemas","description":"Generate Zod schemas for each entity's shapes.\n\nOutput example for User entity:\n```typescript\nimport { z } from \"zod\"\n\nexport const UserRow = z.object({\n  id: z.string().uuid(),\n  username: z.string(),\n  name: z.string().nullable(),\n  createdAt: z.coerce.date(),\n})\nexport type UserRow = z.infer\u003ctypeof UserRow\u003e\n\nexport const UserInsert = z.object({\n  id: z.string().uuid().optional(),\n  username: z.string(),\n  name: z.string().nullable().optional(),\n})\nexport type UserInsert = z.infer\u003ctypeof UserInsert\u003e\n```\n\nRequirements:\n- provides: [\"schemas:zod\", \"schemas\"]\n- Generate schemas for Row, Insert, Update, Patch shapes\n- Use z.infer for type exports\n- Map pg types to Zod (uuid→z.string().uuid(), etc.)\n- Handle nullable (.nullable()) vs optional (.optional())\n- Support arrays (z.array())\n- Support enums (z.enum())\n- Respect smart tags\n- Query TypeHintRegistry for custom Zod schemas\n- Register symbols for import resolution","notes":"Reference existing implementation: packages/pg-sourcerer/plugins/schemas.mjs\n\nKey patterns to port:\n- Creates z.object() with property mapping\n- Handles nullable via .nullable() chaining\n- Handles uuid via .uuid() chaining\n- Optionally exports inferred types via z.infer\n- Uses .strict() on objects\n- Imports { z } from \"zod\"\n\nFor the rewrite:\n- Use string templates instead of AST builders\n- Add support for more Zod refinements (min, max, email, etc.)\n- Handle arrays properly\n- Generate Insert/Update/Patch variants (not just Row)\n- Use PluginContext.emit() and symbol registration","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-05T21:41:24.77286389-06:00","updated_at":"2026-01-05T21:42:01.888840493-06:00","labels":["phase-2","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-qn1","depends_on_id":"pg-sourcerer-bt7","type":"blocks","created_at":"2026-01-05T21:41:24.79265166-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-zbb","title":"Smart Tags Parser","description":"Parse JSON smart tags from PostgreSQL COMMENT ON statements.\n\nFormat: `{\"sourcerer\": {...}}` embedded in pg_description comments.\n\nBehavior:\n- Valid JSON with `sourcerer` key → extract and validate against SmartTags schema\n- Valid JSON without `sourcerer` key → no tags (other tools may use their own namespaces)\n- Malformed JSON → TagParseError (fail fast, consider repairjson fixer later)\n- Schema validation failure → TagParseError\n- Empty/no comment → no tags\n\nSee ARCHITECTURE.md \"Smart Tags\" section for full spec.","design":"## Smart Tags Parser - Implementation Plan\n\n### Goal\nParse JSON smart tags from PostgreSQL `COMMENT ON` statements, extracting the `sourcerer` namespace.\n\n### Input/Output\n- **Input**: A comment string from `pg_description`\n- **Output**: `SmartTags` object (validated against the Effect Schema) + optional description text\n\n### Comment Format\n\nValid formats (JSON must be at start, description after newline):\n\n```\n{\"sourcerer\": {...}}\n```\n\n```\n{\"sourcerer\": {...}}\ndescription text here\n```\n\n```\n{\"sourcerer\": {...}}\nline 1\nline 2\n```\n\n**Invalid**: JSON anywhere else, multiple JSON objects, JSON on same line as text after.\n\n### Parsing Behavior\n\n| Scenario | Behavior |\n|----------|----------|\n| Comment starts with `{` | Parse as JSON, extract sourcerer, rest after newline is description |\n| Valid JSON with `sourcerer` key | Extract and validate against SmartTags schema |\n| Valid JSON without `sourcerer` key | No tags (other tools' namespace), rest is description |\n| **Malformed JSON** | **Error (TagParseError)** |\n| Invalid `sourcerer` value (fails schema) | **Error (TagParseError)** |\n| Comment doesn't start with `{` | No tags, entire comment is description |\n| Empty/null comment | No tags, no description |\n\n### Parsing Algorithm\n\n```\n1. If comment is null/empty → return { tags: {}, description: undefined }\n2. Trim leading whitespace\n3. If doesn't start with `{` → return { tags: {}, description: comment }\n4. Find the end of JSON object (first newline after balanced braces, or end of string)\n5. Parse JSON substring with JSON.parse (or Effect equivalent)\n   - On failure → TagParseError\n6. If no `sourcerer` key → return { tags: {}, description: rest after newline }\n7. Validate sourcerer value against SmartTags schema\n   - On failure → TagParseError\n8. Return { tags: sourcerer value, description: rest after newline or undefined }\n```\n\n### API Design\n\n```typescript\ninterface ParsedComment {\n  readonly tags: SmartTags\n  readonly description: string | undefined\n}\n\ntype TagContext = {\n  readonly objectType: \"table\" | \"column\" | \"constraint\" | \"type\"\n  readonly objectName: string\n}\n\nfunction parseSmartTags(\n  comment: string | null | undefined,\n  context: TagContext\n): Effect.Effect\u003cParsedComment, TagParseError\u003e\n```\n\n### Test Cases\n\n**Happy path:**\n- `{\"sourcerer\": {\"name\": \"Foo\"}}` → tags with name, no description\n- `{\"sourcerer\": {\"name\": \"Foo\"}}\\nSome description` → tags + description\n- `{\"sourcerer\": {\"name\": \"Foo\"}}\\nLine 1\\nLine 2` → tags + multiline description\n- `{\"sourcerer\": {\"omit\": true}}` → tags with omit boolean\n- `{\"sourcerer\": {\"omit\": [\"insert\", \"update\"]}}` → tags with omit array\n- `{\"sourcerer\": {\"deprecated\": \"Use other field\"}}` → deprecated with message\n- `{\"sourcerer\": {\"custom\": \"extension\"}}` → extension keys allowed\n\n**No tags (valid):**\n- `null` → empty tags, no description\n- `\"\"` → empty tags, no description\n- `\"Just a description\"` → empty tags, description is the text\n- `{\"other_tool\": {...}}` → empty tags (no sourcerer key), no description\n- `{\"other_tool\": {...}}\\nDescription` → empty tags, description extracted\n\n**Errors:**\n- `{\"sourcerer\": {\"omit\": \"invalid\"}}` → TagParseError (schema validation)\n- `{malformed json}` → TagParseError\n- `{\"sourcerer\": {}` → TagParseError (unclosed brace)\n\n### Implementation\n\n1. Create `src/services/smart-tags-parser.ts`\n2. Tests in `src/__tests__/smart-tags-parser.test.ts`\n3. Export from `src/index.ts`\n\n### Future\n\n- `repairjson` integration for auto-fix suggestions in error messages","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T17:22:44.771111608-06:00","updated_at":"2026-01-05T20:16:55.19479283-06:00","closed_at":"2026-01-05T20:16:55.19479283-06:00","close_reason":"Implemented Smart Tags Parser. Parses JSON from PostgreSQL COMMENT ON statements with format: JSON at start, optional description after newline. Validates against SmartTags Effect Schema. Errors on malformed JSON or invalid schema. 25 tests covering valid formats, no-tags cases, and error cases.","labels":["phase-1","rewrite"],"dependencies":[{"issue_id":"pg-sourcerer-zbb","depends_on_id":"pg-sourcerer-b2n","type":"blocks","created_at":"2026-01-05T17:22:44.773318535-06:00","created_by":"daemon"}]}
{"id":"pg-sourcerer-zgf","title":"Plugin Runner: Return Emissions and Symbols from run()","description":"The plugin runner's run() method currently returns Effect\u003cvoid\u003e, but after execution:\n- The emissions buffer is a local variable (lost)\n- The symbol registry is a local variable (lost)\n- There's no way to validate or retrieve outputs\n\nChange run() to return a result object:\n```typescript\ninterface RunResult {\n  readonly emissions: EmissionBuffer\n  readonly symbols: SymbolRegistry\n  readonly artifacts: ReadonlyMap\u003cCapabilityKey, Artifact\u003e\n}\n```\n\nOr alternatively, have run() accept these as parameters so the caller owns them.\n\nThis is blocking the integration test and file writing.","status":"closed","issue_type":"task","created_at":"2026-01-05T21:45:16.981419772-06:00","updated_at":"2026-01-05T21:53:01.248412437-06:00","closed_at":"2026-01-05T21:53:01.248412437-06:00","close_reason":"Implemented RunResult return type for run() method. Now returns emissions buffer, symbol registry, and artifacts map. Fixed emissions conflict detection bug. Added 5 comprehensive tests.","labels":["core","rewrite"]}
